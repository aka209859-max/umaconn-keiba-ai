# HQS指数実績データ収集 - 実行ガイド

**作成日**: 2026-01-08  
**対象**: CEO（ローカル環境実行用）  
**所要時間**: 約3-5時間（競馬場数・期間により変動）

---

## 📋 概要

4つの基礎指数（テン・位置・上がり・ペース）の実績データを収集し、`nar_hqs_index_stats` テーブルに保存します。

### 収集するデータ
- **単勝的中率**: 各指数値ごとの1着的中率
- **複勝的中率**: 各指数値ごとの3着以内的中率
- **補正単勝回収率**: オッズを考慮した収益性評価
- **補正複勝回収率**: オッズを考慮した収益性評価

---

## 🏇 競馬場別期間設定

| 競馬場 | コード | 期間 | 理由 |
|--------|--------|------|------|
| **大井** | 42 | 2023年10月〜2025年12月31日 | オーストラリア産白砂への全面置換 |
| **名古屋** | 47 | 2022年4月〜2025年12月31日 | 大幅改修実施 |
| **その他12競馬場** | 30, 35, 36, 43, 44, 45, 46, 48, 49, 50, 51 | 2016年1月〜2025年12月31日 | 長期データ（大幅改修なし） |

---

## 🚀 実行手順

### Step 1: データベーステーブル作成

```cmd
E:
cd \UmaData\nar-analytics-python-v2

psql -U postgres -d pckeiba -f scripts\create_hqs_index_stats_table.sql
```

**期待される出力:**
```
DROP TABLE
CREATE TABLE
CREATE INDEX
CREATE INDEX
CREATE INDEX
COMMENT
...
         message
----------------------------------
 nar_hqs_index_stats テーブル作成完了！
(1 行)
```

---

### Step 2: 実績データ収集スクリプト実行

```cmd
E:
cd \UmaData\nar-analytics-python-v2

python scripts\collect_index_stats.py
```

**実行中の出力例:**
```
================================================================================
HQS指数実績データ収集スクリプト（競馬場別期間対応版）
================================================================================

対象競馬場数: 13場

================================================================================
📊 競馬場コード: 42
   期間: 20231001 〜 20251231
   理由: オーストラリア産白砂への全面置換
================================================================================
   取得レース数: 1,234件
   処理中... 1,000/1,234 (81.0%)
   ✅ 完了: 1,234件処理

================================================================================
📊 競馬場コード: 43
   期間: 20160101 〜 20251231
   理由: 長期データ（大幅改修なし）
================================================================================
   取得レース数: 8,567件
   処理中... 1,000/8,567 (11.7%)
   処理中... 2,000/8,567 (23.3%)
   ...
```

**所要時間の目安:**
- 大井（42）: 約10-15分（2年分）
- 名古屋（47）: 約20-30分（約4年分）
- その他（各）: 約30-60分（10年分）
- **合計**: 約3-5時間

---

### Step 3: データ確認

```sql
-- 1. 競馬場別データ件数確認
SELECT 
    keibajo_code,
    index_type,
    COUNT(*) as index_count,
    SUM(cnt_win) as total_races
FROM nar_hqs_index_stats
GROUP BY keibajo_code, index_type
ORDER BY keibajo_code, index_type;

-- 2. テン指数の実績確認（大井競馬場）
SELECT 
    index_value,
    cnt_win,
    rate_win_hit,
    rate_place_hit,
    adj_win_ret
FROM nar_hqs_index_stats
WHERE keibajo_code = '42' AND index_type = 'ten'
ORDER BY CAST(index_value AS INTEGER);

-- 3. 最も的中率が高い指数値トップ10
SELECT 
    keibajo_code,
    index_type,
    index_value,
    cnt_win,
    rate_win_hit,
    adj_win_ret
FROM nar_hqs_index_stats
WHERE cnt_win >= 100
ORDER BY rate_win_hit DESC
LIMIT 10;
```

---

## 📊 期待される結果

### データ量の目安

| 競馬場 | 期間 | 予想レース数 | 予想データ件数 |
|--------|------|-------------|---------------|
| 大井（42） | 2年 | 約2,500件 | 約400件（指数値別） |
| 名古屋（47） | 4年 | 約4,000件 | 約600件 |
| その他（各） | 10年 | 約10,000件 | 約800件 |
| **合計** | - | 約130,000件 | 約10,000件 |

### 的中率の目安（参考値）

| 指数種別 | 単勝的中率 | 複勝的中率 | 補正回収率 |
|---------|-----------|-----------|----------|
| テン指数 | 15-25% | 45-55% | 70-90% |
| 位置指数 | 18-28% | 50-60% | 75-95% |
| 上がり指数 | 16-26% | 48-58% | 72-92% |
| ペース指数 | 14-24% | 44-54% | 68-88% |

---

## ⚠️ トラブルシューティング

### エラー1: `ModuleNotFoundError: No module named 'config.db_config'`

**原因**: カレントディレクトリが正しくない

**解決策**:
```cmd
E:
cd \UmaData\nar-analytics-python-v2
python scripts\collect_index_stats.py
```

---

### エラー2: `psycopg2.OperationalError: FATAL: password authentication failed`

**原因**: データベース接続情報が正しくない

**解決策**:
```python
# config/db_config.py を確認
DB_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'user': 'postgres',
    'password': 'keiba2025',  # ← パスワード確認
    'dbname': 'pckeiba'
}
```

---

### エラー3: `取得レース数: 0件`

**原因**: 指定期間にデータが存在しない

**対処**:
- 特定の競馬場のみスキップされるのは正常（データなし）
- 全競馬場で0件の場合は、データベース接続を確認

---

## 📝 実行後の報告

実行完了後、以下の情報を報告してください：

1. **実行時間**: 開始〜終了までの時間
2. **処理件数**: 各競馬場の処理レース数
3. **エラー有無**: エラーが発生した場合は内容
4. **サンプルデータ**: Step 3のSQL結果（一部）

---

## 🎯 次のステップ

データ収集完了後、以下を実施します：

1. ✅ **データ検証**: 的中率・回収率の妥当性確認
2. ✅ **HQSスコア計算**: 公式にデータを代入してスコア算出
3. ✅ **ファクター選別**: HQSに追加する他のファクターを決定

---

**CEO、実行準備が整いました！上記手順で実行をお願いします。** 🚀
