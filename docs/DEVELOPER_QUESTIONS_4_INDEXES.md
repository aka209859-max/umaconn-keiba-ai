# 🔍 HQS 4指数の問題点とデベロッパーへの確認事項

## 📊 背景

地方競馬AI予想システム（NAR-AI-YOSO）において、4つのHQS指数（テン指数・位置指数・上がり指数・ペース指数）の実績データ分析を行ったところ、3つの指数で重大な問題を発見しました。

---

## 🚨 問題1: AGARI指数（上がり指数）の異常なクリッピング

### 現象
- **全競馬場で -100 が 96.7%〜99.7% を占める**
- 例:
  - 門別（30）: -100 が 99.3%
  - 大井（44）: -100 が 99.4%
  - 船橋（43）: -100 が 99.6%

### 予想される原因
```python
# core/index_calculator.py の ~460行目付近に問題がある可能性
# agari_index が -100 にクリッピングされている
```

### 期待される動作
- 上がり指数は馬の末脚能力を評価する指標
- -100 〜 +100 の範囲で正規分布に近い分布になるべき
- 現在は全てのデータが -100 に張り付いている

### デベロッパーへの質問
1. `core/index_calculator.py` の `calculate_agari_index()` 関数で、なぜ -100 にクリッピングされているのか？
2. 上がり指数の正しい計算式は何か？
3. 基準タイム（`base_kohan_3f`）が実データと乖離している可能性はあるか？

---

## 🚨 問題2: TEN指数（テン指数）の競馬場間の大きな偏り

### 現象
- **競馬場ごとに指数の平均値と範囲が大きく異なる**

| 競馬場 | 平均値 | 範囲 | 最頻値 | 問題点 |
|--------|--------|------|--------|--------|
| 門別(30) | +22.64 | -4〜43 | 41 (29.6%) | 高すぎる |
| 大井(44) | +20.60 | -4〜43 | 41 (27.4%) | 高すぎる |
| 笠松(47) | -5.55 | -21〜4 | -2 (65.2%) | 異常に低い |
| 金沢(46) | -0.93 | - | - | 正常 |
| 園田(50) | -1.57 | - | - | 正常 |

### 理想的な分布
- 各競馬場で平均値が 0 付近
- 標準偏差が 10〜20
- 正規分布に近い形

### 予想される原因
```python
# config/base_times.py の BASE_TIMES が実データと乖離している
# 特に門別・大井・笠松の基準タイムが不適切
```

### 対応中の作業
- `scripts/recalculate_base_times.py` で実データから基準タイムを再計算中
- 上位30%の平均タイムを新基準タイムとして設定

### デベロッパーへの質問
1. 現在の `BASE_TIMES` はどのような根拠で設定されたか？
2. テン指数の計算式 `(base_time - zenhan_3f) + 補正値` は正しいか？
3. 基準タイムの再計算後、他に調整が必要な箇所はあるか？

---

## 🚨 問題3: PACE指数（ペース指数）の 0 への収束

### 現象
- **全レースで PACE指数 = 0 が出やすい**
- ペース指数が機能していない

### 予想される原因
```python
# core/index_calculator.py の calculate_pace_index()
pace_index = (ten_index + agari_index) / 2 + pace_correction

# 問題点:
# 1. ten_index が高い（+20〜+40）
# 2. agari_index が -100 に固定
# 3. (20 + (-100)) / 2 = -40 にペース補正を加えても 0 付近に収束
```

### 期待される動作
- ペース指数はレース全体のペース配分を評価する指標
- ハイペース: マイナス値（前半速い）
- スローペース: プラス値（前半遅い）
- 平均ペース: 0 付近

### デベロッパーへの質問
1. ペース指数の計算式 `(ten_index + agari_index) / 2 + pace_correction` は正しいか？
2. `pace_correction` の値は適切か？（現在: H=-0.5, S=+0.5, M=0.0）
3. ディープサーチレポートで提案された最適値（H=-1.2, S=+0.8）を適用すべきか？

---

## ✅ 問題なし: POSITION指数（位置指数）

### 現状
- 0〜90 の範囲で正常に分布
- 最頻値 90、単勝率 29.21%〜58.86%
- 正常に機能している ✅

---

## 🎯 デベロッパーへの総合的な質問

### 1. 設計意図の確認
- 4つの指数の設計意図と期待される分布範囲は？
- 各指数の正規化戦略は？（0中心か、50中心か、など）

### 2. 基準タイムの扱い
- `config/base_times.py` の `BASE_TIMES` は手動設定か、データ分析結果か？
- 基準タイムの定期的な再計算は想定されているか？

### 3. クリッピングのロジック
- agari_index の -100 クリッピングは意図的か？
- クリッピングの閾値を変更する必要はあるか？

### 4. ペース補正値
- 現在のペース補正値（H=-0.5, S=+0.5, M=0.0）の根拠は？
- ディープサーチレポートの最適値（H=-1.2, S=+0.8）を採用すべきか？

### 5. 今後の最適化
- 4指数の最適な重み付けは？
- 機械学習（LightGBM等）での統合を前提とした設計か？

---

## 📈 現在進行中の対応

### Option A: 基準タイムの再計算（進行中）
- **目的**: TEN指数の競馬場間偏りを解消
- **方法**: 実データから上位30%の平均タイムを算出
- **スクリプト**: `scripts/recalculate_base_times.py`
- **状態**: 全距離対応版を実装、実行待ち

### Option B: ペース補正値の最適化（未着手）
- **目的**: PACE指数の 0 収束問題を解消
- **方法**: 実データから最適なペース補正値を算出
- **スクリプト**: `scripts/calculate_pace_correction.py`（作成済み）
- **状態**: Option A 完了後に実行予定

### AGARI指数の修正（未着手）
- **目的**: -100 クリッピング問題を解消
- **方法**: デベロッパーからの回答を待って対応
- **状態**: 原因特定待ち

---

## 🔥 緊急度と優先順位

| 問題 | 緊急度 | 影響範囲 | 優先順位 |
|------|--------|----------|----------|
| AGARI指数のクリッピング | ⚠️ 高 | 全競馬場・全レース | 1位 |
| TEN指数の偏り | ⚠️ 高 | 門別・大井・笠松 | 2位 |
| PACE指数の 0 収束 | ⚠️ 中 | 全競馬場・全レース | 3位 |

---

## 📞 連絡先

- **プロジェクト**: NAR-AI-YOSO（地方競馬AI予想システム）
- **GitHub**: https://github.com/aka209859-max/umaconn-keiba-ai
- **作成日**: 2026-01-09
- **作成者**: AI戦略家（CSO兼クリエイティブディレクター）

---

## 🎯 期待される回答

デベロッパーの皆様からの回答をお待ちしております：

1. 各問題の原因と解決策
2. 設計意図の確認
3. 修正の優先順位と実装方針
4. その他の潜在的な問題点

**Play to Win.** 🔥
