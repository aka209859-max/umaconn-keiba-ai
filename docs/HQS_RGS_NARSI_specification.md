# HQS・RGS・NAR-SI 3.0 完全仕様書

**作成日**: 2026-01-09  
**プロジェクト**: NAR-AI-YOSO（地方競馬AI予想システム Ver.4.0）

---

## 📋 目次

1. [3つのコアシステム概要](#1-3つのコアシステム概要)
2. [HQS得点システム](#2-hqs得点システム)
3. [4つの指数](#3-4つの指数)
4. [31ファクターシステム](#4-31ファクターシステム)
5. [RGSシステム](#5-rgsシステム)
6. [NAR-SI 3.0](#6-nar-si-30)
7. [現在の実装状況](#7-現在の実装状況)

---

## 1. 3つのコアシステム概要

### 1.1 システム構成

```
NAR-AI-YOSO Ver.4.0
├── NAR-SI Ver.3.0 ✅ 実装済み（スピード指数）
├── HQS得点システム ⏳ Phase 2実装中
│   ├── 4指数（テン・位置・上がり・ペース）✅ 実装済み
│   └── 31ファクター ❌ 未実装
└── RGS ❌ 未実装（レース格付けスコア）
```

### 1.2 各システムの役割

| システム | 役割 | 重視項目 | 出力 |
|---------|------|---------|------|
| **NAR-SI 3.0** | 走破タイムの絶対評価 | スピード | スピード指数（-100 ~ +100） |
| **HQS得点** | 🎯 **的中精度特化**（勝つか？来るか？） | 的中率 > 回収率 | HQS得点（-12 ~ +12） |
| **RGS得点** | 💰 **回収率特化**（美味しいか？儲かるか？） | 回収率 > 的中率 | RGS得点（未定） |

---

## 2. HQS得点システム

### 2.1 HQS得点とは

**HQS (High Quality Score, 旧名称: Adaptive Ability Score)**

- **定義**: 馬の総合能力を相対評価するスコアシステム
- **範囲**: -12 ~ +12
- **評価方式**: レース内でZスコア化による相対比較
- **基準**: 0点 = レース内平均

### 2.2 HQS得点の計算式

#### ステップ1: ファクターごとの統計データ取得

```python
factor_stats = {
    'cntWin': 単勝試行回数,
    'cntPlace': 複勝試行回数,
    'rateWinHit': 単勝的中率（%値）,
    'ratePlaceHit': 複勝的中率（%値）,
    'adjWinRet': 補正単勝回収率（%値）,
    'adjPlaceRet': 補正複勝回収率（%値）
}
```

#### ステップ2: Hit_raw, Ret_raw 計算

```python
Hit_raw = 0.65 × 単勝的中率 + 0.35 × 複勝的中率
Ret_raw = 0.35 × 補正単勝回収率 + 0.65 × 補正複勝回収率
N_min = min(単勝試行回数, 複勝試行回数)
```

#### ステップ3: レース内でZスコア化

```python
ZH = (Hit_raw - μ_Hit) / σ_Hit  # 母集団標準偏差（ddof=0）
ZR = (Ret_raw - μ_Ret) / σ_Ret  # 母集団標準偏差（ddof=0）
```

#### ステップ4: Shrinkage係数の計算

```python
Shr = √(N_min / (N_min + 400))
```

#### ステップ5: HQS得点の計算

```python
baseCalc = 0.55 × ZH + 0.45 × ZR
HQS = 12 × tanh(baseCalc) × Shr
```

**最終結果は小数点第1位に四捨五入**

### 2.3 HQS得点の構成要素

**HQS得点は以下の要素から構成されます:**

1. **4つの指数** （テン・位置・上がり・ペース）
2. **31のファクター** （選別して使用）

```
HQS得点 = f(4指数, 選別された31ファクター)
```

### 2.4 HQS得点の特徴（的中精度特化）

- **🎯 的中率重視**: 単勝65%、複勝35%で的中率を優先評価
- **相対評価**: レース内での相対的な能力を評価
- **Shrinkage効果**: データ量が少ないファクターの影響を抑制
- **tanh関数**: 極端な値を抑制し、-12 ~ +12 の範囲に収める
- **用途**: 本命・対抗馬の選定、的中率重視の馬券戦略

---

## 3. 4つの指数

### 3.1 4指数の概要

**4つの指数はJRDB指数体系に準拠しています**

| 指数名 | 英語名 | 測定対象 | データソース | 状態 |
|--------|--------|---------|-------------|------|
| **テン指数** | Ten Index | 初期加速力（前半3F） | 推定値 | ✅ 実装済み |
| **位置指数** | Position Index | レース中の平均ポジション | コーナー順位 | ✅ 実装済み |
| **上がり指数** | Agari Index | ラストスパート（後半3F） | 実データ | ✅ 実装済み |
| **ペース指数** | Pace Index | レース全体のペース配分 | 前半3F+後半3F | ✅ 実装済み |

### 3.2 各指数の詳細

#### 3.2.1 テン指数（Ten Index）

**定義**: スタートから最初の3ハロン（600m）の走破タイムを基準に算出する初期加速力指数

**計算式**:
```python
テン指数 = ((基準前半3Fタイム - 実走前半3Fタイム) + 
           馬場差補正 + 不利補正 + 斤量補正 + 枠順補正) × 10
```

**範囲**: -100 ~ +100

**データソース**:
- 前半3F: `ten_3f_estimator.py` で推定（3層AI）
- 基準タイム: `config/base_times.py`（実データから計算予定）

**補正項目**:
- 馬場差補正: 馬場状態による影響
- 不利補正: スタート不利などの補正
- 斤量補正: 斤量・馬体重による補正
- 枠順補正: 内枠/外枠による有利不利（長距離では減衰）

---

#### 3.2.2 位置指数（Position Index）

**定義**: レース中のコーナー順位から算出する平均ポジション指数

**計算式**:
```python
平均順位 = (corner_1 + corner_2 + corner_3 + corner_4) / 4
位置指数 = ((基準順位 - 平均順位) / 頭数 + 枠順補正) × 100
```

**範囲**: -100 ~ +100

**データソース**:
- コーナー順位: `nvd_ra.corner_tsuka_juni_1~4`（実データ）

**特徴**:
- 先行馬ほど高得点（プラス）
- 後方待機馬ほど低得点（マイナス）
- 枠順補正: 内枠+2点、外枠-2点

---

#### 3.2.3 上がり指数（Agari Index）

**定義**: ラストスパート能力（後半3F）を基準に算出するフィニッシュ指数

**計算式**:
```python
上がり指数 = ((基準後半3Fタイム - 実走後半3Fタイム) + 
             馬場差補正 + 不利補正 + 斤量補正 + ペース補正) × 10
```

**範囲**: -100 ~ +100

**データソース**:
- 後半3F: `nvd_se.kohan_3f`（実データ）
- 基準タイム: `config/base_times.py`（実データから計算予定）

**補正項目**:
- ペース補正: ハイペース/スローペースによる影響

---

#### 3.2.4 ペース指数（Pace Index）

**定義**: レース全体のペース配分を基準に算出するペース評価指数

**計算式**:
```python
ペース指数 = テン指数 + 上がり指数 + ペース配分補正
```

**ペースタイプ判定**:
```python
pace_ratio = 前半3F / (前半3F + 後半3F)

if pace_ratio >= base_ratio + 0.03:
    ペースタイプ = 'H'  # ハイペース（前半速い）
    ペース配分補正 = -10.0
elif pace_ratio <= base_ratio - 0.03:
    ペースタイプ = 'S'  # スローペース（前半遅い）
    ペース配分補正 = +10.0
else:
    ペースタイプ = 'M'  # ミドルペース
    ペース配分補正 = 0.0
```

**範囲**: -100 ~ +100

---

### 3.3 4指数の現在の状態

**✅ 実装完了**: 2026-01-09時点

- **データ収集**: `scripts/collect_index_stats.py` で282件のデータを収集
- **データベース**: `nar_hqs_index_stats` テーブルに保存
- **データ形式**: 競馬場別・指数値別の的中率・回収率データ

**データベース構造**:
```sql
nar_hqs_index_stats (
    keibajo_code,      -- 競馬場コード
    index_type,        -- 指数タイプ（position/ten/agari/pace）
    index_value,       -- 指数値（10刻み: 10, 20, 30...）
    cnt_win,           -- 単勝試行回数
    hit_win,           -- 単勝的中回数
    rate_win_hit,      -- 単勝的中率
    adj_win_ret,       -- 補正単勝回収率
    cnt_place,         -- 複勝試行回数
    hit_place,         -- 複勝的中回数
    rate_place_hit,    -- 複勝的中率
    adj_place_ret      -- 補正複勝回収率
)
```

**⚠️ 次のステップ**: 
1. 4指数の的中率・回収率を分析
2. HQS得点計算式に統合する方法を決定
3. 31ファクターとの組み合わせ方を設計

---

## 4. 31ファクターシステム

### 4.1 31ファクターとは

**31ファクター**: HQS得点を構成する31個の評価要素

```
31ファクター = 単独ファクター（16個） + 組み合わせファクター（15個）
```

### 4.2 単独ファクター（16個 + 追加13個 = 29個）

#### Phase 1 基本ファクター（16個）

| ID | ファクター名 | データソース | 状態 |
|----|------------|------------|------|
| F01 | 騎手 | nvd_se.kishu_code | ✅ |
| F02 | 調教師 | nvd_se.chokyoshi_code | ✅ |
| F03 | 距離適性 | nvd_ra.kyori | ✅ |
| F04 | 馬場状態 | nvd_ra.babajotai_code_dirt | ✅ |
| F05 | 回り | nvd_ra.mawari_code | ✅ |
| F06 | 条件 | nvd_ra.kyoso_joken_code | ✅ |
| F07 | 脚質 | computed_ashishitsu（計算） | ✅ |
| F08 | 枠番 | nvd_se.wakuban | ✅ |
| F09 | 前走着順 | prev_chakujun | ✅ |
| F10 | 前走人気 | prev_ninki | ✅ |
| F11 | 前走距離 | prev_kyori | ✅ |
| F12 | 前走馬場 | prev_baba | ✅ |
| F13 | 休養週数 | computed_kyuyo_weeks（計算） | ✅ |
| F14 | 馬体重 | nvd_se.bataiju | ✅ |
| F15 | 馬体重増減 | nvd_se.zogen_sa | ✅ |
| F16 | 性別 | nvd_se.seibetsu_code | ✅ |

#### Phase 1 高優先度ファクター（4個）

| ID | ファクター名 | データソース | 状態 |
|----|------------|------------|------|
| F17 | 馬齢 | nvd_se.barei | ✅ |
| F22 | 前走タイム差 | prev_time_sa | ✅ |
| F23 | 前走上がり3F | prev_kohan_3f | ✅ |
| F28 | 出走頭数 | nvd_ra.tosu | ✅ |

#### Phase 2 中優先度ファクター（4個）

| ID | ファクター名 | データソース | 状態 |
|----|------------|------------|------|
| F25 | 単勝オッズ | nvd_se.tansho_odds | ✅ |
| F26 | 単勝人気順 | nvd_se.tansho_ninkijun | ✅ |
| F27 | トラックコード | nvd_ra.track_code | ✅ |
| F29 | グレードコード | nvd_ra.grade_code | ✅ |

#### Phase 3 血統ファクター（6個）

| ID | ファクター名 | データソース | 状態 |
|----|------------|------------|------|
| B15 | 父ID | nvd_um.fufu_ketto_toroku_bango | ⚠️ JOIN必要 |
| B16 | 母ID | nvd_um.bobo_ketto_toroku_bango | ⚠️ JOIN必要 |
| B17 | 父父ID | nvd_um（再帰JOIN） | ⚠️ JOIN必要 |
| B18 | 父母ID | nvd_um（再帰JOIN） | ⚠️ JOIN必要 |
| B19 | 母父ID（BMS） | nvd_um.hahachichi_ketto_toroku_bango | ⚠️ JOIN必要 |
| B20 | 母母ID | nvd_um（再帰JOIN） | ⚠️ JOIN必要 |

#### Phase 2 新規ファクター（3個）

| ID | ファクター名 | データソース | 状態 |
|----|------------|------------|------|
| F24 | 前走枠番 | prev_wakuban | ✅ |
| F34 | 推定前半3F | estimated_ten_3f（計算） | ✅ |
| F35 | ペース変化率 | pace_change_rate（計算） | ✅ |

---

### 4.3 組み合わせファクター（15個）

| ID | ファクター名 | 組み合わせ | 状態 |
|----|------------|----------|------|
| C01 | 騎手×距離 | F01 + F03 | ❌ |
| C02 | 騎手×馬場状態 | F01 + F04 | ❌ |
| C03 | 騎手×回り | F01 + F05 | ❌ |
| C04 | 騎手×条件 | F01 + F06 | ❌ |
| C05 | 調教師×距離 | F02 + F03 | ❌ |
| C06 | 調教師×馬場状態 | F02 + F04 | ❌ |
| C07 | 距離×馬場状態 | F03 + F04 | ❌ |
| C08 | 距離×回り | F03 + F05 | ❌ |
| C09 | 脚質×距離 | F07 + F03 | ❌ |
| C10 | 脚質×馬場状態 | F07 + F04 | ❌ |
| C11 | 枠番×距離 | F08 + F03 | ❌ |
| C12 | 前走着順×休養週数 | F09 + F13 | ❌ |
| C13 | 前走人気×前走着順 | F10 + F09 | ❌ |
| C14 | 馬体重増減×休養週数 | F15 + F13 | ❌ |
| C15 | 性別×距離 | F16 + F03 | ❌ |

---

### 4.4 31ファクターの選別方法

**⚠️ 重要**: 31ファクター全てを使用するわけではありません

**選別基準**:
1. **回収率分析**: 各ファクターの単勝・複勝回収率を分析
2. **相関分析**: ファクター間の相関を確認
3. **重要度評価**: 予測精度への寄与度を評価
4. **組み合わせ最適化**: 最適なファクターの組み合わせを探索

**選別プロセス**:
```
31ファクター → 回収率分析 → 相関分析 → 重要度評価 → 最終選別（10-15個程度）
```

---

## 5. RGSシステム（回収率特化）

### 5.1 RGS (Race Grade Score) とは

**定義**: 💰 **回収率特化（旨味特化）**の得点システム

**目的**:
- 🎰 **回収率を最大化**（この馬は美味しいか？儲かるか？）
- 穴馬の発掘
- 高配当馬券の狙い撃ち

**評価方式**:
- 回収率 > 的中率
- オッズと実力の乖離を評価
- 過小評価されている馬を発見

**用途**:
- 穴馬狙いの馬券戦略
- 三連単・三連複などの高配当狙い
- 回収率重視の長期戦略

### 5.2 RGS得点の計算式（仮）

**⚠️ 注意**: RGSの計算式は未確定です。以下は仮の設計案です。

#### 基本コンセプト

```python
# HQSとは逆の重み付け
Hit_raw = 0.35 × 単勝的中率 + 0.65 × 複勝的中率  # 的中率の重みを下げる
Ret_raw = 0.65 × 補正単勝回収率 + 0.35 × 補正複勝回収率  # 回収率の重みを上げる

baseCalc = 0.35 × ZH + 0.65 × ZR  # 回収率を重視
RGS = 12 × tanh(baseCalc) × Shr
```

#### オッズ乖離評価

```python
# オッズと実力の乖離を評価
実力評価 = HQS得点 + NAR-SI指数
オッズ評価 = 単勝オッズから算出した期待値
乖離度 = 実力評価 - オッズ評価

RGS得点 = f(回収率, オッズ乖離度, 穴馬度)
```

### 5.3 RGSの特徴（回収率特化）

- **💰 回収率重視**: 回収率 > 的中率
- **穴馬発掘**: 過小評価されている馬を発見
- **オッズ乖離評価**: 実力とオッズのギャップを数値化
- **高配当狙い**: 三連単・三連複などの高配当馬券に最適
- **用途**: 穴馬狙い、回収率重視の長期戦略

### 5.4 実装状況

**❌ 未実装**

- ファイル: `core/rgs_calculator.py`（7.4 KB）
- 状態: 実装準備完了（ロジック未実装）

---

## 6. NAR-SI 3.0

### 6.1 NAR-SI 3.0とは

**NAR-SI Ver.3.0**: 地方競馬スピード指数システム

**目的**: 走破タイムの絶対評価

**範囲**: -100 ~ +100

### 6.2 実装状況

**✅ 実装済み**

**ファイル構成**:
- `core/nar_si_v3.py`（8.3 KB）
- `core/nar_si_calculator_v2_1_b.py`（6.9 KB）- バランス版
- `core/nar_si_v3_data_fetcher.py`（10.6 KB）
- `core/nar_si_v3_feature_engineering.py`（9.7 KB）

**機能**:
- 馬体重補正: -0.2/-0.4/-0.6
- 枠番補正: 内枠+2/外枠-2
- クラス補正: 条件クラス別の補正値

---

## 7. 現在の実装状況

### 7.1 Phase 2の現状（2026-01-09時点）

#### ✅ 完了済み

1. **4指数の実装**: テン・位置・上がり・ペース指数の計算ロジック完成
2. **4指数の統計データ収集**: 282件のデータを`nar_hqs_index_stats`に保存
3. **コーナー順位パーサの修正**: 12/12テスト成功
4. **Position指数の検証**: 単勝的中率35.18%（指数値10）を確認

#### ⏳ 進行中

1. **4指数の的中率・回収率分析**: 全指数の性能評価
2. **HQS得点計算式への統合**: 4指数をHQS得点に組み込む方法の設計

#### ❌ 未着手

1. **31ファクターの実装**: データ収集と統計分析
2. **31ファクターの選別**: 回収率分析と重要度評価
3. **HQS得点の最終実装**: 4指数 + 選別ファクターの統合
4. **RGSの実装**: レース格付けスコアの開発

---

### 7.2 次にやるべきタスク

#### 優先順位1: 4指数の性能評価

```bash
# 全指数の的中率・回収率を表示
python scripts/show_all_index_stats.py
```

**目的**: テン指数、上がり指数、ペース指数の性能を確認

#### 優先順位2: HQS得点計算式の設計

**検討事項**:
1. 4指数をどのようにHQS得点に組み込むか？
2. 4指数と31ファクターの重み付けは？
3. 4指数の標準化方法は？

#### 優先順位3: 31ファクターの実装開始

**手順**:
1. 各ファクターの統計データを収集
2. 回収率分析を実施
3. 重要度評価と選別
4. HQS得点への統合

---

## 8. 重要な用語の整理

### 8.1 指数 vs 得点

| 用語 | 定義 | 範囲 | 評価方式 |
|------|------|------|---------|
| **指数** | 特定の能力を測定する数値 | -100 ~ +100 | 絶対評価 |
| **得点** | 総合能力を評価するスコア | -12 ~ +12 | 相対評価 |

**例**:
- **テン指数**: 前半3Fの走破タイムから計算する指数
- **HQS得点**: 4指数 + 31ファクターから計算する総合得点

---

## 9. まとめ

### 9.1 現在の状況

- ✅ **NAR-SI 3.0**: 実装済み（スピード指数）
- ✅ **4指数**: 実装済み、統計データ収集完了
- ⏳ **HQS得点**（🎯 的中精度特化）: 計算式確定、4指数統合方法を検討中
- ❌ **31ファクター**: 未実装
- ❌ **RGS得点**（💰 回収率特化）: 未実装

### 9.2 HQS得点の構造（的中精度特化）

```
HQS得点（🎯 的中精度特化） = f(4指数, 選別された31ファクター)
         = Zスコア化 + Shrinkage + tanh関数
         = -12 ~ +12
         = 的中率 > 回収率
```

**4指数**:
1. テン指数（前半3F）
2. 位置指数（コーナー順位）
3. 上がり指数（後半3F）
4. ペース指数（ペース配分）

**31ファクター**:
- 単独ファクター: 29個（定義済み）
- 組み合わせファクター: 15個（未実装）
- **選別が必要**: 全て使用するわけではない

### 9.3 RGS得点の構造（回収率特化）

```
RGS得点（💰 回収率特化） = f(回収率, オッズ乖離度, 穴馬度)
         = 回収率 > 的中率
         = 穴馬発掘に特化
         = 高配当馬券戦略に最適
```

### 9.4 HQSとRGSの使い分け

| 項目 | HQS得点（🎯 的中精度特化） | RGS得点（💰 回収率特化） |
|------|----------------------|-------------------|
| **目的** | 勝つか？来るか？ | 美味しいか？儲かるか？ |
| **重視** | 的中率 > 回収率 | 回収率 > 的中率 |
| **用途** | 本命・対抗馬選定 | 穴馬発掘 |
| **馬券** | 単勝・複勝・馬連 | 三連単・三連複 |
| **戦略** | 的中率重視 | 回収率重視 |

### 9.5 次のステップ

1. **全指数の性能評価**: `show_all_index_stats.py`を実行
2. **HQS得点への統合設計**: 4指数をHQS得点に組み込む方法を決定
3. **31ファクターの実装開始**: 優先度の高いファクターから実装
4. **RGS得点の設計**: 回収率特化ロジックの設計

---

**Play to Win. 🔥**
