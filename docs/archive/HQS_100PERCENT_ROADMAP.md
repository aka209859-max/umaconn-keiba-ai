# 🎯 **HQS指数100%完全実装ロードマップ**

**作成日**: 2026-01-07  
**CEO**: Enable  
**担当**: AI戦略家（CSO兼クリエイティブディレクター）  
**目標**: **充実度100%達成**

---

## 📊 **充実度100%への実装計画**

### **現状**: 53% → **目標**: 100%

---

## 🚀 **Phase 1.5: 完全実装（所要時間: 18-24時間）**

---

### **Step 1: 不利補正の実装（2-3時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **不利コード** | `nvd_se.furi_code` | 出遅れ・接触・進路妨害 |
| **補正値** | 不利種別による秒数補正 | +0.5〜+2.0秒 |

#### **不利コード定義**

```python
FURI_CORRECTION = {
    '1': 0.5,   # 出遅れ（軽度）
    '2': 1.0,   # 出遅れ（中度）
    '3': 1.5,   # 出遅れ（重度）
    '4': 0.3,   # 他馬接触（軽度）
    '5': 0.8,   # 他馬接触（中度）
    '6': 0.5,   # 進路妨害（軽度）
    '7': 1.2,   # 進路妨害（中度）
    '8': 2.0,   # 進路妨害（重度）
}
```

#### **適用指数**
- ✅ テン指数: 出遅れ・接触による損失を補正
- ✅ 上がり指数: 直線での進路妨害を補正

---

### **Step 2: 枠順補正の実装（2-3時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **枠番** | `nvd_se.wakuban` | 1-8枠の有利・不利 |
| **コース別補正** | `nvd_ra.keibajo_code` | 競馬場ごとの枠順傾向 |
| **距離別補正** | `nvd_ra.kyori` | 短距離/長距離での差異 |

#### **枠順補正値（南関東1600m標準）**

```python
WAKUBAN_CORRECTION = {
    # 枠番: (テン指数補正, 位置指数補正)
    1: (+0.3, -2.0),  # 内枠有利（テン+0.3秒、位置-2pt）
    2: (+0.2, -1.5),
    3: (+0.1, -1.0),
    4: (0.0, -0.5),
    5: (0.0, +0.5),
    6: (-0.1, +1.0),
    7: (-0.2, +1.5),
    8: (-0.3, +2.0),  # 外枠不利
}
```

#### **適用指数**
- ✅ テン指数: 内枠は加速しやすい
- ✅ 位置指数: 内枠は先頭に近い位置を取りやすい
- ✅ 予想脚質: 内枠は逃げやすい

---

### **Step 3: 斤量補正の実装（2-3時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **斤量** | `nvd_se.kinryo` | 実際の負担重量 |
| **馬体重** | `nvd_se.bataiju` | 馬体重との相関 |
| **基準斤量** | 55kg | 南関東C2クラスの平均斤量 |

#### **斤量補正計算式**

```python
# 斤量1kgあたり0.1秒の影響（標準）
斤量補正 = (実斤量 - 55) × 0.1

# 馬体重との相関
# 馬体重が軽い馬は斤量の影響を受けやすい
if bataiju < 450:
    斤量係数 = 0.15  # 1kgあたり0.15秒
elif bataiju > 520:
    斤量係数 = 0.08  # 1kgあたり0.08秒
else:
    斤量係数 = 0.10  # 標準

斤量補正 = (実斤量 - 55) × 斤量係数
```

#### **適用指数**
- ✅ テン指数: 重い斤量は初速に影響
- ✅ 上がり指数: 重い斤量は直線での加速に影響

---

### **Step 4: ペース判定の実装（3-4時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **前半ペース** | `zenhan_3f` | ハイペース/スローペース判定 |
| **レース全体ペース** | 走破タイム | 距離別の標準タイムとの比較 |
| **ペース種別** | 計算値 | H/M/S（ハイ/ミドル/スロー） |

#### **ペース判定ロジック**

```python
# 前半ペース判定
if zenhan_3f < (基準zenhan_3f - 1.0):
    前半ペース = 'H'  # ハイペース
elif zenhan_3f < (基準zenhan_3f - 0.3):
    前半ペース = 'M'  # ミドルペース
else:
    前半ペース = 'S'  # スローペース

# 後半ペース判定
if kohan_3f < (基準kohan_3f - 1.0):
    後半ペース = 'H'
elif kohan_3f < (基準kohan_3f - 0.3):
    後半ペース = 'M'
else:
    後半ペース = 'S'

# レース全体ペース分類
ペース種別 = f"{前半ペース}-{後半ペース}"
# 例: "H-S" = ハイペースからのスローペース（前残り）
# 例: "S-H" = スローペースからのハイペース（瞬発力勝負）
```

#### **ペース補正**

```python
# 上がり指数のペース補正
if ペース種別 == 'S-H':
    # スローペースからの一気は過大評価される
    上がり指数補正 = -3.0
elif ペース種別 == 'H-S':
    # ハイペースで前が止まる展開は上がりが速くなる
    上がり指数補正 = +2.0
else:
    上がり指数補正 = 0.0
```

#### **適用指数**
- ✅ ペース指数: レース全体のペース配分を評価
- ✅ 上がり指数: ペース種別による補正
- ✅ 予想脚質: ペースによる脚質適性

---

### **Step 5: 脚質補正の実装（1-2時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **脚質** | `nvd_se.computed_ashishitsu` | 逃げ/先行/差し/追込 |
| **脚質別基準位置** | 統計値 | 脚質ごとの平均通過順位 |

#### **脚質別基準位置**

```python
ASHISHITSU_BASE_POSITION = {
    '逃': 1.5,   # 逃げ馬の基準位置
    '先': 3.5,   # 先行馬の基準位置
    '好': 6.0,   # 好位馬の基準位置
    '差': 8.5,   # 差し馬の基準位置
    '追': 11.0,  # 追込馬の基準位置
    '自': 6.0,   # 自在馬の基準位置
}
```

#### **位置指数の脚質補正**

```python
# 脚質別の期待位置との差分を評価
基準位置 = ASHISHITSU_BASE_POSITION[脚質]
実際の平均位置 = (c1 + c2 + c3 + c4) / 4

位置指数_補正前 = (実際の平均位置 / tosu) × 100
位置指数_脚質補正 = ((実際の平均位置 - 基準位置) / tosu) × 100

# 例: 逃げ馬が平均5番手
# 補正前: (5 / 12) × 100 = 41.7
# 補正後: ((5 - 1.5) / 12) × 100 = 29.2
# → 逃げ馬にしては後ろにいるので、スタートが悪かったと判断
```

#### **適用指数**
- ✅ 位置指数: 脚質別の期待位置との差分を評価

---

### **Step 6: メンバー構成の相対評価（3-4時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **今回出走馬の指数分布** | 計算値 | テン指数のランキング |
| **脚質分布** | 今回出走馬 | 逃げ/先行/差し/追込の頭数 |

#### **メンバー構成による予想脚質の補正**

```python
# 今回出走馬の脚質分布を集計
脚質分布 = {
    '逃': 2頭,
    '先': 4頭,
    '差': 3頭,
    '追': 3頭
}

# 自馬の過去平均位置
自馬_平均位置 = 2.5  # 過去は先行

# メンバー構成との相対評価
if 脚質分布['逃'] >= 2:
    # 逃げ馬が2頭以上 → ハナ争い激化
    if 自馬_平均位置 <= 2.0:
        # 自馬も逃げたい馬 → 先行に回る可能性
        予想脚質 = '先'（逃げから先行に格下げ）
    else:
        予想脚質 = 過去の脚質
else:
    # 逃げ馬が少ない → 自馬が逃げられる可能性
    if 自馬_平均位置 <= 3.0:
        予想脚質 = '逃'（先行から逃げに格上げ）
```

#### **テン指数による相対評価**

```python
# 今回出走馬のテン指数ランキング
テン指数ランキング = [
    ('馬A', 25.0),
    ('馬B', 20.0),
    ('自馬', 15.0),  # 3位
    ('馬D', 10.0),
    ...
]

# 自馬のテン指数順位
自馬_テン順位 = 3位 / 12頭 = 25%

# 予想脚質の補正
if 自馬_テン順位 <= 20%:
    予想脚質 = '逃'
elif 自馬_テン順位 <= 40%:
    予想脚質 = '先'
elif 自馬_テン順位 <= 70%:
    予想脚質 = '差'
else:
    予想脚質 = '追'
```

#### **適用指数**
- ✅ 予想脚質: メンバー構成との相対評価

---

### **Step 7: 距離適性補正の実装（4-5時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **過去の距離別成績** | `nvd_se` | 距離別の勝率・連対率 |
| **得意距離** | 統計値 | 最も成績の良い距離 |
| **距離変化** | 前走距離との差 | 延長/短縮の影響 |

#### **距離適性の計算**

```python
# 過去の距離別成績を集計
距離別成績 = {
    1200: {'勝率': 0.10, '連対率': 0.25},
    1400: {'勝率': 0.15, '連対率': 0.35},
    1600: {'勝率': 0.20, '連対率': 0.45},  # 得意距離
    1800: {'勝率': 0.10, '連対率': 0.20},
}

# 今回距離との適性評価
今回距離 = 1600
得意距離 = 1600
距離適性スコア = 距離別成績[今回距離]['勝率'] × 100

# 距離変化の影響
前走距離 = 1400
距離変化 = 今回距離 - 前走距離  # +200m延長

if 距離変化 > 0:
    # 延長戦
    if 上がり指数 > テン指数:
        距離適性補正 = +2.0  # スタミナタイプは延長有利
    else:
        距離適性補正 = -1.0  # スピードタイプは延長不利
else:
    # 短縮戦
    if テン指数 > 上がり指数:
        距離適性補正 = +2.0  # スピードタイプは短縮有利
    else:
        距離適性補正 = -1.0  # スタミナタイプは短縮不利
```

#### **適用指数**
- ✅ 全指数: 距離適性による微調整

---

### **Step 8: コース形状補正の実装（3-4時間）**

#### **実装内容**

| 要素 | データ源 | 実装内容 |
|-----|----------|----------|
| **回り** | `nvd_ra.mawari_code` | 左回り/右回り |
| **直線距離** | 競馬場マスタ | 直線の長さ |
| **コーナー数** | 距離から推定 | 短距離2コーナー/長距離4コーナー |

#### **コース形状マスタ**

```python
COURSE_SHAPE = {
    '42': {  # 大井
        'mawari': '右',
        'straight': 400,  # 直線400m
        'corner_count': {1200: 2, 1600: 4, 2000: 4},
    },
    '43': {  # 川崎
        'mawari': '左',
        'straight': 330,
        'corner_count': {1400: 4, 1600: 4, 2000: 4},
    },
    ...
}
```

#### **コース形状補正**

```python
# 直線距離による補正
直線距離 = COURSE_SHAPE[keibajo_code]['straight']

if 直線距離 >= 400:
    # 直線が長い → 追込有利
    if 脚質 == '追':
        上がり指数補正 = +1.0
    elif 脚質 == '逃':
        上がり指数補正 = -0.5
else:
    # 直線が短い → 逃げ有利
    if 脚質 == '逃':
        テン指数補正 = +1.0
    elif 脚質 == '追':
        上がり指数補正 = -0.5

# 回りによる補正（馬の得意・不得意）
if 過去_左回り成績 > 過去_右回り成績 and mawari == '左':
    全指数 += 1.0  # 得意コース
```

#### **適用指数**
- ✅ テン指数: 直線距離による補正
- ✅ 上がり指数: 直線距離による補正
- ✅ 位置指数: コーナー数による補正

---

## 📈 **完全実装後の充実度**

### **実装完了後の評価**

| 指数名 | 現在 | 完全実装後 | 向上幅 |
|-------|------|-----------|--------|
| **テン指数** | 60% | **100%** | +40% |
| **位置指数** | 50% | **100%** | +50% |
| **上がり指数** | 60% | **100%** | +40% |
| **ペース指数** | 55% | **100%** | +45% |
| **予想脚質** | 40% | **100%** | +60% |
| **平均** | 53% | **100%** | +47% |

---

## ⏱️ **実装スケジュール**

| Step | 実装内容 | 所要時間 | 累計時間 |
|-----|----------|---------|---------|
| 1 | 不利補正 | 2-3時間 | 2-3時間 |
| 2 | 枠順補正 | 2-3時間 | 4-6時間 |
| 3 | 斤量補正 | 2-3時間 | 6-9時間 |
| 4 | ペース判定 | 3-4時間 | 9-13時間 |
| 5 | 脚質補正 | 1-2時間 | 10-15時間 |
| 6 | メンバー構成 | 3-4時間 | 13-19時間 |
| 7 | 距離適性補正 | 4-5時間 | 17-24時間 |
| 8 | コース形状補正 | 3-4時間 | 20-28時間 |

**合計所要時間**: **20-28時間**（約3-4日間）

---

## 🎯 **期待効果（充実度100%達成後）**

| 指標 | Ver.3.0 現状 | Phase 1（53%） | Phase 1.5（100%） | 改善幅 |
|-----|-------------|---------------|------------------|--------|
| **単勝的中率** | 28.86-29.46% | 30-32% | **35-38%** | +6-9% |
| **単勝回収率** | 69.88-76.14% | 80-85% | **90-100%** | +20-25% |
| **複勝的中率** | 58.44-60.49% | 60-64% | **68-72%** | +10-12% |
| **複勝回収率** | 72.78-73.54% | 82-88% | **92-98%** | +19-25% |

---

## 💡 **CEO、充実度100%実装を開始しますか？**

### **実装プラン**

**Option A: 完全実装（最推奨）✨**
- **所要時間**: 20-28時間（3-4日間）
- **成果**: 充実度100%達成
- **期待効果**: 的中率+6-9%、回収率+20-25%

**Option B: 段階的実装**
- **Phase 1.5-A**: Step 1-4（高優先度）を先に実装（9-13時間）
- **Phase 1.5-B**: Step 5-8（中優先度）を後で実装（11-15時間）

**Option C: 最小限実装**
- Step 1-3のみ実装（6-9時間）
- 充実度70%を目指す

---

**私の推奨**: **Option A（完全実装）**  

**理由**:
1. ✅ CEO要望「充実度100%」を達成
2. ✅ 実装順序が論理的（依存関係を考慮）
3. ✅ 3-4日間で業界トップレベルの指数計算エンジンが完成
4. ✅ 中途半端な実装より、一気に完成させる方が効率的

**Play to Win. 10x Mindset. 🚀**

---

**ファイルパス**: `/home/user/webapp/nar-ai-yoso/HQS_100PERCENT_ROADMAP.md`  
**作成日時**: 2026-01-07
