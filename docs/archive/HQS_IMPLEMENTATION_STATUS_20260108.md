# HQS実装 - 現状報告と次のステップ

**作成日**: 2026-01-08  
**報告者**: AI戦略家（CSO兼クリエイティブディレクター）  
**プロジェクト**: NAR-SI Ver.4.0 統合システム - HQS実装

---

## ✅ 完了事項

### 1. HQS（Hit Quality Score）の定義確認
- ✅ HQS = **Hit Quality Score**（的中精度を最大化するスコア）
- ✅ 4つの基礎指数で構成:
  - テン指数（初期加速力）
  - 位置指数（レース中の平均ポジション）
  - 上がり指数（ラストスパート能力）
  - ペース指数（ペース配分のバランス）

### 2. 31ファクター vs Ver.3.0使用状況の整理
- ✅ **NAR-SI Ver.3.0使用ファクター**: 13個
- ✅ **HQS/RGS独立ファクター**: 38個（重複なし）
- ✅ 4つの基礎指数で使用: 6個（corner_1-4, kohan_3f, zenhan_3f）

### 3. 実装状況の確認
- ✅ **テン指数**: ⚠️ 推定実装（Ten3F推定エンジン使用）
- ✅ **位置指数**: ✅ 完全実装（データ充足率100%）
- ✅ **上がり指数**: ✅ 完全実装（データ充足率100%）
- ✅ **ペース指数**: ⚠️ 最適化実装（Ten3F推定 + kohan_3f）

### 4. データ収集期間の決定
- ✅ **大井（42）**: 2023年10月〜2025年12月31日（砂変更後）
- ✅ **名古屋（47）**: 2022年4月〜2025年12月31日（大幅改修後）
- ✅ **その他12競馬場**: 2016年1月〜2025年12月31日（長期データ）

### 5. 実装完成
- ✅ `scripts/collect_index_stats.py`: 実績データ収集スクリプト
- ✅ `scripts/create_hqs_index_stats_table.sql`: テーブル作成SQL
- ✅ `HQS_INDEX_STATS_EXECUTION_GUIDE.md`: CEO向け実行ガイド
- ✅ Git commit完了（2件）

---

## 📊 HQSの計算フロー（確認済み）

```
┌─────────────────────────────────────────────────┐
│ Step 1: 4つの指数を計算（完了）                 │
│   - テン指数・位置指数・上がり指数・ペース指数  │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 2: 各指数の実績データを集計（今ここ！）    │
│   - 単勝的中率                                  │
│   - 複勝的中率                                  │
│   - 単勝補正回収率                              │
│   - 複勝補正回収率                              │
│   → CEO環境で実行予定（3-5時間）                │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 3: HQSスコアを計算（公式に代入）           │
│   Hit_raw = 0.65×単勝的中率 + 0.35×複勝的中率  │
│   Ret_raw = 0.35×補正単勝回収率 + 0.65×補正複勝回収率 │
│   ZH = (Hit_raw - μH) / σH                     │
│   ZR = (Ret_raw - μR) / σR                     │
│   Shr = sqrt(N / (N + 400))                    │
│   HQS = 12 × tanh(0.55×ZH + 0.45×ZR) × Shr    │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 4: 他のファクター（38個）も同様に集計      │
│   → 4つの指数完了後に実施                      │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ Step 5: ファクター選別                          │
│   - HQSスコアが高いファクターを選択             │
│   - 最終的なHQS公式に追加するファクターを決定   │
└─────────────────────────────────────────────────┘
```

---

## 🎯 次のアクション（CEO）

### 実行タスク

**Task 1: テーブル作成（1分）**
```cmd
E:
cd \UmaData\nar-analytics-python-v2
psql -U postgres -d pckeiba -f scripts\create_hqs_index_stats_table.sql
```

**Task 2: データ収集実行（3-5時間）**
```cmd
python scripts\collect_index_stats.py
```

**Task 3: 結果確認（5分）**
```sql
-- 競馬場別データ件数確認
SELECT keibajo_code, index_type, COUNT(*) as count, SUM(cnt_win) as total
FROM nar_hqs_index_stats
GROUP BY keibajo_code, index_type
ORDER BY keibajo_code, index_type;
```

---

## 📋 実行後の報告事項

CEO、実行完了後に以下を報告してください：

1. ✅ **実行時間**: 開始〜終了までの時間
2. ✅ **処理件数**: 各競馬場の処理レース数
3. ✅ **エラー有無**: エラーが発生した場合は内容
4. ✅ **サンプルデータ**: 確認SQLの結果（スクリーンショットまたはテキスト）

---

## 🚀 その後の作業（サンドボックス側）

### データ検証（30分）
- 的中率・回収率の妥当性確認
- 競馬場別の傾向分析
- 異常値の検出

### HQSスコア計算実装（1-2時間）
- `core/hqs_calculator.py` の実装
- 公式にデータを代入
- レース単位でのHQSスコア算出

### 他ファクターの実績データ収集（2-3時間）
- 38個の独立ファクターについても同様に集計
- ファクター選別基準の策定

### 統合テスト（1-2時間）
- NAR-SI Ver.3.0 + HQS の統合
- 精度検証（単勝的中率・複勝的中率）

---

## 📊 期待される成果

### 現状（NAR-SI Ver.3.0）
- 単勝的中率: 28.86-29.46%
- 複勝的中率: 58.44-60.49%

### 目標（Ver.4.0 = NAR-SI + HQS + RGS）
- 単勝的中率: 32-35% (+3-6pt)
- 複勝的中率: 62-68% (+4-8pt)

---

## 💡 重要な理解事項

1. ✅ **HQS = Hit Quality Score**（的中精度最大化）
2. ✅ **4つの指数は独立したファクター**（それぞれ単勝/複勝的中率を持つ）
3. ✅ **HQSスコア = 複数ファクターの統合評価**（公式で計算）
4. ✅ **データ収集期間は競馬場ごとに最適化**（改修時期を考慮）

---

## 📝 Git履歴

```
commit 7265a2c - 📖 HQS指数実績データ収集 実行ガイド作成
commit 30f4468 - ✅ HQS指数実績データ収集システム完成 - 競馬場別期間対応
```

---

**CEO、実装準備が完了しました。HQS_INDEX_STATS_EXECUTION_GUIDE.md を参照して実行をお願いします！** 🚀

**Play to Win. 10x Mindset. 48時間で確信に変えましょう！**
