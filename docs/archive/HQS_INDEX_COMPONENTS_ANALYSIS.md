# 🔬 **HQS指数の構成要素詳細分析**

**作成日**: 2026-01-07  
**CEO**: Enable  
**担当**: AI戦略家（CSO兼クリエイティブディレクター）

---

## 📊 **各指数の構成要素一覧**

---

### **1. テン指数（Ten Index）** - 初期加速力

#### **現在の実装（Phase 1）**

| 要素 | 内容 | データ源 | 補正方法 |
|-----|------|----------|----------|
| ✅ **前半3Fタイム** | スタート〜600m地点の走破タイム | `nvd_se.zenhan_3f` | 実測値 |
| ✅ **コース** | 競馬場コード（30-65） | `nvd_ra.keibajo_code` | 競馬場別基準タイム |
| ✅ **距離** | レース距離（m） | `nvd_ra.kyori` | 距離別基準タイム |
| ✅ **クラス** | C2/Cクラスを基準（0） | - | 基準タイム設定で反映 |
| ✅ **馬場差** | 良/稍重/重/不良 | `nvd_ra.babajotai_code_dirt` | +0.0/+0.3/+0.6/+1.0秒 |
| ❌ **不利** | 出遅れ・他馬との接触 | - | **未実装** |

#### **計算式**
```python
テン指数 = ((基準3Fタイム - 実走3Fタイム) + 馬場差補正) × 10

# 具体例
基準3Fタイム = 36.5秒（大井1600m・C2クラス・良馬場）
実走3Fタイム = 35.0秒
馬場差補正   = 0.0秒（良馬場）

テン指数 = ((36.5 - 35.0) + 0.0) × 10 = 15.0
```

#### **含まれていない要素（今後の拡張候補）**
- ❌ 不利（出遅れ・他馬との接触・進路妨害）
- ❌ 枠順補正（内枠有利/外枠不利）
- ❌ 斤量補正（馬体重との相関）
- ❌ ペース補正（スローペース時の過大評価防止）

---

### **2. 位置指数（Position Index）** - レース中の平均ポジション

#### **現在の実装（Phase 1）**

| 要素 | 内容 | データ源 | 補正方法 |
|-----|------|----------|----------|
| ✅ **1コーナー順位** | 1コーナー通過時の順位 | `nvd_se.corner_1` | 4コーナー平均 |
| ✅ **2コーナー順位** | 2コーナー通過時の順位 | `nvd_se.corner_2` | 4コーナー平均 |
| ✅ **3コーナー順位** | 3コーナー通過時の順位 | `nvd_se.corner_3` | 4コーナー平均 |
| ✅ **4コーナー順位** | 4コーナー通過時の順位 | `nvd_se.corner_4` | 4コーナー平均 |
| ✅ **出走頭数** | レースの出走頭数 | `nvd_ra.tosu` | 正規化（0-100スケール） |
| ❌ **脚質** | 逃げ/先行/差し/追込 | `nvd_se.computed_ashishitsu` | **未実装** |
| ❌ **コース形状** | 直線/回り/距離 | - | **未実装** |

#### **計算式**
```python
位置指数 = (平均通過順位 / 出走頭数) × 100

# 具体例
コーナー順位 = [2, 2, 3, 2]
平均通過順位 = (2 + 2 + 3 + 2) / 4 = 2.25
出走頭数     = 12頭

位置指数 = (2.25 / 12) × 100 = 18.8
```

#### **含まれていない要素（今後の拡張候補）**
- ❌ 脚質補正（逃げ馬は先頭にいるのが当然 → 位置指数を下げる）
- ❌ コース形状補正（直線コースは隊列が伸びやすい）
- ❌ 距離補正（短距離は隊列が団子、長距離は縦長）
- ❌ 不利補正（進路妨害で大外を回った場合）

---

### **3. 上がり指数（Agari Index）** - ラストスパート能力

#### **現在の実装（Phase 1）**

| 要素 | 内容 | データ源 | 補正方法 |
|-----|------|----------|----------|
| ✅ **後半3Fタイム** | 残り600m地点〜ゴールの走破タイム | `nvd_se.kohan_3f` | 実測値 |
| ✅ **コース** | 競馬場コード（30-65） | `nvd_ra.keibajo_code` | 競馬場別基準タイム |
| ✅ **距離** | レース距離（m） | `nvd_ra.kyori` | 距離別基準タイム |
| ✅ **クラス** | C2/Cクラスを基準（0） | - | 基準タイム設定で反映 |
| ✅ **馬場差** | 良/稍重/重/不良 | `nvd_ra.babajotai_code_dirt` | +0.0/+0.3/+0.6/+1.0秒 |
| ❌ **不利** | 直線での進路妨害 | - | **未実装** |

#### **計算式**
```python
上がり指数 = ((基準後半3Fタイム - 実走後半3Fタイム) + 馬場差補正) × 10

# 具体例
基準後半3Fタイム = 39.0秒（大井1600m・C2クラス・良馬場）
実走後半3Fタイム = 37.5秒
馬場差補正       = 0.0秒（良馬場）

上がり指数 = ((39.0 - 37.5) + 0.0) × 10 = 15.0
```

#### **含まれていない要素（今後の拡張候補）**
- ❌ 不利（直線での進路妨害・他馬との接触）
- ❌ ペース補正（スローペースからの一気は過大評価される）
- ❌ 位置補正（後方からの追い込みは距離ロスがある）
- ❌ 斤量補正（直線での加速力は斤量の影響を受けやすい）

---

### **4. ペース指数（Pace Index）** - レース全体のペース配分

#### **現在の実装（Phase 1）**

| 要素 | 内容 | データ源 | 補正方法 |
|-----|------|----------|----------|
| ✅ **テン指数** | 前半3Fの速さ | 計算値 | テン指数 |
| ✅ **上がり指数** | 後半3Fの速さ | 計算値 | 上がり指数 |
| ✅ **ペース比率** | 前半3F / 後半3F | `zenhan_3f / kohan_3f` | (0.35 - 比率) × 10 |
| ❌ **脚質** | 逃げ/先行/差し/追込 | - | **未実装** |

#### **計算式**
```python
ペース指数 = (テン指数 + 上がり指数) / 2 + ペース配分補正

ペース配分補正 = (0.35 - zenhan_3f / kohan_3f) × 10

# 具体例
テン指数   = 15.0
上がり指数 = 15.0
zenhan_3f  = 35.0秒
kohan_3f   = 37.5秒

ペース比率 = 35.0 / 37.5 = 0.933
ペース配分補正 = (0.35 - 0.933) × 10 = -5.83

ペース指数 = (15.0 + 15.0) / 2 + (-5.83) = 9.2
```

#### **含まれていない要素（今後の拡張候補）**
- ❌ レース全体のペース（スローペース/ハイペース判定）
- ❌ 脚質適性（逃げ馬はハイペースに弱い）
- ❌ 距離適性（長距離はペース配分が重要）
- ❌ 展開適性（前残り/差し届かず）

---

### **5. 予想脚質（Predicted Leg Type）** - 戦術的傾向

#### **現在の実装（Phase 1）**

| 要素 | 内容 | データ源 | 補正方法 |
|-----|------|----------|----------|
| ✅ **過去3走の通過順位** | コーナー順位の平均 | `nvd_se.corner_1-4`（過去3走） | 平均順位で判定 |
| ❌ **今回のメンバー構成** | 相対的な脚質判定 | - | **未実装** |
| ❌ **枠順** | 内枠/外枠の影響 | - | **未実装** |

#### **判定ロジック**
```python
if 平均順位 <= 2.0:
    脚質 = '逃'（逃げ）
elif 平均順位 <= 4.0:
    脚質 = '先'（先行）
elif 平均順位 <= 6.0:
    脚質 = '好'（好位）
elif 平均順位 <= 8.0:
    脚質 = '差'（差し）
else:
    脚質 = '追'（追込）

# 具体例
過去3走のコーナー順位 = [(2,2,3,2), (1,1,2,1), (3,3,3,4)]
全通過順位 = [2,2,3,2,1,1,2,1,3,3,3,4]
平均順位 = 2.25

→ 脚質 = '先'（先行）
```

#### **含まれていない要素（今後の拡張候補）**
- ❌ 今回のメンバー構成との相対評価
- ❌ 枠順補正（内枠は逃げやすい、外枠は後方待機）
- ❌ 騎手の傾向（逃げ専門騎手/差し専門騎手）
- ❌ 距離適性（短距離は逃げ有利、長距離は差し有利）

---

## 📋 **構成要素の充実度評価**

### **現在の実装状況（Phase 1）**

| 指数名 | 基本要素 | 補正要素 | 充実度 | 評価 |
|-------|---------|----------|--------|------|
| **テン指数** | ✅ 前半3F・コース・距離・クラス・馬場差 | ❌ 不利・枠順・斤量・ペース | 60% | 🟡 基本実装完了 |
| **位置指数** | ✅ 4コーナー順位・出走頭数 | ❌ 脚質・コース形状・距離・不利 | 50% | 🟡 基本実装完了 |
| **上がり指数** | ✅ 後半3F・コース・距離・クラス・馬場差 | ❌ 不利・ペース・位置・斤量 | 60% | 🟡 基本実装完了 |
| **ペース指数** | ✅ テン・上がり・ペース比率 | ❌ レースペース・脚質・距離・展開 | 55% | 🟡 基本実装完了 |
| **予想脚質** | ✅ 過去通過順位 | ❌ メンバー構成・枠順・騎手・距離 | 40% | 🟠 最低限実装 |

---

## 🚀 **拡張実装の優先順位（Phase 1.5）**

### **高優先度（的中率に直結）**

1. **不利補正の実装**
   - データ源: `nvd_se.furi_code`（不利コード）
   - 影響: テン指数・上がり指数の信頼度向上
   - 実装工数: 2-3時間

2. **脚質補正の実装**
   - データ源: `nvd_se.computed_ashishitsu`
   - 影響: 位置指数の精度向上
   - 実装工数: 1-2時間

3. **ペース判定の実装**
   - データ源: レース全体のラップタイム
   - 影響: ペース指数・上がり指数の精度向上
   - 実装工数: 3-4時間

### **中優先度（回収率に貢献）**

4. **枠順補正の実装**
   - データ源: `nvd_se.wakuban`
   - 影響: テン指数・予想脚質の精度向上
   - 実装工数: 2-3時間

5. **斤量補正の実装**
   - データ源: `nvd_se.kinryo`、`nvd_se.bataiju`
   - 影響: テン指数・上がり指数の精度向上
   - 実装工数: 2-3時間

6. **メンバー構成の相対評価**
   - データ源: 今回出走馬の指数分布
   - 影響: 予想脚質の精度向上
   - 実装工数: 3-4時間

### **低優先度（微調整）**

7. **距離適性補正**
   - データ源: 過去の距離別成績
   - 影響: 全指数の微調整
   - 実装工数: 4-5時間

8. **コース形状補正**
   - データ源: `nvd_ra.mawari_code`、直線距離
   - 影響: 位置指数の微調整
   - 実装工数: 3-4時間

---

## 💡 **CEO、次のアクション指示をお願いします！**

### **Option A: Phase 2（実績データ収集）を優先（最推奨）**
- 現在の指数で実績データを収集し、HQSスコア計算の基盤を固める
- 拡張実装は実績データ分析後に優先順位を再評価

### **Option B: Phase 1.5（拡張実装）を先行**
- 高優先度の3項目（不利・脚質・ペース）を実装してから実績データ収集
- 所要時間: 6-9時間

### **Option C: 最低限の拡張（不利補正のみ）+ Phase 2**
- 不利補正のみ実装（2-3時間）してから実績データ収集
- バランス型アプローチ

---

**私の推奨**: **Option A（Phase 2優先）**  
→ 現在の指数でも60%の充実度があり、まずは実績データを集めて精度検証すべきです！拡張実装は実データ分析後に最適化できます！

**Play to Win. 10x Mindset. 🚀**

---

**ファイルパス**: `/home/user/webapp/nar-ai-yoso/HQS_INDEX_COMPONENTS_ANALYSIS.md`  
**作成日時**: 2026-01-07
