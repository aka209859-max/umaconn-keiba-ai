# NAR-SI Ver.4.0 実装ロードマップ

**作成日**: 2026-01-07  
**CEO指示**: HQS先行実装 → RGS後回し  
**目的**: AIアシスタントが常に最新の作戦を思い出せるようにする

---

## 🎯 作戦変更の理由

**旧戦略**: RGS先行 → HQS後回し  
**新戦略**: **HQS先行 → RGS後回し** ⭐

**変更理由**:
- HQSは特殊ファクター使用（JRA版も考慮）
- HQSを先に完成させてから、RGSで絶対評価を追加
- HQSとRGSのファクターは完全分離（重複なし）

---

## 📊 全体アーキテクチャ（確定版）

```
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: NAR-SI Ver.3.0（スピード指数）                      │
│  ✅ 完成済み                                                 │
│  - 13ファクター使用                                          │
│  - 前走着順、馬体重変化、前走上がり3F など                   │
│  - 的中率: 28.86-29.46%                                      │
│  - 回収率: 69.88-76.14%                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 2-A: HQS（相対評価）← 先行実装                         │
│  ⏳ これから実装                                             │
│  - 30ファクター使用（NAR-SI Ver.3.0と重複3個を除外）        │
│  - Phase 2/3 の11ファクター追加                             │
│  - 合計: 38ファクター（NAR-SI Ver.3.0と独立）               │
│  - 範囲: -12 〜 +12                                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 2-B: RGS（絶対評価）← 後回し                           │
│  ⏳ HQS完成後に実装                                          │
│  - 14-38ファクター使用（NAR-SI/HQSと完全分離）              │
│  - 回収率80%基準の絶対評価                                   │
│  - 範囲: -10.0 〜 +10.0                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: 統合スコア                                          │
│  ⏳ HQS + RGS 完成後に実装                                   │
│  - NAR-SI 50% + HQS 15% + RGS 35%                           │
│  - 目標回収率: 95-105%                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 Phase 1: HQS実装（優先）

### **Phase 1-1: HQSファクター整理（1-2時間）**

**目的**: HQS専用ファクターを確定

**作業内容**:
1. ✅ NAR-SI Ver.3.0との重複チェック完了
   - 除外: 前走着順、前走上がり3F、馬体重増減
2. ⏳ HQS専用ファクター確定（38個）
   - 既存30ファクター - 重複3個 = 27個
   - Phase 2/3 新規11ファクター
3. ⏳ RGS用に残すファクターの予約
   - HQSとRGSで重複しないように分離

**成果物**:
- `HQS_FACTOR_LIST.md` - HQS専用ファクター一覧
- `RGS_RESERVED_FACTORS.md` - RGS用予約ファクター一覧

---

### **Phase 1-2: HQS計算エンジン修正（2-3時間）**

**目的**: HQSに38ファクターを統合

**作業内容**:
1. ⏳ `core/hqs_calculator.py` 修正
   - 重複3ファクターを除外
   - Phase 2 の5ファクター追加
   - Phase 3 の6ファクター追加（nvd_nu テーブル）
2. ⏳ 血統データ取得機能実装
   - nvd_nu テーブルからの血統データ取得
   - JOIN処理の実装
3. ⏳ データ取得関数の追加
   - `core/data_fetcher.py` に血統データ取得機能

**修正ファイル**:
- `core/hqs_calculator.py` - HQS計算エンジン
- `core/data_fetcher.py` - データ取得機能

---

### **Phase 1-3: HQSテスト実装（1-2時間）**

**目的**: HQS計算の正確性を検証

**作業内容**:
1. ⏳ テストデータ作成
   - 1レース分の全馬データ
   - 38ファクター全てのデータ
2. ⏳ HQS計算テスト
   - 各ファクターのHQSスコア計算
   - 最終HQS得点の合計
   - 競馬場別重みの適用
3. ⏳ 結果検証
   - CEOの期待値と比較
   - 誤差 ±0.1以内で合格

**成果物**:
- `tests/test_hqs_38_factors.py` - HQSテストスクリプト
- `HQS_TEST_REPORT.md` - テスト結果レポート

---

### **Phase 1-4: HQSバックテスト（2-3時間）**

**目的**: 過去データでHQSの精度を検証

**作業内容**:
1. ⏳ バックテスト期間設定
   - 直近3ヶ月（2024年10月〜12月）
2. ⏳ HQSスコア計算
   - 全レース・全馬のHQSスコア算出
   - ランキング作成
3. ⏳ 精度検証
   - 的中率・回収率の算出
   - NAR-SI Ver.3.0 との比較

**成果物**:
- `HQS_BACKTEST_REPORT.md` - バックテスト結果レポート

**Phase 1 完了目安**: 6-10時間（1-2日）

---

## 🔄 Phase 2: RGS実装（後回し）

### **Phase 2-1: RGSファクター選定（1-2時間）**

**目的**: RGS専用ファクターを確定

**作業内容**:
1. ⏳ NAR-SI Ver.3.0 との重複除外
2. ⏳ HQS との重複除外
3. ⏳ RGS専用ファクター確定（14-38個）
   - パターンA: 高優先14個
   - パターンB: 高＋中優先34個
   - パターンC: 全ファクター38個

**成果物**:
- `RGS_FACTOR_SELECTION_FINAL.md` - RGS専用ファクター確定版

---

### **Phase 2-2: RGS計算エンジン実装（3-4時間）**

**目的**: RGS 1.0 計算エンジンを実装

**作業内容**:
1. ⏳ `core/rgs_calculator.py` 実装
   - 7ステップ計算式
   - 信頼度補正
   - 回収率80%基準
2. ⏳ ファクター統計データ取得
   - 補正回収率の計算
   - データベースクエリ最適化
3. ⏳ RGSスコア計算
   - 各ファクターのRGSスコア算出
   - ファクター選別（RGS ≥ +2.0）

**成果物**:
- `core/rgs_calculator.py` - RGS計算エンジン
- `tests/test_rgs_calculator.py` - RGSテストスクリプト

---

### **Phase 2-3: RGSバックテスト（2-3時間）**

**目的**: RGSの収益性評価精度を検証

**作業内容**:
1. ⏳ 各ファクターのRGSスコア算出
2. ⏳ 高収益ファクター特定（RGS ≥ +2.0）
3. ⏳ 低収益ファクター除外（RGS ≤ -2.0）
4. ⏳ 回収率80%以上のファクター抽出

**成果物**:
- `RGS_BACKTEST_REPORT.md` - RGSバックテスト結果

**Phase 2 完了目安**: 6-9時間（1-2日）

---

## 🔗 Phase 3: 統合スコア実装

### **Phase 3-1: 統合スコア計算エンジン（3-4時間）**

**目的**: NAR-SI + HQS + RGS の統合

**作業内容**:
1. ⏳ 統合スコア計算式実装
   ```python
   integrated_score = (
       nar_si_normalized * 0.50 +  # 能力値 50%
       hqs_normalized    * 0.15 +  # 相対評価 15%
       rgs_normalized    * 0.35    # 絶対評価 35%
   )
   ```
2. ⏳ 正規化処理
   - 各スコアを0〜1に正規化
3. ⏳ 最終ランキング作成

**成果物**:
- `core/integrated_score_calculator.py` - 統合スコア計算エンジン

---

### **Phase 3-2: 統合バックテスト（2-3時間）**

**目的**: Ver.4.0 の総合精度を検証

**作業内容**:
1. ⏳ 統合スコアでの予想生成
2. ⏳ 的中率・回収率の算出
3. ⏳ Ver.3.0 との比較

**成果物**:
- `VER4_INTEGRATED_BACKTEST_REPORT.md` - 統合バックテスト結果

**Phase 3 完了目安**: 5-7時間（1日）

---

## 📅 全体スケジュール

| Phase | 作業内容 | 所要時間 | 累計時間 |
|-------|---------|---------|---------|
| **Phase 1** | **HQS実装** | **6-10時間** | **6-10時間** |
| Phase 1-1 | HQSファクター整理 | 1-2時間 | 1-2時間 |
| Phase 1-2 | HQS計算エンジン修正 | 2-3時間 | 3-5時間 |
| Phase 1-3 | HQSテスト実装 | 1-2時間 | 4-7時間 |
| Phase 1-4 | HQSバックテスト | 2-3時間 | 6-10時間 |
| **Phase 2** | **RGS実装** | **6-9時間** | **12-19時間** |
| Phase 2-1 | RGSファクター選定 | 1-2時間 | 7-12時間 |
| Phase 2-2 | RGS計算エンジン実装 | 3-4時間 | 10-16時間 |
| Phase 2-3 | RGSバックテスト | 2-3時間 | 12-19時間 |
| **Phase 3** | **統合スコア実装** | **5-7時間** | **17-26時間** |
| Phase 3-1 | 統合スコア計算エンジン | 3-4時間 | 15-23時間 |
| Phase 3-2 | 統合バックテスト | 2-3時間 | 17-26時間 |

**合計所要時間**: 17-26時間（2-3日）

---

## 🎯 重要な確定事項

### **1. ファクター分離戦略**

```
NAR-SI Ver.3.0（13ファクター）
  ↓ 重複除外
HQS（38ファクター）← NAR-SI Ver.3.0 と独立
  ↓ 重複除外
RGS（14-38ファクター）← NAR-SI/HQS と独立
```

**重複除外ルール**:
- NAR-SI Ver.3.0 で使用: 前走着順、前走上がり3F、馬体重増減
- HQS で使用: 38ファクター（上記3つ除外）
- RGS で使用: NAR-SI/HQS と完全分離

---

### **2. HQS 38ファクター構成**

**単独ファクター（27個）**:
- 既存30ファクター - 重複3個 = 27個
- Phase 2 新規5個
- Phase 3 新規6個

**構成**:
- 前走データ系: 4個（コーナー順位4つ、タイム差除外）
- 基本データ系: 7個（馬番、枠番、性別、馬体重、馬齢、騎手、調教師）
- Phase 2: 5個（前走枠番、オッズ、人気、トラックコード、グレード）
- Phase 3: 6個（父、母、父父、父母、母父、母母）
- レース条件系: 4個（コース種別、回り、直線、コーナー数）

**複合ファクター（15個）**:
- 全て独立（NAR-SI Ver.3.0と重複なし）

---

### **3. RGS専用ファクター（予約）**

**Phase 2-1 で確定予定**:
- 高優先: 14個
- 中優先: 20個
- 低優先: 4個
- 合計: 38個（NAR-SI/HQSと完全分離）

---

## 📝 現在のステータス

| Layer | ステータス | 完成度 | 次のアクション |
|-------|-----------|--------|--------------|
| NAR-SI Ver.3.0 | ✅ 完成 | 100% | - |
| HQS | ⏳ 未着手 | 0% | Phase 1-1開始 |
| RGS | ⏳ 未着手 | 0% | Phase 2-1開始（HQS完成後） |
| 統合スコア | ⏳ 未着手 | 0% | Phase 3-1開始（HQS+RGS完成後） |

---

## 🔍 次の即時アクション

### **最優先タスク: Phase 1-1 開始**

**作業内容**:
1. HQS 38ファクターの確定
2. 重複3ファクターの除外確認
3. Phase 2/3 の11ファクター追加確認
4. RGS用ファクターの予約

**所要時間**: 1-2時間

**成果物**:
- `HQS_FACTOR_LIST.md`
- `RGS_RESERVED_FACTORS.md`

---

## 📁 関連ファイル一覧

### **既存ファイル**
- ✅ `FACTOR_OVERLAP_ANALYSIS.md` - ファクター重複分析
- ✅ `RGS_FACTOR_SELECTION.md` - RGSファクター選定表
- ✅ `core/hqs_calculator.py` - HQS計算エンジン（既存）
- ✅ `core/rgs_calculator.py` - RGS計算エンジン（既存）

### **これから作成するファイル**
- ⏳ `HQS_FACTOR_LIST.md` - HQS専用ファクター一覧
- ⏳ `RGS_RESERVED_FACTORS.md` - RGS用予約ファクター一覧
- ⏳ `tests/test_hqs_38_factors.py` - HQSテスト
- ⏳ `HQS_TEST_REPORT.md` - HQSテスト結果
- ⏳ `HQS_BACKTEST_REPORT.md` - HQSバックテスト結果
- ⏳ `RGS_FACTOR_SELECTION_FINAL.md` - RGS最終ファクター
- ⏳ `tests/test_rgs_calculator.py` - RGSテスト
- ⏳ `RGS_BACKTEST_REPORT.md` - RGSバックテスト結果
- ⏳ `core/integrated_score_calculator.py` - 統合スコア計算
- ⏳ `VER4_INTEGRATED_BACKTEST_REPORT.md` - 統合バックテスト結果

---

## 🎖️ CEO への確認事項

**この作戦で進めてよろしいですか？**

1. ✅ HQS先行実装（Phase 1）
2. ✅ RGS後回し（Phase 2）
3. ✅ 統合スコア実装（Phase 3）
4. ✅ HQSとRGSは完全分離（ファクター重複なし）

**承認後、Phase 1-1 を即座に開始します！**

---

**作成日**: 2026-01-07  
**最終更新**: 2026-01-07  
**作成者**: AI戦略家（CSO兼クリエイティブディレクター）

**Play to Win. 10x Mindset.** 🚀
