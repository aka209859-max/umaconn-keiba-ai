# 🚀 NAR AI予想システム - 本番運用マニュアル

**本番運用開始日: 2025-01-04**

---

## 📋 目次

1. [毎日の実行手順](#毎日の実行手順)
2. [実行前チェックリスト](#実行前チェックリスト)
3. [トラブルシューティング](#トラブルシューティング)
4. [FAQ（よくある質問）](#faqよくある質問)
5. [緊急時の対応](#緊急時の対応)

---

## 🎯 毎日の実行手順

### Step 1: 実行環境の確認

```bash
# データベースが起動しているか確認
# PostgreSQLサービスが起動していることを確認

# プロジェクトディレクトリに移動
cd E:\UmaData\nar-analytics-python
```

### Step 2: 予想の実行

**方法A: バッチファイルで実行（最も簡単）**

```batch
# 明日の予想を自動生成
run_prediction.bat

# 特定の日付を指定する場合
run_prediction.bat 20250105
```

**方法B: コマンドラインで実行**

```bash
# 明日の予想を生成
python main.py

# 特定の日付を指定
python main.py --date 20250105
```

### Step 3: 出力ファイルの確認

```
E:\UmaData\nar-analytics-python\output\20250105\
├── 20250105_大井_予想.txt   ✅ 生成成功
├── 20250105_川崎_予想.txt   ✅ 生成成功
└── 20250105_浦和_予想.txt   ✅ 生成成功
```

**確認ポイント:**
- ファイルが3つ生成されているか？
- ファイルサイズが0バイトではないか？
- 各ファイルを開いて、レース予想が正しく出力されているか？

### Step 4: 予想の活用

1. **各競馬場のTXTファイルを開く**
2. **上位5頭を確認** (AAS得点が高い順)
3. **ランク（SS/S/A/B）を参考に投票**

---

## ✅ 実行前チェックリスト

毎日の実行前に、以下を確認してください：

### 必須チェック項目

- [ ] **PostgreSQLサービスが起動している**
  - タスクマネージャー → サービス → postgresql-x64-14 が「実行中」
  
- [ ] **データベースに最新データが格納されている**
  - 前日までのレース結果が `nvd_se` テーブルに登録されているか
  
- [ ] **プロジェクトディレクトリが正しい**
  - `E:\UmaData\nar-analytics-python` に移動しているか

### 推奨チェック項目

- [ ] **ディスク容量が十分にある**
  - `output\` フォルダが肥大化していないか（古いファイルを削除）
  
- [ ] **DB接続テストを実行**
  ```bash
  python test_connection.py
  ```

---

## 🛠 トラブルシューティング

### 問題1: `ModuleNotFoundError: No module named 'psycopg2'`

**原因**: 依存パッケージがインストールされていない

**解決方法**:
```bash
cd E:\UmaData\nar-analytics-python
pip install -r requirements.txt
```

---

### 問題2: `psycopg2.OperationalError: could not connect to server`

**原因**: PostgreSQLサービスが起動していない

**解決方法**:
1. **Windowsサービスを起動**
   - `Win + R` → `services.msc` → Enter
   - `postgresql-x64-14` を探す
   - 右クリック → 「開始」

2. **手動でサービス起動**
   ```bash
   net start postgresql-x64-14
   ```

---

### 問題3: 出力ファイルが生成されない

**原因**: 対象日のレースデータが存在しない

**解決方法**:
1. **データベースを確認**
   ```sql
   SELECT COUNT(*) FROM nvd_ra 
   WHERE kaisai_nengappi = '20250105';
   ```

2. **日付を変更して再実行**
   ```bash
   python main.py --date 20250106
   ```

---

### 問題4: AAS得点が全て0点になる

**原因**: ファクター統計データが取得できていない

**解決方法**:
1. **Step2テストを実行**
   ```bash
   python test_step2_corrected_return_rate.py
   ```

2. **データベースの期間を確認**
   - 2016年以降のデータが `nvd_se` に存在するか確認

---

### 問題5: `KeyError: 'babajotai_code_dirt'`

**原因**: 列名が存在しない

**解決方法**:
1. **列名を確認**
   ```bash
   python check_ninki_columns.py
   ```

2. **列名を修正**
   - `core/factor_extractor.py` の列名を確認して修正

---

## ❓ FAQ（よくある質問）

### Q1: 予想の実行時間はどれくらいですか？

**A:** 通常、1日分（3競馬場）の予想生成には **3-5分** かかります。

- 大井競馬場: 約1-2分
- 川崎競馬場: 約1-2分
- 浦和競馬場: 約1-2分

---

### Q2: 予想は何時に実行すればいいですか？

**A:** **レース当日の朝** に実行することを推奨します。

- **推奨時間**: 午前8:00-10:00
- **理由**: 最新のオッズ・出走馬データが確定している

---

### Q3: 過去の予想結果を保存しておくべきですか？

**A:** はい、**推奨します**。

- `output\` フォルダ内のファイルは自動的に日付別フォルダに保存されます
- 過去の予想と実際の結果を比較することで、予想精度を検証できます

**保存先例**:
```
output\
├── 20250104\
│   ├── 20250104_大井_予想.txt
│   ├── 20250104_川崎_予想.txt
│   └── 20250104_浦和_予想.txt
├── 20250105\
│   ├── 20250105_大井_予想.txt
│   ├── 20250105_川崎_予想.txt
│   └── 20250105_浦和_予想.txt
```

---

### Q4: AAS得点の見方を教えてください

**A:** AAS得点は **-12点 〜 +12点** の範囲で算出されます。

| ランク | AAS得点範囲 | 評価 |
|--------|------------|------|
| **SS** | ≥ 20点 | **最高評価** - 最も期待値が高い |
| **S** | ≥ 15点 | **高評価** - 期待値が高い |
| **A** | ≥ 10点 | **良好** - 期待値がやや高い |
| **B** | ≥ 5点 | **普通** - 平均以上 |
| **C** | ≥ 0点 | **やや低い** - 平均並み |
| **D** | ≥ -5点 | **低い** - 期待値が低い |
| **E** | ≥ -10点 | **かなり低い** - 期待値がかなり低い |
| **F** | < -10点 | **最低評価** - 最も期待値が低い |

**活用方法**:
- **上位3頭** (1位～3位) を重点的にチェック
- **SSランク** があれば最優先で検討
- **Sランク以上** を中心に投票を検討

---

### Q5: 予想が外れた場合、システムを改善できますか？

**A:** はい、**Phase 2以降で改善予定**です。

Phase 1は **基本システム** です。今後の改善項目：
- ファクター重みの最適化
- 新規ファクターの追加
- オッズ補正係数の再調整
- 馬場状態別の重み調整

---

## 🚨 緊急時の対応

### システムが完全に動かない場合

1. **データベース接続テストを実行**
   ```bash
   python test_connection.py
   ```

2. **エラーメッセージをメモ**
   - エラー内容をコピーして保存

3. **システムを再起動**
   - コマンドプロンプトを閉じる
   - PostgreSQLサービスを再起動
   - 再度実行

4. **それでも解決しない場合**
   - エラーメッセージを共有して相談

---

## 📞 サポート情報

### 重要ファイルの場所

| ファイル名 | 場所 | 役割 |
|----------|------|------|
| `main.py` | プロジェクトルート | メインスクリプト |
| `run_prediction.bat` | プロジェクトルート | 実行バッチファイル |
| `config/db_config.py` | config/ | データベース設定 |
| `core/aas_calculator.py` | core/ | AAS計算ロジック |
| `test_connection.py` | プロジェクトルート | DB接続テスト |

### ログファイルの確認

システムのログは **コマンドプロンプトの出力** に表示されます。

**ログの保存方法**:
```bash
python main.py --date 20250105 > log_20250105.txt 2>&1
```

---

## 🎯 成功の指標

### 毎日確認すべき指標

1. **実行成功率**: 100%（毎日正常に実行できている）
2. **ファイル生成**: 3ファイル（大井・川崎・浦和）
3. **上位馬の的中率**: Phase 2で検証予定

---

## 🏆 Enable憲法の実践

このシステムは、以下のEnable憲法に基づいて運用してください：

- **10x Mindset**: 小さな改善ではなく、10倍の成果を目指す
- **Be Resourceful**: 問題が発生しても、知恵とAIで解決する
- **Play to Win**: 勝つための戦略的な投票を心がける
- **Buy Back Time**: システムで時間を買い、分析に集中する

---

**NAR AI予想システム Phase 1 - 本番運用マニュアル**  
**CEO、Play to Win！🚀**
