# ğŸ¯ å‰èµ°ä¸åˆ©æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: NAR-AI-YOSO å‰èµ°ä¸åˆ©æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ   
**ä½œæˆæ—¥**: 2026-01-07  
**ä½œæˆè€…**: AIæˆ¦ç•¥å®¶ï¼ˆCSOå…¼ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‰  
**ç›®çš„**: åœ°æ–¹ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿ã«ä¸åˆ©ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€çµ±è¨ˆçš„ç•°å¸¸æ¤œçŸ¥ã§ä»£æ›¿ã—ã€HQSæŒ‡æ•°ã¨ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æã«çµ±åˆ

---

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ğŸ¯ ç›®æ¨™
åœ°æ–¹ç«¶é¦¬ã®å‰èµ°ãƒ¬ãƒ¼ã‚¹ã§ç™ºç”Ÿã—ãŸä¸åˆ©ï¼ˆå‡ºé…ã‚Œã€æŒŸã¾ã‚Œã€å¤–å›ã—ç­‰ï¼‰ã‚’çµ±è¨ˆçš„ç•°å¸¸æ¤œçŸ¥ã§è‡ªå‹•æ¤œå‡ºã—ã€æ¬¡èµ°ã®èƒ½åŠ›è©•ä¾¡ã¨ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æã«æ´»ç”¨ã™ã‚‹ã€‚

### ğŸ’¡ æˆ¦ç•¥çš„ä¾¡å€¤
```
å‰èµ°ä¸åˆ©æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
    â†“
å‰èµ°ä¸åˆ©ã‚¹ã‚³ã‚¢ç®—å‡º (prev_trouble_score)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚             â”‚             â”‚
HQSæŒ‡æ•°ã®     æ¬¡èµ°èƒ½åŠ›ã®    ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æ
å‰èµ°ä¸åˆ©è£œæ­£   ãƒ—ãƒ©ã‚¹è©•ä¾¡    (F31: å‰èµ°ä¸åˆ©åº¦)
              ã€Œå®ŸåŠ›ã¯      
              ã‚‚ã£ã¨ä¸Šã€    
```

**å…·ä½“ä¾‹:**
- å‰èµ°ã§å¤§å¤–ã‚’å›ã•ã‚ŒãŸé¦¬ï¼ˆä¸åˆ©ã‚¹ã‚³ã‚¢ 75ï¼‰
- å‰èµ°çµæœ: 8ç€ï¼ˆè¦‹ã‹ã‘ä¸Šæ‚ªã„ï¼‰
- å®ŸåŠ›è©•ä¾¡: ã€Œå®ŸåŠ›ã¯5ç€ç›¸å½“ã€ã¨æ¨å®š
- æ¬¡èµ°è©•ä¾¡: ã€Œå‰èµ°ä¸åˆ©ãŒã‚ã£ãŸã®ã§å®ŸåŠ›ã‚ˆã‚Šæ‚ªãè¦‹ãˆã‚‹ â†’ æ¬¡èµ°ã§å·»ãè¿”ã—æœŸå¾…ã€
- HQSä¸ŠãŒã‚ŠæŒ‡æ•°: +1.5ç§’è£œæ­£ï¼ˆä¸åˆ©ãŒãªã‘ã‚Œã°ã‚‚ã£ã¨é€Ÿã‹ã£ãŸï¼‰

---

## ğŸ—ºï¸ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: å‰èµ°ä¸åˆ©æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ï¼ˆ8-12æ™‚é–“ï¼‰

#### Step 1-1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆ1æ™‚é–“ï¼‰

**æˆæœç‰©**: `trouble_detection.sql`

```sql
-- å‰èµ°ä¸åˆ©æ¤œçŸ¥çµæœä¿å­˜ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS nar_trouble_estimated (
    ketto_toroku_bango VARCHAR(10) NOT NULL,
    race_date VARCHAR(8) NOT NULL,        -- å‰èµ°ã®æ—¥ä»˜ï¼ˆYYYYMMDDï¼‰
    keibajo_code VARCHAR(2) NOT NULL,
    race_bango INTEGER NOT NULL,
    trouble_score DECIMAL(5,2) NOT NULL,  -- 0-100ã®ä¸åˆ©åº¦ã‚¹ã‚³ã‚¢
    trouble_type VARCHAR(20) NOT NULL,    -- slow_start/rank_reversal/mixed
    confidence DECIMAL(3,2) NOT NULL,     -- 0.00-1.00ã®æ¤œçŸ¥ä¿¡é ¼åº¦
    detection_method VARCHAR(50),          -- MAD/rank_reversal/ensemble
    raw_z_score DECIMAL(5,2),             -- ç”Ÿã®Zã‚¹ã‚³ã‚¢
    rank_std DECIMAL(5,2),                -- é †ä½å¤‰å‹•ã®æ¨™æº–åå·®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ketto_toroku_bango, race_date, keibajo_code, race_bango)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_trouble_score ON nar_trouble_estimated(trouble_score DESC);
CREATE INDEX idx_race_lookup ON nar_trouble_estimated(race_date, keibajo_code, race_bango);
CREATE INDEX idx_ketto_lookup ON nar_trouble_estimated(ketto_toroku_bango, race_date);

-- å‰èµ°ä¸åˆ©ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ãƒ“ãƒ¥ãƒ¼
CREATE OR REPLACE VIEW v_nvd_se_with_prev_trouble AS
SELECT 
    se.*,
    te.trouble_score as prev_trouble_score,
    te.trouble_type as prev_trouble_type,
    te.confidence as prev_trouble_confidence,
    te.detection_method as prev_trouble_method
FROM nvd_se se
LEFT JOIN nar_trouble_estimated te ON
    te.ketto_toroku_bango = se.ketto_toroku_bango
    AND te.race_date = se.prev_race_date
    AND te.keibajo_code = se.prev_keibajo_code
    AND te.race_bango = se.prev_race_bango;
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] PostgreSQLã§ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
- [ ] ãƒ“ãƒ¥ãƒ¼ä½œæˆ
- [ ] æ¥ç¶šãƒ†ã‚¹ãƒˆ

---

#### Step 1-2: Modified Z-score (MAD) å‡ºé…ã‚Œæ¤œçŸ¥ï¼ˆ3æ™‚é–“ï¼‰

**æˆæœç‰©**: `nar_trouble_detection.py` (å‡ºé…ã‚Œæ¤œçŸ¥éƒ¨åˆ†)

**ç†è«–**: TXT 4.1ç¯€ã€ŒModified Z-score (MADæ³•)ã€
- ãƒ†ãƒ³3Fç›¸å½“ã‚¿ã‚¤ãƒ  = èµ°ç ´ã‚¿ã‚¤ãƒ  - ä¸ŠãŒã‚Š3F
- ãƒ¬ãƒ¼ã‚¹å†…ã§ã®ç›¸å¯¾çš„ãªé…ã‚Œã‚’æ¤œçŸ¥
- Modified Z-score > 3.5 ã§å‡ºé…ã‚Œåˆ¤å®š

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
import numpy as np
from scipy import stats
import logging

logger = logging.getLogger(__name__)

class TroubleDetector:
    def __init__(self, db_connection):
        self.conn = db_connection
    
    def detect_slow_start(self, race_horses):
        """
        å‡ºé…ã‚Œæ¤œçŸ¥ï¼ˆMADæ³•ï¼‰
        
        Args:
            race_horses: ãƒ¬ãƒ¼ã‚¹å†…ã®å…¨é¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆlist of dictï¼‰
                - ketto_toroku_bango
                - time (èµ°ç ´ã‚¿ã‚¤ãƒ )
                - kohan_3f (ä¸ŠãŒã‚Š3F)
        
        Returns:
            list of dict: ä¸åˆ©æ¤œçŸ¥çµæœ
        """
        ten_equivalent = []
        
        for horse in race_horses:
            if horse.get('time') and horse.get('kohan_3f'):
                # ãƒ†ãƒ³3Fç›¸å½“ã‚¿ã‚¤ãƒ æ¨å®š
                ten_time = horse['time'] - horse['kohan_3f']
                ten_equivalent.append({
                    'ketto_toroku_bango': horse['ketto_toroku_bango'],
                    'ten_time': ten_time
                })
        
        if len(ten_equivalent) < 5:  # ãƒ‡ãƒ¼ã‚¿ä¸è¶³
            logger.warning(f"ãƒ‡ãƒ¼ã‚¿ä¸è¶³: {len(ten_equivalent)}é ­ã®ã¿")
            return []
        
        # MADè¨ˆç®—ï¼ˆãƒ­ãƒã‚¹ãƒˆçµ±è¨ˆï¼‰
        ten_times = [h['ten_time'] for h in ten_equivalent]
        median = np.median(ten_times)
        mad = np.median([abs(t - median) for t in ten_times])
        
        if mad == 0:
            logger.warning("MAD=0ï¼ˆå…¨é¦¬åŒã˜ã‚¿ã‚¤ãƒ ï¼‰")
            return []
        
        results = []
        
        for horse in ten_equivalent:
            # Modified Z-scoreè¨ˆç®—
            modified_z = 0.6745 * (horse['ten_time'] - median) / mad
            
            if modified_z > 3.5:  # å‡ºé…ã‚Œæ¤œçŸ¥é–¾å€¤
                trouble_score = min(100, modified_z * 20)
                
                results.append({
                    'ketto_toroku_bango': horse['ketto_toroku_bango'],
                    'trouble_type': 'slow_start',
                    'trouble_score': trouble_score,
                    'confidence': 0.85,
                    'detection_method': 'MAD',
                    'raw_z_score': modified_z,
                    'rank_std': None
                })
                
                logger.info(
                    f"å‡ºé…ã‚Œæ¤œçŸ¥: {horse['ketto_toroku_bango']} "
                    f"(Z={modified_z:.2f}, ã‚¹ã‚³ã‚¢={trouble_score:.1f})"
                )
        
        return results
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] MADæ³•ã®å®Ÿè£…
- [ ] Modified Z-scoreè¨ˆç®—
- [ ] é–¾å€¤èª¿æ•´ï¼ˆ3.5ã§é–‹å§‹ã€å¾Œã§æœ€é©åŒ–ï¼‰
- [ ] ãƒ­ã‚°å‡ºåŠ›
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆ10ãƒ¬ãƒ¼ã‚¹åˆ†ï¼‰

---

#### Step 1-3: é †ä½é€†è»¢æ¤œçŸ¥ï¼ˆ3æ™‚é–“ï¼‰

**æˆæœç‰©**: `nar_trouble_detection.py` (é †ä½é€†è»¢æ¤œçŸ¥éƒ¨åˆ†)

**ç†è«–**: TXT 5.1ç¯€ã€Œé †ä½é€†è»¢æ¤œçŸ¥ï¼ˆRank Reversal Detectionï¼‰ã€
- corner_1 â†’ corner_4 ã®é †ä½å¤‰å‹•ã‚’åˆ†æ
- é †ä½æ¨™æº–åå·® > é–¾å€¤ â†’ æŒŸã¾ã‚Œ/å¤–å›ã—
- å‰åŠâ†’å¾ŒåŠã§3é ­ä»¥ä¸Šå¾Œé€€ â†’ ä¸åˆ©åˆ¤å®š

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
def detect_rank_reversal(self, race_horses):
    """
    é †ä½é€†è»¢æ¤œçŸ¥ï¼ˆæŒŸã¾ã‚Œãƒ»å¤–å›ã—ï¼‰
    
    Args:
        race_horses: ãƒ¬ãƒ¼ã‚¹å†…ã®å…¨é¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆlist of dictï¼‰
            - ketto_toroku_bango
            - corner_1, corner_2, corner_3, corner_4 (é€šéé †ä½)
    
    Returns:
        list of dict: ä¸åˆ©æ¤œçŸ¥çµæœ
    """
    results = []
    
    for horse in race_horses:
        corners = [
            horse.get('corner_1'),
            horse.get('corner_2'),
            horse.get('corner_3'),
            horse.get('corner_4')
        ]
        
        # NULLé™¤å¤–ãƒ»æ­£ã®å€¤ã®ã¿
        corners = [c for c in corners if c is not None and c > 0]
        
        if len(corners) < 2:
            continue
        
        # é †ä½å¤‰å‹•ã®æ¨™æº–åå·®
        rank_std = np.std(corners)
        
        # å‰åŠâ†’å¾ŒåŠã§å¤§ããå¾Œé€€
        if len(corners) >= 3:
            early_avg = np.mean(corners[:2])  # 1-2ã‚³ãƒ¼ãƒŠãƒ¼å¹³å‡
            late_avg = np.mean(corners[-2:])  # 3-4ã‚³ãƒ¼ãƒŠãƒ¼å¹³å‡
            rank_decline = late_avg - early_avg
            
            # åˆ¤å®šåŸºæº–:
            # - 3é ­ä»¥ä¸Šå¾Œé€€ AND é †ä½å¤‰å‹•ãŒå¤§ãã„
            if rank_decline > 3 and rank_std > 2.5:
                trouble_score = min(100, rank_decline * 15 + rank_std * 10)
                
                results.append({
                    'ketto_toroku_bango': horse['ketto_toroku_bango'],
                    'trouble_type': 'rank_reversal',
                    'trouble_score': trouble_score,
                    'confidence': 0.80,
                    'detection_method': 'rank_reversal',
                    'raw_z_score': None,
                    'rank_std': rank_std
                })
                
                logger.info(
                    f"é †ä½é€†è»¢æ¤œçŸ¥: {horse['ketto_toroku_bango']} "
                    f"(å¾Œé€€={rank_decline:.1f}é ­, å¤‰å‹•Ïƒ={rank_std:.1f}, "
                    f"ã‚¹ã‚³ã‚¢={trouble_score:.1f})"
                )
        
        # Kendall's Tau ã«ã‚ˆã‚‹ç›¸é–¢æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if len(corners) >= 4:
            expected_order = list(range(1, len(corners) + 1))
            tau, p_value = stats.kendalltau(expected_order, corners)
            
            if tau < -0.3 and p_value < 0.05:  # è² ã®ç›¸é–¢ = é †ä½é€†è»¢
                logger.info(
                    f"Kendall's Tauç•°å¸¸: {horse['ketto_toroku_bango']} "
                    f"(Ï„={tau:.3f}, p={p_value:.3f})"
                )
    
    return results
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] é †ä½å¤‰å‹•ã®æ¨™æº–åå·®è¨ˆç®—
- [ ] å‰åŠâ†’å¾ŒåŠã®é †ä½å¤‰åŒ–åˆ†æ
- [ ] Kendall's Tauæ¤œå®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- [ ] é–¾å€¤èª¿æ•´
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆ10ãƒ¬ãƒ¼ã‚¹åˆ†ï¼‰

---

#### Step 1-4: çµ±åˆã‚¹ã‚³ã‚¢ç®—å‡ºãƒ»ä¿å­˜ï¼ˆ2æ™‚é–“ï¼‰

**æˆæœç‰©**: `nar_trouble_detection.py` (çµ±åˆå‡¦ç†éƒ¨åˆ†)

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
def calculate_integrated_trouble_score(self, slow_start_results, rank_reversal_results):
    """
    è¤‡æ•°ã®ä¸åˆ©æ¤œçŸ¥çµæœã‚’çµ±åˆ
    
    Args:
        slow_start_results: å‡ºé…ã‚Œæ¤œçŸ¥çµæœ
        rank_reversal_results: é †ä½é€†è»¢æ¤œçŸ¥çµæœ
    
    Returns:
        dict: çµ±åˆã•ã‚ŒãŸä¸åˆ©ã‚¹ã‚³ã‚¢ï¼ˆé¦¬ã”ã¨ï¼‰
    """
    integrated = {}
    
    # å‡ºé…ã‚Œã‚¹ã‚³ã‚¢ï¼ˆé‡ã¿ 0.4ï¼‰
    for result in slow_start_results:
        ketto = result['ketto_toroku_bango']
        integrated[ketto] = {
            'trouble_score': result['trouble_score'] * 0.4,
            'trouble_type': 'slow_start',
            'confidence': result['confidence'],
            'detection_method': result['detection_method'],
            'raw_z_score': result['raw_z_score'],
            'rank_std': None
        }
    
    # é †ä½é€†è»¢ã‚¹ã‚³ã‚¢ï¼ˆé‡ã¿ 0.6ï¼‰
    for result in rank_reversal_results:
        ketto = result['ketto_toroku_bango']
        
        if ketto in integrated:
            # ä¸¡æ–¹ã®ä¸åˆ©ãŒã‚ã‚‹å ´åˆ
            integrated[ketto]['trouble_score'] += result['trouble_score'] * 0.6
            integrated[ketto]['trouble_type'] = 'mixed'
            integrated[ketto]['confidence'] = (
                integrated[ketto]['confidence'] + result['confidence']
            ) / 2
            integrated[ketto]['detection_method'] = 'ensemble'
            integrated[ketto]['rank_std'] = result['rank_std']
        else:
            integrated[ketto] = {
                'trouble_score': result['trouble_score'] * 0.6,
                'trouble_type': 'rank_reversal',
                'confidence': result['confidence'],
                'detection_method': result['detection_method'],
                'raw_z_score': None,
                'rank_std': result['rank_std']
            }
    
    return integrated

def save_trouble_data(self, race_info, trouble_results):
    """
    ä¸åˆ©æ¤œçŸ¥çµæœã‚’DBã«ä¿å­˜
    
    Args:
        race_info: ãƒ¬ãƒ¼ã‚¹æƒ…å ±ï¼ˆæ—¥ä»˜ã€å ´æ‰€ç­‰ï¼‰
        trouble_results: çµ±åˆã•ã‚ŒãŸä¸åˆ©ã‚¹ã‚³ã‚¢
    """
    query = """
        INSERT INTO nar_trouble_estimated (
            ketto_toroku_bango,
            race_date,
            keibajo_code,
            race_bango,
            trouble_score,
            trouble_type,
            confidence,
            detection_method,
            raw_z_score,
            rank_std
        ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        ON CONFLICT (ketto_toroku_bango, race_date, keibajo_code, race_bango)
        DO UPDATE SET
            trouble_score = EXCLUDED.trouble_score,
            trouble_type = EXCLUDED.trouble_type,
            confidence = EXCLUDED.confidence,
            detection_method = EXCLUDED.detection_method,
            raw_z_score = EXCLUDED.raw_z_score,
            rank_std = EXCLUDED.rank_std,
            created_at = CURRENT_TIMESTAMP
    """
    
    cursor = self.conn.cursor()
    
    for ketto, result in trouble_results.items():
        cursor.execute(query, [
            ketto,
            race_info['race_date'],
            race_info['keibajo_code'],
            race_info['race_bango'],
            result['trouble_score'],
            result['trouble_type'],
            result['confidence'],
            result['detection_method'],
            result['raw_z_score'],
            result['rank_std']
        ])
    
    self.conn.commit()
    logger.info(
        f"ä¸åˆ©ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: {race_info['race_date']} "
        f"{race_info['keibajo_code']}{race_info['race_bango']}R "
        f"({len(trouble_results)}é ­)"
    )
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] çµ±åˆã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆé‡ã¿ä»˜ã‘ï¼‰
- [ ] DBä¿å­˜å‡¦ç†
- [ ] UPSERTï¼ˆé‡è¤‡æ™‚ã¯æ›´æ–°ï¼‰
- [ ] ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

---

#### Step 1-5: ãƒãƒƒãƒå‡¦ç†ãƒ»éå»ãƒ‡ãƒ¼ã‚¿åˆ†æï¼ˆ3æ™‚é–“ï¼‰

**æˆæœç‰©**: `batch_process_trouble_detection.py`

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
#!/usr/bin/env python3
"""
å‰èµ°ä¸åˆ©æ¤œçŸ¥ãƒãƒƒãƒå‡¦ç†
éå»3å¹´åˆ†ã®ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ä¸åˆ©ã‚’æ¤œçŸ¥
"""

import psycopg2
from psycopg2.extras import RealDictCursor
from nar_trouble_detection import TroubleDetector
import logging
from datetime import datetime, timedelta

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def get_db_connection():
    """DBæ¥ç¶š"""
    return psycopg2.connect(
        host="localhost",
        database="nardb",
        user="nartora_user",
        password="your_password",
        cursor_factory=RealDictCursor
    )

def fetch_race_data(conn, start_date, end_date):
    """
    éå»ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—
    
    Args:
        conn: DBæ¥ç¶š
        start_date: é–‹å§‹æ—¥ï¼ˆYYYYMMDDï¼‰
        end_date: çµ‚äº†æ—¥ï¼ˆYYYYMMDDï¼‰
    
    Returns:
        list: ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    """
    query = """
        SELECT 
            se.ketto_toroku_bango,
            se.kaisai_nen || se.kaisai_tsukihi as race_date,
            se.keibajo_code,
            ra.race_bango,
            se.corner_1,
            se.corner_2,
            se.corner_3,
            se.corner_4,
            se.kohan_3f,
            se.time,
            ra.kyori,
            ra.tosu
        FROM nvd_se se
        JOIN nvd_ra ra ON 
            se.keibajo_code = ra.keibajo_code
            AND se.kaisai_nen = ra.kaisai_nen
            AND se.kaisai_tsukihi = ra.kaisai_tsukihi
            AND se.race_bango = ra.race_bango
        WHERE se.kaisai_nen || se.kaisai_tsukihi BETWEEN %s AND %s
            AND se.kakutei_chakujun IS NOT NULL
            AND se.time IS NOT NULL
        ORDER BY race_date, keibajo_code, race_bango
    """
    
    cursor = conn.cursor()
    cursor.execute(query, [start_date, end_date])
    return cursor.fetchall()

def group_by_race(race_data):
    """ãƒ¬ãƒ¼ã‚¹å˜ä½ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–"""
    races = {}
    
    for row in race_data:
        key = (row['race_date'], row['keibajo_code'], row['race_bango'])
        
        if key not in races:
            races[key] = {
                'race_date': row['race_date'],
                'keibajo_code': row['keibajo_code'],
                'race_bango': row['race_bango'],
                'horses': []
            }
        
        races[key]['horses'].append(row)
    
    return list(races.values())

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    # éå»3å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
    end_date = datetime.now().strftime('%Y%m%d')
    start_date = (datetime.now() - timedelta(days=365*3)).strftime('%Y%m%d')
    
    logger.info(f"å‰èµ°ä¸åˆ©æ¤œçŸ¥ãƒãƒƒãƒé–‹å§‹: {start_date} - {end_date}")
    
    conn = get_db_connection()
    detector = TroubleDetector(conn)
    
    try:
        # ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—
        logger.info("ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...")
        race_data = fetch_race_data(conn, start_date, end_date)
        logger.info(f"å–å¾—ä»¶æ•°: {len(race_data)}ä»¶")
        
        # ãƒ¬ãƒ¼ã‚¹å˜ä½ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        races = group_by_race(race_data)
        logger.info(f"ãƒ¬ãƒ¼ã‚¹æ•°: {len(races)}ãƒ¬ãƒ¼ã‚¹")
        
        # ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«ä¸åˆ©æ¤œçŸ¥
        processed = 0
        detected = 0
        
        for race in races:
            # å‡ºé…ã‚Œæ¤œçŸ¥
            slow_start_results = detector.detect_slow_start(race['horses'])
            
            # é †ä½é€†è»¢æ¤œçŸ¥
            rank_reversal_results = detector.detect_rank_reversal(race['horses'])
            
            # çµ±åˆã‚¹ã‚³ã‚¢ç®—å‡º
            trouble_results = detector.calculate_integrated_trouble_score(
                slow_start_results, 
                rank_reversal_results
            )
            
            # DBä¿å­˜
            if trouble_results:
                detector.save_trouble_data(race, trouble_results)
                detected += len(trouble_results)
            
            processed += 1
            
            if processed % 100 == 0:
                logger.info(f"å‡¦ç†é€²æ—: {processed}/{len(races)}ãƒ¬ãƒ¼ã‚¹")
        
        logger.info(f"å‡¦ç†å®Œäº†: {processed}ãƒ¬ãƒ¼ã‚¹, {detected}ä»¶ã®ä¸åˆ©æ¤œçŸ¥")
        
    finally:
        conn.close()

if __name__ == '__main__':
    main()
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] éå»3å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¯ã‚¨ãƒª
- [ ] ãƒ¬ãƒ¼ã‚¹å˜ä½ã§ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
- [ ] ãƒãƒƒãƒå‡¦ç†ãƒ«ãƒ¼ãƒ—
- [ ] é€²æ—ãƒ­ã‚°å‡ºåŠ›
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] å®Ÿè¡Œï¼ˆç´„2-3æ™‚é–“ï¼‰

---

### Phase 2: HQSæŒ‡æ•°ã¸ã®çµ±åˆï¼ˆ2-3æ™‚é–“ï¼‰

#### Step 2-1: å‰èµ°ä¸åˆ©è£œæ­£é–¢æ•°ã®å®Ÿè£…ï¼ˆ1æ™‚é–“ï¼‰

**æˆæœç‰©**: `core/index_calculator.py` (å‰èµ°ä¸åˆ©è£œæ­£éƒ¨åˆ†)

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
def get_prev_trouble_correction(conn, ketto_toroku_bango, prev_race_date, 
                                prev_keibajo_code, prev_race_bango):
    """
    å‰èµ°ã®ä¸åˆ©è£œæ­£ã‚’å–å¾—
    
    Args:
        conn: DBæ¥ç¶š
        ketto_toroku_bango: è¡€çµ±ç™»éŒ²ç•ªå·
        prev_race_date: å‰èµ°æ—¥ä»˜ï¼ˆYYYYMMDDï¼‰
        prev_keibajo_code: å‰èµ°ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰
        prev_race_bango: å‰èµ°ãƒ¬ãƒ¼ã‚¹ç•ªå·
    
    Returns:
        tuple: (è£œæ­£å€¤ï¼ˆç§’ï¼‰, ä¸åˆ©ã‚¿ã‚¤ãƒ—)
    """
    if not all([ketto_toroku_bango, prev_race_date, prev_keibajo_code, prev_race_bango]):
        return 0.0, 'ãªã—'
    
    query = """
        SELECT trouble_score, trouble_type, confidence
        FROM nar_trouble_estimated
        WHERE ketto_toroku_bango = %s
          AND race_date = %s
          AND keibajo_code = %s
          AND race_bango = %s
    """
    
    cursor = conn.cursor()
    cursor.execute(query, [ketto_toroku_bango, prev_race_date, prev_keibajo_code, prev_race_bango])
    result = cursor.fetchone()
    
    if not result:
        return 0.0, 'ãªã—'
    
    trouble_score = result['trouble_score']  # 0-100
    trouble_type = result['trouble_type']
    confidence = result['confidence']
    
    # ã‚¹ã‚³ã‚¢ã‚’è£œæ­£å€¤ï¼ˆç§’ï¼‰ã«å¤‰æ›
    # trouble_score 100 = æœ€å¤§2.0ç§’ã®ãƒ—ãƒ©ã‚¹è£œæ­£
    # å‰èµ°ã§ä¸åˆ©ãŒã‚ã£ãŸ â†’ å®ŸåŠ›ã¯ã‚‚ã£ã¨ä¸Š â†’ æ¬¡èµ°ã®èƒ½åŠ›è©•ä¾¡ã‚’ãƒ—ãƒ©ã‚¹
    correction = (trouble_score / 100) * 2.0 * confidence
    
    logger.info(
        f"å‰èµ°ä¸åˆ©è£œæ­£: {ketto_toroku_bango} "
        f"(ã‚¹ã‚³ã‚¢={trouble_score:.1f}, ã‚¿ã‚¤ãƒ—={trouble_type}, "
        f"è£œæ­£={correction:.2f}ç§’)"
    )
    
    return correction, trouble_type
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] å‰èµ°ä¸åˆ©ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¯ã‚¨ãƒª
- [ ] ã‚¹ã‚³ã‚¢â†’ç§’æ•°å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
- [ ] ä¿¡é ¼åº¦ã®åæ˜ 
- [ ] NULLå‡¦ç†
- [ ] ãƒ­ã‚°å‡ºåŠ›

---

#### Step 2-2: ä¸ŠãŒã‚ŠæŒ‡æ•°ã¸ã®çµ±åˆï¼ˆ1æ™‚é–“ï¼‰

**æˆæœç‰©**: `core/index_calculator.py` (ä¸ŠãŒã‚ŠæŒ‡æ•°è¨ˆç®—éƒ¨åˆ†ã®ä¿®æ­£)

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
def calculate_agari_index_from_prev(conn, prev_kohan_3f, prev_kyori, prev_baba_code, 
                                    prev_keibajo_code,
                                    ketto_toroku_bango=None, 
                                    prev_race_date=None, 
                                    prev_race_bango=None):
    """
    å‰èµ°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¸ŠãŒã‚ŠæŒ‡æ•°ã‚’è¨ˆç®—
    
    Args:
        conn: DBæ¥ç¶š
        prev_kohan_3f: å‰èµ°ä¸ŠãŒã‚Š3F
        prev_kyori: å‰èµ°è·é›¢
        prev_baba_code: å‰èµ°é¦¬å ´ã‚³ãƒ¼ãƒ‰
        prev_keibajo_code: å‰èµ°ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰
        ketto_toroku_bango: è¡€çµ±ç™»éŒ²ç•ªå·ï¼ˆå‰èµ°ä¸åˆ©è£œæ­£ç”¨ï¼‰
        prev_race_date: å‰èµ°æ—¥ä»˜ï¼ˆå‰èµ°ä¸åˆ©è£œæ­£ç”¨ï¼‰
        prev_race_bango: å‰èµ°ãƒ¬ãƒ¼ã‚¹ç•ªå·ï¼ˆå‰èµ°ä¸åˆ©è£œæ­£ç”¨ï¼‰
    
    Returns:
        tuple: (ä¸ŠãŒã‚ŠæŒ‡æ•°, ä¸åˆ©ã‚¿ã‚¤ãƒ—)
    """
    if not prev_kohan_3f or prev_kohan_3f <= 0:
        logger.warning(f"å‰èµ°ä¸ŠãŒã‚Š3Fãƒ‡ãƒ¼ã‚¿ãªã—")
        return 50.0, 'ãªã—'
    
    # åŸºæº–ã‚¿ã‚¤ãƒ å–å¾—
    base_time = get_base_time(prev_keibajo_code, prev_kyori, 'kohan_3f')
    if not base_time:
        logger.warning(f"åŸºæº–ã‚¿ã‚¤ãƒ å–å¾—å¤±æ•—: {prev_keibajo_code} {prev_kyori}m")
        return 50.0, 'ãªã—'
    
    # é¦¬å ´è£œæ­£
    baba_correction = get_baba_correction_value(prev_baba_code)
    
    # å‰èµ°ä¸åˆ©è£œæ­£ï¼ˆNEW!ï¼‰
    trouble_correction, trouble_type = get_prev_trouble_correction(
        conn,
        ketto_toroku_bango, 
        prev_race_date, 
        prev_keibajo_code, 
        prev_race_bango
    )
    
    # æŒ‡æ•°è¨ˆç®—
    # å‰èµ°ã§ä¸åˆ©ãŒã‚ã£ãŸ â†’ å®ŸåŠ›ã¯ã‚‚ã£ã¨ä¸Š â†’ ãƒ—ãƒ©ã‚¹è£œæ­£
    agari_index = ((base_time - prev_kohan_3f) + baba_correction + trouble_correction) * 10
    agari_index = max(-100.0, min(100.0, round(agari_index, 1)))
    
    logger.info(
        f"ä¸ŠãŒã‚ŠæŒ‡æ•° {agari_index} "
        f"(å‰èµ°3F={prev_kohan_3f}s, åŸºæº–={base_time}s, "
        f"é¦¬å ´è£œæ­£={baba_correction}s, "
        f"å‰èµ°ä¸åˆ©è£œæ­£={trouble_correction}s [{trouble_type}])"
    )
    
    return agari_index, trouble_type
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] calculate_agari_index_from_prev é–¢æ•°ã®ä¿®æ­£
- [ ] å‰èµ°ä¸åˆ©è£œæ­£ã®çµ„ã¿è¾¼ã¿
- [ ] ãƒ­ã‚°å‡ºåŠ›ã®è¿½åŠ 
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ

---

#### Step 2-3: ä½ç½®æŒ‡æ•°ã¸ã®çµ±åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€30åˆ†ï¼‰

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
def calculate_position_index_from_prev(prev_corner_1, prev_corner_2, prev_corner_3, 
                                       prev_corner_4, prev_tosu,
                                       prev_trouble_score=0):
    """
    å‰èµ°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä½ç½®æŒ‡æ•°ã‚’è¨ˆç®—
    
    Args:
        prev_corner_1-4: å‰èµ°é€šéé †ä½
        prev_tosu: å‰èµ°å‡ºèµ°é ­æ•°
        prev_trouble_score: å‰èµ°ä¸åˆ©ã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰
    
    Returns:
        float: ä½ç½®æŒ‡æ•°
    """
    corners = [prev_corner_1, prev_corner_2, prev_corner_3, prev_corner_4]
    corners = [c for c in corners if c is not None and c > 0]
    
    if not corners or not prev_tosu or prev_tosu <= 0:
        logger.warning(f"å‰èµ°é€šéé †ä½ãƒ‡ãƒ¼ã‚¿ä¸è¶³")
        return 50.0
    
    avg_position = sum(corners) / len(corners)
    
    # å‰èµ°ä¸åˆ©è£œæ­£ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    # ä¸åˆ©ãŒã‚ã£ãŸå ´åˆã€å®ŸåŠ›é †ä½ã¯ã‚‚ã£ã¨å‰ã¨æ¨å®š
    if prev_trouble_score > 50:
        position_correction = (prev_trouble_score / 100) * 2.0  # æœ€å¤§2é ­åˆ†å‰
        avg_position = max(1.0, avg_position - position_correction)
        logger.info(f"ä½ç½®æŒ‡æ•°ã«å‰èµ°ä¸åˆ©è£œæ­£: {position_correction:.1f}é ­åˆ†å‰")
    
    position_index = round((avg_position / prev_tosu) * 100, 1)
    
    logger.info(
        f"ä½ç½®æŒ‡æ•° {position_index} "
        f"(å‰èµ°å¹³å‡é †ä½={avg_position:.1f}/{prev_tosu}é ­)"
    )
    
    return position_index
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] ä½ç½®æŒ‡æ•°ã¸ã®å‰èµ°ä¸åˆ©è£œæ­£ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆ

---

### Phase 3: ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å®šç¾©ã¸ã®è¿½åŠ ï¼ˆ30åˆ†ï¼‰

#### Step 3-1: ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å®šç¾©è¿½åŠ 

**æˆæœç‰©**: `config/factor_definitions.py` (F31-F33è¿½åŠ )

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
# Phase 4: å‰èµ°ä¸åˆ©æ¤œçŸ¥çµ±åˆï¼ˆ2026-01-07è¿½åŠ ï¼‰
{
    'id': 'F31',
    'name': 'å‰èµ°ä¸åˆ©åº¦ã‚¹ã‚³ã‚¢',
    'category': 'å‰èµ°ä¸åˆ©',
    'table': 'nar_trouble_estimated',
    'column': 'trouble_score',
    'display_column': 'trouble_score',
    'description': 'å‰èµ°ãƒ¬ãƒ¼ã‚¹ã§ã®ä¸åˆ©åº¦ï¼ˆ0-100ï¼‰çµ±è¨ˆçš„ç•°å¸¸æ¤œçŸ¥',
    'data_type': 'decimal',
    'factor_type': 'single',
    'join_condition': """
        LEFT JOIN nar_trouble_estimated te ON
            te.ketto_toroku_bango = se.ketto_toroku_bango
            AND te.race_date = se.prev_race_date
            AND te.keibajo_code = se.prev_keibajo_code
            AND te.race_bango = se.prev_race_bango
    """,
    'notes': 'å‡ºé…ã‚Œãƒ»é †ä½é€†è»¢ã‚’çµ±è¨ˆçš„ç•°å¸¸æ¤œçŸ¥ã§è‡ªå‹•æ¤œå‡º'
},
{
    'id': 'F32',
    'name': 'å‰èµ°ä¸åˆ©ã‚¿ã‚¤ãƒ—',
    'category': 'å‰èµ°ä¸åˆ©',
    'table': 'nar_trouble_estimated',
    'column': 'trouble_type',
    'display_column': 'trouble_type',
    'description': 'å‡ºé…ã‚Œ/æŒŸã¾ã‚Œ/å¤–å›ã—ç­‰ã®åˆ†é¡',
    'data_type': 'varchar',
    'factor_type': 'single',
    'values': ['slow_start', 'rank_reversal', 'mixed', 'ãªã—'],
    'notes': 'slow_start: å‡ºé…ã‚Œ, rank_reversal: é †ä½é€†è»¢, mixed: è¤‡åˆ'
},
{
    'id': 'F33',
    'name': 'å‰èµ°ä¸åˆ©æ¤œçŸ¥ä¿¡é ¼åº¦',
    'category': 'å‰èµ°ä¸åˆ©',
    'table': 'nar_trouble_estimated',
    'column': 'confidence',
    'display_column': 'confidence',
    'description': 'ä¸åˆ©æ¤œçŸ¥ã®ä¿¡é ¼åº¦ï¼ˆ0.00-1.00ï¼‰',
    'data_type': 'decimal',
    'factor_type': 'single',
    'notes': '0.85ä»¥ä¸Š: é«˜ä¿¡é ¼, 0.70-0.85: ä¸­ä¿¡é ¼, 0.70æœªæº€: ä½ä¿¡é ¼'
}
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] F31-F33å®šç¾©è¿½åŠ 
- [ ] JOINæ¡ä»¶ã®è¨˜è¿°
- [ ] ãƒ‡ãƒ¼ã‚¿å‹ãƒ»å€¤åŸŸã®å®šç¾©
- [ ] èª¬æ˜æ–‡ã®ä½œæˆ

---

#### Step 3-2: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¯ã‚¨ãƒªã®æ›´æ–°

**æˆæœç‰©**: `core/data_fetcher.py` (å‰èµ°ä¸åˆ©ãƒ‡ãƒ¼ã‚¿å–å¾—éƒ¨åˆ†)

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
def get_tomorrow_races_with_prev_trouble(conn):
    """
    æ˜æ—¥ã®å‡ºèµ°é¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆå‰èµ°ä¸åˆ©ãƒ‡ãƒ¼ã‚¿å«ã‚€ï¼‰ã‚’å–å¾—
    """
    query = """
        SELECT 
            se.*,
            te.trouble_score as prev_trouble_score,
            te.trouble_type as prev_trouble_type,
            te.confidence as prev_trouble_confidence
        FROM nvd_se se
        LEFT JOIN nar_trouble_estimated te ON
            te.ketto_toroku_bango = se.ketto_toroku_bango
            AND te.race_date = se.prev_race_date
            AND te.keibajo_code = se.prev_keibajo_code
            AND te.race_bango = se.prev_race_bango
        WHERE se.kaisai_nen || se.kaisai_tsukihi = %s
        ORDER BY se.keibajo_code, se.race_bango, se.umaban
    """
    
    tomorrow = get_tomorrow_date()
    cursor = conn.cursor()
    cursor.execute(query, [tomorrow])
    return cursor.fetchall()
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] LEFT JOINè¿½åŠ 
- [ ] prev_trouble_* ã‚«ãƒ©ãƒ å–å¾—
- [ ] ãƒ†ã‚¹ãƒˆ

---

### Phase 4: æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆï¼ˆ2-3æ™‚é–“ï¼‰

#### Step 4-1: å˜ä½“ãƒ†ã‚¹ãƒˆ

**æˆæœç‰©**: `tests/test_trouble_detection.py`

```python
import unittest
from nar_trouble_detection import TroubleDetector

class TestTroubleDetection(unittest.TestCase):
    def setUp(self):
        self.detector = TroubleDetector(get_test_db_connection())
    
    def test_detect_slow_start(self):
        """å‡ºé…ã‚Œæ¤œçŸ¥ãƒ†ã‚¹ãƒˆ"""
        race_horses = [
            {'ketto_toroku_bango': 'A001', 'time': 80.0, 'kohan_3f': 38.0},  # ãƒ†ãƒ³42.0
            {'ketto_toroku_bango': 'A002', 'time': 78.0, 'kohan_3f': 38.0},  # ãƒ†ãƒ³40.0
            {'ketto_toroku_bango': 'A003', 'time': 85.0, 'kohan_3f': 38.0},  # ãƒ†ãƒ³47.0ï¼ˆå‡ºé…ã‚Œï¼‰
        ]
        
        results = self.detector.detect_slow_start(race_horses)
        
        self.assertEqual(len(results), 1)
        self.assertEqual(results[0]['ketto_toroku_bango'], 'A003')
        self.assertEqual(results[0]['trouble_type'], 'slow_start')
        self.assertGreater(results[0]['trouble_score'], 50)
    
    def test_detect_rank_reversal(self):
        """é †ä½é€†è»¢æ¤œçŸ¥ãƒ†ã‚¹ãƒˆ"""
        race_horses = [
            {
                'ketto_toroku_bango': 'B001',
                'corner_1': 2, 'corner_2': 3, 'corner_3': 7, 'corner_4': 8
            },  # å¤§ããå¾Œé€€
        ]
        
        results = self.detector.detect_rank_reversal(race_horses)
        
        self.assertEqual(len(results), 1)
        self.assertEqual(results[0]['trouble_type'], 'rank_reversal')
        self.assertGreater(results[0]['trouble_score'], 40)

if __name__ == '__main__':
    unittest.main()
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] å‡ºé…ã‚Œæ¤œçŸ¥ãƒ†ã‚¹ãƒˆ
- [ ] é †ä½é€†è»¢æ¤œçŸ¥ãƒ†ã‚¹ãƒˆ
- [ ] çµ±åˆã‚¹ã‚³ã‚¢ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

---

#### Step 4-2: çµ±åˆãƒ†ã‚¹ãƒˆ

**æˆæœç‰©**: `tests/test_hqs_with_trouble.py`

```python
def test_agari_index_with_prev_trouble():
    """å‰èµ°ä¸åˆ©è£œæ­£è¾¼ã¿ã®ä¸ŠãŒã‚ŠæŒ‡æ•°ãƒ†ã‚¹ãƒˆ"""
    
    # ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: å‰èµ°ä¸åˆ©ãªã—
    agari_index_1, trouble_type_1 = calculate_agari_index_from_prev(
        conn=test_conn,
        prev_kohan_3f=37.5,
        prev_kyori=1400,
        prev_baba_code='2',
        prev_keibajo_code='30',
        ketto_toroku_bango='TEST001',
        prev_race_date='20260101',
        prev_race_bango=1
    )
    
    print(f"å‰èµ°ä¸åˆ©ãªã—: ä¸ŠãŒã‚ŠæŒ‡æ•°={agari_index_1}, ã‚¿ã‚¤ãƒ—={trouble_type_1}")
    
    # ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: å‰èµ°å¤§å¤–ã‚’å›ã•ã‚ŒãŸï¼ˆtrouble_score=75ï¼‰
    # äº‹å‰ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
    insert_dummy_trouble(test_conn, 'TEST002', '20260101', '30', 1, 75.0, 'rank_reversal')
    
    agari_index_2, trouble_type_2 = calculate_agari_index_from_prev(
        conn=test_conn,
        prev_kohan_3f=39.0,  # åŒã˜æ¡ä»¶
        prev_kyori=1400,
        prev_baba_code='2',
        prev_keibajo_code='30',
        ketto_toroku_bango='TEST002',
        prev_race_date='20260101',
        prev_race_bango=1
    )
    
    print(f"å‰èµ°å¤§å¤–ã‚’å›ã•ã‚ŒãŸ: ä¸ŠãŒã‚ŠæŒ‡æ•°={agari_index_2}, ã‚¿ã‚¤ãƒ—={trouble_type_2}")
    
    # ä¸åˆ©ãŒã‚ã£ãŸé¦¬ã®æ–¹ãŒæŒ‡æ•°ãŒé«˜ããªã‚‹ã¯ãš
    assert agari_index_2 > agari_index_1, "å‰èµ°ä¸åˆ©è£œæ­£ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„"
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] HQSæŒ‡æ•°ã¸ã®çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] å‰èµ°ä¸åˆ©ã‚ã‚Š/ãªã—ã®æ¯”è¼ƒ
- [ ] ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å–å¾—ãƒ†ã‚¹ãƒˆ

---

#### Step 4-3: å®Ÿãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

**æˆæœç‰©**: `validation_report.md`

**æ¤œè¨¼å†…å®¹**:
1. éå»100ãƒ¬ãƒ¼ã‚¹ã®ã‚µãƒ³ãƒ—ãƒ«æŠ½å‡º
2. ä¸åˆ©æ¤œçŸ¥çµæœã®ç›®è¦–ç¢ºèª
3. ç«¶é¦¬å ´ãƒ»è·é›¢åˆ¥ã®æ¤œçŸ¥ç‡åˆ†æ
4. Precision @ Kè©•ä¾¡

```python
def validate_trouble_detection():
    """å®Ÿãƒ‡ãƒ¼ã‚¿ã§ã®æ¤œè¨¼"""
    
    query = """
        SELECT 
            se.bamei,
            se.kaisai_nen || se.kaisai_tsukihi as race_date,
            se.keibajo_code,
            ra.race_bango,
            se.kakutei_chakujun,
            te.trouble_score,
            te.trouble_type,
            te.confidence
        FROM nvd_se se
        LEFT JOIN nar_trouble_estimated te ON ...
        WHERE se.kaisai_nen || se.kaisai_tsukihi BETWEEN '20250101' AND '20251231'
        ORDER BY te.trouble_score DESC NULLS LAST
        LIMIT 100
    """
    
    results = execute_query(query)
    
    # ä¸Šä½100ä»¶ã®ä¸åˆ©æ¤œçŸ¥çµæœã‚’åˆ†æ
    # - ç«¶é¦¬å ´åˆ¥åˆ†å¸ƒ
    # - ä¸åˆ©ã‚¿ã‚¤ãƒ—åˆ¥åˆ†å¸ƒ
    # - ã‚¹ã‚³ã‚¢åˆ†å¸ƒ
    # - ç›®è¦–ç¢ºèª
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] ã‚µãƒ³ãƒ—ãƒ«æŠ½å‡º
- [ ] æ¤œçŸ¥çµæœã®åˆ†æ
- [ ] ç«¶é¦¬å ´ãƒ»è·é›¢åˆ¥é›†è¨ˆ
- [ ] ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ

---

## ğŸ“Š æˆåŠŸåŸºæº–

### Phase 1ï¼ˆå‰èµ°ä¸åˆ©æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼‰
- âœ… `nar_trouble_estimated` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†
- âœ… éå»3å¹´åˆ†ã®ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿åˆ†æå®Œäº†
- âœ… å‡ºé…ã‚Œæ¤œçŸ¥ç²¾åº¦ > 75%
- âœ… é †ä½é€†è»¢æ¤œçŸ¥ç²¾åº¦ > 80%
- âœ… çµ±åˆã‚¹ã‚³ã‚¢ç®—å‡ºãƒ»ä¿å­˜å®Œäº†

### Phase 2ï¼ˆHQSçµ±åˆï¼‰
- âœ… å‰èµ°ä¸åˆ©ãƒ‡ãƒ¼ã‚¿ã‚’æ¬¡èµ°ã®èƒ½åŠ›è©•ä¾¡ã«åæ˜ 
- âœ… ä¸ŠãŒã‚ŠæŒ‡æ•°ã«å‰èµ°ä¸åˆ©è£œæ­£é©ç”¨
- âœ… ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã€Œå‰èµ°å¤§å¤–ã‚’å›ã•ã‚ŒãŸé¦¬ã€ã§å‹•ä½œç¢ºèª
- âœ… ä¸åˆ©ã‚ã‚Š/ãªã—ã§æŒ‡æ•°å·®ã‚’ç¢ºèª

### Phase 3ï¼ˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼è¿½åŠ ï¼‰
- âœ… F31-F33ï¼ˆå‰èµ°ä¸åˆ©åº¦ãƒ»ã‚¿ã‚¤ãƒ—ãƒ»ä¿¡é ¼åº¦ï¼‰å®šç¾©è¿½åŠ 
- âœ… prev_race_date ã§JOINå¯èƒ½
- âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¯ã‚¨ãƒªå‹•ä½œç¢ºèª

### Phase 4ï¼ˆæ¤œè¨¼ï¼‰
- âœ… å˜ä½“ãƒ†ã‚¹ãƒˆå…¨ä»¶ãƒ‘ã‚¹
- âœ… çµ±åˆãƒ†ã‚¹ãƒˆå…¨ä»¶ãƒ‘ã‚¹
- âœ… å®Ÿãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†
- âœ… Precision @ 100 > 60%ï¼ˆç›®æ¨™ï¼‰

---

## ğŸ“ˆ æœŸå¾…åŠ¹æœ

### 1. HQSæŒ‡æ•°ã®ç²¾åº¦å‘ä¸Š
- **ç¾çŠ¶**: å‰èµ°ä¸åˆ©è£œæ­£ãªã—
- **å®Ÿè£…å¾Œ**: çµ±è¨ˆçš„ä¸åˆ©æ¤œçŸ¥ã§è£œæ­£é©ç”¨
- **æœŸå¾…å‘ä¸Šå¹…**: +8-12%ï¼ˆå……å®Ÿåº¦ 83% â†’ 91-95%ï¼‰

### 2. äºˆæƒ³ç²¾åº¦ã¸ã®è²¢çŒ®
```
å…·ä½“ä¾‹: å‰èµ°ã§å¤§å¤–ã‚’å›ã•ã‚ŒãŸé¦¬
- å‰èµ°çµæœ: 8ç€ï¼ˆè¦‹ã‹ã‘ä¸Šæ‚ªã„ï¼‰
- ä¸åˆ©ã‚¹ã‚³ã‚¢: 75
- å®ŸåŠ›è©•ä¾¡: ã€Œå®ŸåŠ›ã¯5ç€ç›¸å½“ã€
- æ¬¡èµ°è©•ä¾¡: ã€Œå·»ãè¿”ã—æœŸå¾…ã€
- ä¸ŠãŒã‚ŠæŒ‡æ•°: +1.5ç§’è£œæ­£
```

### 3. ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æã®æ‹¡å……
```sql
-- å‰èµ°ä¸åˆ©é¦¬ã®æ¬¡èµ°æˆç¸¾åˆ†æ
SELECT 
    CASE 
        WHEN prev_trouble_score >= 70 THEN 'å¤§ããªä¸åˆ©'
        WHEN prev_trouble_score >= 40 THEN 'ä¸­ç¨‹åº¦ã®ä¸åˆ©'
        ELSE 'è»½å¾®ãªä¸åˆ©'
    END as trouble_level,
    COUNT(*) as race_count,
    AVG(CASE WHEN kakutei_chakujun <= 3 THEN 1 ELSE 0 END) as top3_rate,
    AVG(tansho_haraimodoshi) as avg_payoff
FROM v_nvd_se_with_prev_trouble
WHERE prev_trouble_score > 30
GROUP BY trouble_level;
```

**æœŸå¾…çµæœ**:
- å¤§ããªä¸åˆ©ãŒã‚ã£ãŸé¦¬ã®æ¬¡èµ°è¤‡å‹ç‡: 30-40%
- ä¸­ç¨‹åº¦ã®ä¸åˆ©ãŒã‚ã£ãŸé¦¬ã®æ¬¡èµ°è¤‡å‹ç‡: 25-35%
- è»½å¾®ãªä¸åˆ©ãŒã‚ã£ãŸé¦¬ã®æ¬¡èµ°è¤‡å‹ç‡: 20-30%

---

## ğŸ—“ï¸ å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### ä»Šæ—¥ï¼ˆ2026-01-07ï¼‰
- **14:00-15:00**: Phase 1 Step 1-1ï¼ˆDBãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼‰
- **15:00-18:00**: Phase 1 Step 1-2ï¼ˆå‡ºé…ã‚Œæ¤œçŸ¥å®Ÿè£…ï¼‰
- **18:00-21:00**: Phase 1 Step 1-3ï¼ˆé †ä½é€†è»¢æ¤œçŸ¥å®Ÿè£…ï¼‰
- **21:00-23:00**: Phase 1 Step 1-4ï¼ˆçµ±åˆã‚¹ã‚³ã‚¢ç®—å‡ºï¼‰

### æ˜æ—¥ï¼ˆ2026-01-08ï¼‰
- **09:00-12:00**: Phase 1 Step 1-5ï¼ˆãƒãƒƒãƒå‡¦ç†ãƒ»éå»ãƒ‡ãƒ¼ã‚¿åˆ†æï¼‰
- **13:00-15:00**: Phase 2ï¼ˆHQSæŒ‡æ•°ã¸ã®çµ±åˆï¼‰
- **15:00-16:00**: Phase 3ï¼ˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å®šç¾©è¿½åŠ ï¼‰
- **16:00-18:00**: Phase 4ï¼ˆæ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆï¼‰
- **18:00-19:00**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ

**æ¨å®šå®Œäº†**: 2026-01-08 19:00

---

## ğŸ“š å‚ç…§è³‡æ–™

1. **ç†è«–ãƒ»æ‰‹æ³•**:
   - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã€Œç«¶é¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆJRA/NARï¼‰ã«ãŠã‘ã‚‹ä¸åˆ©ãƒ»ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆæ¤œçŸ¥ã®ãŸã‚ã®çµ±è¨ˆçš„ç•°å¸¸å€¤æ¤œå‡ºãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯.txtã€
   - TXT 4.1ç¯€: Modified Z-score (MADæ³•)
   - TXT 5.1ç¯€: é †ä½é€†è»¢æ¤œçŸ¥ï¼ˆRank Reversal Detectionï¼‰
   - TXT 6.1ç¯€: Isolation Forestï¼ˆPhase 2ã§å®Ÿè£…äºˆå®šï¼‰

2. **ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼**:
   - å‰å›æä¾›ã—ãŸã€Œå‰åŠ3Fæ¨å®šã®å®Ÿãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€

3. **å®Ÿè£…ç’°å¢ƒ**:
   - NAR-SI Ver.4.0
   - PostgreSQLï¼ˆnardbï¼‰
   - nvd_se, nvd_ra ãƒ†ãƒ¼ãƒ–ãƒ«

---

## ğŸš€ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **GitHubã«ä¿å­˜**: ã“ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ã‚³ãƒŸãƒƒãƒˆ
2. **CEOæ‰¿èªå¾…ã¡**: å®Ÿè£…é–‹å§‹ã®æœ€çµ‚ç¢ºèª
3. **Phase 1é–‹å§‹**: DBãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‹ã‚‰ç€æ‰‹

**Play to Win. 10x Mindset. å®Ÿè£…æº–å‚™å®Œäº†ï¼ğŸš€**

---

## ğŸ“ å¤‰æ›´å±¥æ­´

- 2026-01-07 14:00: ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—åˆç‰ˆä½œæˆ
- å‰èµ°ä¸åˆ©æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“è¨­è¨ˆå®Œäº†
- Phase 1-4ã®è©³ç´°å®Ÿè£…è¨ˆç”»ç­–å®š
- æˆåŠŸåŸºæº–ãƒ»æœŸå¾…åŠ¹æœã®æ˜ç¢ºåŒ–
