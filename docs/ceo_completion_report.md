# CEO向け完了報告：枠順係数と上がり指数のディープサーチプロンプト作成

## ✅ 完了タスクのサマリー

### **Task 1: 位置指数の枠順係数を実データから算出** ✅
- **目的**: 全競馬場×距離別に的中率を集計し、係数を再算出
- **結果**: 796行の枠順係数テーブルを生成
- **出力**: 
  - CSV: `data/wakuban_coefficients.csv`
  - JSON: `data/wakuban_coefficients.json`

### **Task 2: 上がり指数のディープサーチ用プロンプト作成** ✅
- **目的**: 研究推奨値の妥当性を再検証するためのプロンプト
- **内容**: ペース補正値（H -0.8秒, S +0.3秒）の根拠を再確認
- **出力**: `docs/agari_index_deep_search_prompt.md`

### **Task 3: 枠順係数の学術的最適化プロンプト作成** ✅
- **目的**: 統計学的・数学的に最高峰の枠順係数算出方法を提案
- **内容**: ベイズ統計、GLM、機械学習、エンピリカルベイズの4アプローチ
- **出力**: 
  - `docs/wakuban_coefficient_deep_search_prompt.md`
  - `docs/wakuban_coefficient_required_materials.md`

### **Task 4: GitHubに最新版を保存** ✅
- **コミット**: `60d7438`
- **リポジトリ**: https://github.com/aka209859-max/umaconn-keiba-ai.git
- **ブランチ**: main

---

## 📊 枠順係数の実データ分析結果

### **統計サマリー**

#### **1. 枠順係数の範囲**
- **最小**: -18.14 (金沢2000m枠2番) → 極めて不利
- **最大**: +48.93 (船橋2400m枠1番) → 極めて有利
- **平均**: 0.00 (基準値からの偏差)

#### **2. 競馬場別の傾向**
| 競馬場 | 最小係数 | 最大係数 | 標準偏差 | 特徴 |
|--------|---------|---------|---------|------|
| 船橋 | -17.73 | **+48.93** | 7.69 | 枠順の影響が**極めて大きい** |
| 金沢 | **-18.14** | +33.48 | 7.35 | 枠順の影響が**極めて大きい** |
| 川崎 | -4.53 | +8.27 | 2.89 | 枠順の影響が**小さい** |
| 門別 | -6.94 | +11.66 | 3.12 | 枠順の影響が**小さい** |

#### **3. 距離別の傾向**
| 距離 | 最小係数 | 最大係数 | 標準偏差 | 特徴 |
|------|---------|---------|---------|------|
| 2400m | **-17.81** | **+48.93** | 13.61 | 枠順の影響が**極めて大きい** |
| 2600m | -16.51 | +33.48 | 16.29 | 枠順の影響が**極めて大きい** |
| 1200m | -5.59 | +3.19 | 2.04 | 枠順の影響が**小さい** |
| 1230m | -1.85 | +3.24 | 1.80 | 枠順の影響が**小さい** |

### **重要な発見**

#### **発見1: 長距離ほど枠順の影響が大きい**
- 2400m以上: 係数範囲が-18〜+49（幅67点）
- 1200m以下: 係数範囲が-6〜+3（幅9点）
- **理由**: 長距離では位置取りの重要性が高く、内枠の有利性が顕著

#### **発見2: 競馬場によって枠順の影響が大きく異なる**
- 船橋・金沢: 標準偏差7以上（枠順の影響大）
- 川崎・門別: 標準偏差3以下（枠順の影響小）
- **理由**: コース形状、直線距離、逃げ有利度等の違い

#### **発見3: 極端な係数はサンプル数が少ない**
- 船橋2400m枠1番（+48.93）: サンプル数不明（要確認）
- 金沢2000m枠2番（-18.14）: サンプル数不明（要確認）
- **懸念**: 統計的有意性が不明（信頼区間の算出が必要）

---

## 🔬 ディープサーチプロンプトの概要

### **1. 上がり指数のペース補正値プロンプト**

#### **検証対象**
| 項目 | 現行実装 | 研究推奨値 | 差分 |
|------|---------|-----------|------|
| ハイペース（H） | -0.5秒 | **-0.8秒** | +0.3秒 |
| スローペース（S） | +0.5秒 | **+0.3秒** | -0.2秒 |

#### **WebSearch用の質問（4つ）**
1. ペース補正の理論的根拠
2. 実データに基づくペース影響の分析
3. 中央競馬（JRA）との比較
4. 最新の研究動向

#### **期待される成果**
- 研究推奨値の理論的根拠を明確化
- 実データに基づく最適値の決定
- CEO判断により、現行実装を維持するか変更するか決定

---

### **2. 枠順係数の学術的最適化プロンプト**

#### **提案する4つのアプローチ**

**A) ベイズ統計による信頼区間付き推定（推奨）**
- サンプル数を考慮した縮小推定
- 信頼区間を算出し、統計的に有意な係数のみを採用
- 実装時間: 1-2時間

**B) 一般化線形モデル（GLM）による多変量解析**
- 枠順×距離×競馬場の交互作用を推定
- 他の要因（馬場状態、出走頭数等）と同時に推定
- 実装時間: 2-3時間

**C) 機械学習による非線形モデル**
- XGBoost、LightGBMによる高精度推定
- SHAP値により寄与度を定量化
- 実装時間: 3-5時間

**D) エンピリカルベイズによる縮小推定**
- James-Stein推定量による縮小推定
- サンプル数が不均一な場合に有効
- 実装時間: 1-2時間

#### **WebSearch用の質問（5つ）**
1. ベイズ統計による枠順係数の推定
2. 一般化線形モデル（GLM）の適用
3. 機械学習による枠順係数の推定
4. エンピリカルベイズによる縮小推定
5. 学術論文と実証研究

---

## 📂 添付資料の要求事項

### **既に取得済み（追加提供不要）** ✅
1. 枠順別的中率データ（`data-1768033229370.csv`）
2. 枠順係数の算出結果（`wakuban_coefficients.csv`）
3. 枠順係数の算出ロジック（`calculate_wakuban_coefficients.py`）
4. 位置指数の計算ロジック（`index_calculator.py`）

### **追加で必要な資料（CEOに依頼）** 📋

#### **高優先度: レース結果の詳細データ**
- **目的**: ベイズ統計、GLM、機械学習による推定
- **必要なカラム**: 
  - `race_id`, `keibajo_code`, `kyori`, `wakuban`, `chakujun`
  - `tosu`, `baba_code`, `grade_code`, `tansho_flag`, `fukusho_flag`
- **データ量**: 最低10,000レース（推奨50,000レース以上）
- **形式**: CSV または データベース（SQLite/PostgreSQL等）

**CEOへの質問:**
- **Q1**: レース結果データを持っていますか？（A: 持っている / B: 一部持っている / C: 持っていない）
- **Q2**: データパスを教えてください（例: `E:\UmaData\race_results.csv`）

---

## 🎯 次のステップ

### **即座に実行可能（データ不要）**

**Step 1: ベイズ統計による枠順係数の推定**
- 既存データ（`wakuban_coefficients.csv`）を使用
- サンプル数を考慮した信頼区間付き係数を算出
- 統計的に有意でない係数を除外
- 実装時間: 1-2時間

**Step 2: WebSearchによるディープサーチ**
- 上がり指数のペース補正値（4つの質問）
- 枠順係数の学術的最適化（5つの質問）
- 実装時間: 30分-1時間

### **CEOがデータを提供した場合に実行**

**Step 3: GLMまたは機械学習による推定**
- レース結果データを使用
- 交互作用項（枠×距離、枠×競馬場）を推定
- 予測精度の比較（現行 vs 新方式）
- 実装時間: 2-5時間

---

## 📋 CEOへの依頼事項

### **依頼1: レース結果データの有無**
以下のいずれかを選択してください。

- **A) 持っている** → データパスを教えてください
- **B) 一部持っている** → 何年分のデータがあるか教えてください
- **C) 持っていない** → 既存データのみで進めます（ベイズ統計）

### **依頼2: 次のアクション**
以下のいずれかを選択してください。

- **Option A: WebSearchを今すぐ実行** → ディープサーチを開始します
- **Option B: ベイズ統計を今すぐ実装** → 信頼区間付き係数を算出します
- **Option C: 両方同時進行** → 並行して実行します
- **Option D: 後回し** → 他のタスクを優先します

### **依頼3: 優先順位の決定**
以下の4つのうち、どれを優先しますか？

- **A) ベイズ統計（推奨）**: 統計的に堅牢、実装が容易
- **B) GLM**: 多変量解析により精度向上
- **C) 機械学習**: 最高精度が期待できる
- **D) エンピリカルベイズ**: サンプル数が不均一な場合に有効

**推奨**: まず **A) ベイズ統計** を実装し、精度を確認してから他を検討

---

## 📁 出力ファイル一覧

### **データファイル**
- `data/wakuban_coefficients.csv` (796行, 75KB)
- `data/wakuban_coefficients.json` (プログラム用)

### **ドキュメント**
- `docs/agari_index_deep_search_prompt.md` (上がり指数)
- `docs/wakuban_coefficient_deep_search_prompt.md` (枠順係数)
- `docs/wakuban_coefficient_required_materials.md` (必要資料リスト)
- `docs/hqs_implementation_status.md` (HQS指数実装状況)

### **スクリプト**
- `scripts/calculate_wakuban_coefficients.py` (枠順係数算出)

---

## 🚀 GitHub情報

- **リポジトリ**: https://github.com/aka209859-max/umaconn-keiba-ai.git
- **最新コミット**: `60d7438`
- **コミットメッセージ**: "Feat: 枠順係数の実データ算出とディープサーチプロンプト作成"
- **変更ファイル**: 11ファイル追加、4,506行挿入

---

## ✅ 完了ステータス

- ✅ **Task 1**: 位置指数の枠順係数を実データから算出（完了）
- ✅ **Task 2**: 上がり指数のディープサーチ用プロンプト作成（完了）
- ✅ **Task 3**: 枠順係数の学術的最適化プロンプト作成（完了）
- ✅ **Task 4**: GitHubに最新版を保存（完了）

---

**CEO、依頼1〜3の回答をお願いします！ Play to Win! 🚀**
