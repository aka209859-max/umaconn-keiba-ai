# ディープサーチ用プロンプト：競馬指数の極端な偏りの統計学的解決策

## 🎯 検索目的

地方競馬AIにおける4つの指数（テン指数、位置指数、上がり指数、ペース指数）の計算において、**理論範囲内にクリップしたことで極端な偏りが発生している問題**を、**統計学的・学術的な観点から解決する方法**を調査してください。

---

## 📊 現状の問題詳細

### 1. 各指数の計算ロジック（現在の実装）

#### 🔵 テン指数（Ten Index）
- **目的**: 初期加速力（前半3F = 600m）の評価
- **計算式**: `テン指数 = ((基準タイム - 実走前半3F)) × 10`
- **理論範囲**: -100 ～ +100
- **現在の処理**: `ten_index = max(-100, min(100, ten_index))` でクリップ
- **基準タイム（距離別）**:
  - ～1200m: 37.5秒
  - 1201～1400m: 38.0秒
  - 1401～1600m: 39.0秒
  - 1601～1800m: 39.5秒
  - 1801～2000m: 40.0秒
  - 2001m～: 40.5秒

#### 🔵 位置指数（Position Index）
- **目的**: コーナー通過順位（ポジション）の評価
- **計算式**: `位置指数 = ((基準順位 - 実際の4コーナー順位) / 頭数) × 100`
  - 基準順位 = 頭数 / 2.0
- **理論範囲**: 0 ～ 100
- **現在の処理**: `position_index = max(0, min(100, position_index))` でクリップ

#### 🔵 上がり指数（Agari Index）
- **目的**: ラストスパート能力（後半3F = 600m）の評価
- **計算式**: `上がり指数 = ((基準タイム - 実走後半3F)) × 10`
- **理論範囲**: -100 ～ +100
- **現在の処理**: `agari_index = max(-100, min(100, agari_index))` でクリップ
- **基準タイム**: テン指数と同じ距離別基準タイム

#### 🔵 ペース指数（Pace Index）
- **目的**: レース全体のペース配分の評価
- **計算式**: `ペース指数 = テン指数 - 上がり指数`
- **理論範囲**: -100 ～ +100
- **現在の処理**: `pace_index = max(-100, min(100, pace_index))` でクリップ

---

### 2. 発見された極端な偏り（実データ分析結果）

#### 📊 テン指数の分布（総データ数: 137,687件）

| 範囲 | 件数 | 割合 | 問題 |
|------|------|------|------|
| **-100～-95** | **95,577件** | **69.42%** | 🔴🔴🔴 **全体の約7割が下限に集中** |
| -95～-90 | 929件 | 0.67% | |
| -90～-85 | 1,268件 | 0.92% | |
| ... | ... | ... | 中間は正常分布 |
| 90～95 | 6件 | 0.00% | |
| **95～100** | **15,687件** | **11.39%** | 🔴🔴 **上限にも集中** |

**問題点**: 
- 全データの **69.42%** が -100～-95 の狭い範囲に集中
- 全データの **11.39%** が 95～100 の狭い範囲に集中
- **合計80.81%** がクリップされた極端な値

#### 📊 位置指数の分布（総データ数: 137,687件）

| 範囲 | 件数 | 割合 | 問題 |
|------|------|------|------|
| **0～5** | **80,448件** | **58.43%** | 🔴🔴🔴 **全体の約6割が下限に集中** |
| 5～10 | 6,502件 | 4.72% | |
| 10～15 | 7,240件 | 5.26% | |
| ... | ... | ... | 比較的正常 |
| 40～45 | 10,094件 | 7.33% | |
| 45～50 | 0件 | 0.00% | |
| 50～100 | 13件 | 0.01% | 🔴 データがほぼ存在しない |

**問題点**: 
- 全データの **58.43%** が 0～5 の狭い範囲に集中
- 50以上のデータがほぼ存在しない（0.01%）

#### 📊 上がり指数の分布（総データ数: 137,687件）

| 範囲 | 件数 | 割合 | 状態 |
|------|------|------|------|
| -100～-90 | 244件 | 0.18% | |
| -90～-80 | 262件 | 0.19% | |
| ... | ... | ... | |
| **-30～-20** | **27,851件** | **20.23%** | ✅ 正常な山（ピーク） |
| **-20～-10** | **33,446件** | **24.29%** | ✅ 最大のピーク |
| **-10～0** | **27,063件** | **19.66%** | ✅ 正常な山 |
| 0～10 | 13,472件 | 9.78% | |
| ... | ... | ... | |
| 90～100 | 0件 | 0.00% | |

**状態**: ✅ **正常な正規分布に近い**（偏りなし）

#### 📊 ペース指数の分布（総データ数: 137,687件）

| 範囲 | 件数 | 割合 | 問題 |
|------|------|------|------|
| **-100～-95** | **15,289件** | **11.10%** | 🔴 下限に集中 |
| -95～-90 | 9,072件 | 6.59% | |
| -90～-85 | 11,014件 | 8.00% | |
| -85～-80 | 11,820件 | 8.58% | |
| ... | ... | ... | 比較的正常 |
| 90～95 | 1,922件 | 1.40% | |
| **95～100** | **11,961件** | **8.69%** | 🔴 上限に集中 |

**問題点**: 
- 全データの **11.10%** が -100～-95 に集中
- 全データの **8.69%** が 95～100 に集中
- **合計19.79%** がクリップされた極端な値

---

### 3. 原因分析

#### 🔴 主要な原因

1. **基準タイムと実測タイムの乖離**
   - 基準タイム（37.5～40.5秒）は「標準的な馬」を想定
   - しかし実際のデータには:
     - **非常に遅い馬**（前半3F が 50秒、60秒、70秒など）
     - **非常に速い馬**（前半3F が 30秒以下など）
   - これらが計算すると -100 や +100 を大きく超える

2. **クリップ処理による情報損失**
   - 現在の処理: `max(-100, min(100, value))`
   - 結果: 
     - 元の値が -500 でも -100 にクリップ
     - 元の値が +300 でも +100 にクリップ
   - **異なる能力の馬が同じ指数値になる**（情報損失）

3. **位置指数の構造的問題**
   - 後方の馬（4コーナーで最後尾付近）は必然的に 0～10 の範囲に集中
   - 先行馬が少ないため、50以上の値がほとんど出現しない

---

## 🎯 解決したい課題（検索キーワード）

以下のキーワードで、**統計学的・学術的な解決方法**を検索してください：

### 1. 正規化・標準化手法
- "z-score normalization extreme values"
- "min-max scaling with outliers"
- "robust scaling methods statistics"
- "percentile-based normalization"
- "winsorization vs trimming"
- "非線形変換 統計学"
- "外れ値に頑健な正規化"

### 2. 分布の変換手法
- "log transformation skewed distribution"
- "box-cox transformation"
- "yeo-johnson transformation"
- "sinh-arcsinh transformation"
- "対数変換 歪んだ分布"
- "べき乗変換 統計学"

### 3. 競馬・スポーツ統計の事例
- "horse racing speed index normalization"
- "sports performance metrics standardization"
- "racing performance outlier handling"
- "競馬 指数 正規化 方法"
- "スポーツ統計 外れ値処理"

### 4. ランキング・順位付け手法
- "ranking methods with extreme values"
- "percentile rank transformation"
- "ordinal transformation statistics"
- "順位付け 統計学 外れ値"
- "パーセンタイル順位 変換"

### 5. 機械学習での類似問題
- "feature scaling for skewed data"
- "quantile transformation sklearn"
- "power transformer machine learning"
- "機械学習 特徴量スケーリング 偏り"

---

## 📚 検索時の重要な制約条件

### ✅ 必ず守るべき条件

1. **計算ロジックは変更しない**
   - テン指数 = `((基準タイム - 実走前半3F)) × 10`
   - 位置指数 = `((基準順位 - 実際順位) / 頭数) × 100`
   - 上がり指数 = `((基準タイム - 実走後半3F)) × 10`
   - ペース指数 = `テン指数 - 上がり指数`
   - **これらの計算式自体は変更禁止**

2. **範囲は -100 ～ +100 に収める**
   - 最終的な指数値は -100 ～ +100 の範囲に収める必要がある
   - ただし、単純なクリップではなく、**情報を保持しながら範囲に収める**方法を探す

3. **相対的な大小関係を保持する**
   - 元の指数で A > B ならば、変換後も A > B であること
   - 順序が逆転しないこと（monotonic transformation）

4. **実装が可能であること**
   - Python + pandas/numpy で実装可能な手法
   - 競馬場・距離ごとの統計値を事前計算して保存することは可能

---

## 🔍 具体的な検索クエリ例

### 英語での検索クエリ

```
1. "handle extreme values without losing information statistics"
2. "transform skewed distribution to normal range preserving order"
3. "percentile-based scaling for outlier-heavy data"
4. "robust normalization methods for heavy-tailed distributions"
5. "horse racing speed figures normalization methods"
6. "quantile transformation vs robust scaler comparison"
7. "how to scale data with 70% values at boundary"
```

### 日本語での検索クエリ

```
1. "統計学 外れ値 情報を失わない変換"
2. "歪んだ分布 正規化 範囲内に収める"
3. "パーセンタイル変換 外れ値 頑健"
4. "競馬 指数 正規化 方法"
5. "順序を保持 非線形変換 統計"
6. "重裾分布 スケーリング 手法"
7. "境界値に70%集中 データ 正規化"
```

---

## 📖 期待される検索結果の内容

以下のような情報を含む論文・記事・技術文書を探してください：

### 1. 理論的背景
- なぜ単純なクリップが問題なのか
- 情報を保持しながら範囲を制限する理論
- 外れ値を含む分布の統計的処理方法

### 2. 具体的な手法
- **変換式**（数式）
- **実装方法**（コード例があれば理想的）
- **パラメータの決定方法**

### 3. 実例・事例研究
- 競馬やスポーツ統計での適用例
- 機械学習での類似問題の解決例
- 変換前後の分布の比較

### 4. 評価方法
- 変換の適切性をどう評価するか
- 情報損失の定量的評価方法

---

## 🎯 最終的に知りたいこと

**質問1**: 
現在の計算ロジック（基準タイム - 実測タイム × 10）を変更せずに、-100 ～ +100 の範囲に収めながら、**70%がクリップされる問題を解決する統計学的に正しい方法**は何ですか？

**質問2**: 
その方法は、**相対的な大小関係を保持**しながら、**情報損失を最小化**できますか？

**質問3**: 
競馬の指数計算で実際に使われている、または論文で推奨されている**ベストプラクティス**は何ですか？

**質問4**: 
Python + pandas/numpy で実装する場合、具体的にどのようなコードになりますか？

---

## 📌 補足情報

### データの統計情報

| 指数 | 最小値 | 最大値 | 平均値 | 中央値 | 標準偏差 |
|------|--------|--------|--------|--------|----------|
| テン指数 | -100 | 100 | -88.93 | -100 | 29.87 |
| 位置指数 | 0 | 50 | 9.33 | 3.85 | 14.52 |
| 上がり指数 | -100 | 40 | -11.04 | -10.0 | 18.59 |
| ペース指数 | -100 | 100 | -77.89 | -89.0 | 34.08 |

### クリップ前の実測値（推定）

- テン指数: 最小 約-1012、最大 約+279
- 位置指数: 最小 約-50、最大 約+50
- 上がり指数: 最小 約-527、最大 約+87
- ペース指数: 最小 約-948、最大 約+367

---

## 🚀 検索実行のお願い

以上の情報を基に、**統計学的・学術的に信頼できる解決方法**を調査してください。

特に以下の点を重視してください：
1. ✅ **学術論文や信頼できる統計学の文献**からの情報
2. ✅ **実装可能な具体的手法**（理論だけでなく実践例）
3. ✅ **競馬やスポーツ統計での適用事例**があれば最優先
4. ✅ **Python での実装方法**が示されているもの

---

**検索開始をお願いします！Play to Win! 🏆**
