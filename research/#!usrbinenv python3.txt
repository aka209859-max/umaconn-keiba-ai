#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
NAR AIäºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
å®Ÿè¡Œæ–¹æ³•: python main.py [--date YYYYMMDD]
ä¾‹: python main.py
ä¾‹: python main.py --date 20260105
"""

import sys
import argparse
from datetime import datetime, timedelta

sys.path.append('E:/UmaData/nar-analytics-python')

from config.db_config import get_db_connection
from core.data_fetcher import (
    get_tomorrow_races,
    get_races_by_date,
    get_race_info,
    get_venue_summary
)
from core.aas_calculator import calculate_race_aas_scores
from core.prediction_generator import save_all_predictions
from discord_notifier import send_race_to_discord, send_summary_to_discord

KEIBAJO_NAMES = {
    '30': 'é–€åˆ¥',
    '35': 'ç››å²¡',
    '36': 'æ°´æ²¢',
    '42': 'æµ¦å’Œ',
    '43': 'èˆ¹æ©‹',
    '44': 'å¤§äº•',
    '45': 'å·å´',
    '46': 'é‡‘æ²¢',
    '47': 'ç¬ æ¾',
    '48': 'åå¤å±‹',
    '50': 'åœ’ç”°',
    '51': 'å§«è·¯',
    '54': 'é«˜çŸ¥',
    '55': 'ä½è³€',
    '83': 'ã°ã‚“ãˆã„',
}

DISCORD_WEBHOOK_URL = "https://discordapp.com/api/webhooks/1457672476342616116/b89gldDK15mvmp0wguHvcshM5C4tj7C9mppSJ5zbNCDf8uG6VBSrSuiH6s2ZRsfWrVOd"
USE_DISCORD = True


def get_tomorrow_date():
    """æ˜æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYYMMDDå½¢å¼ï¼‰"""
    tomorrow = datetime.now() + timedelta(days=1)
    return tomorrow.strftime('%Y%m%d')


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    
    parser = argparse.ArgumentParser(description='NAR AIäºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ')
    parser.add_argument('--date', type=str, help='å¯¾è±¡æ—¥ä»˜ï¼ˆYYYYMMDDå½¢å¼ï¼‰')
    args = parser.parse_args()
    
    if args.date:
        target_date = args.date
    else:
        target_date = get_tomorrow_date()
    
    print("=" * 80)
    print("NAR AIäºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ")
    print(f"å¯¾è±¡æ—¥ä»˜: {target_date}")
    print("=" * 80)
    
    try:
        print("\nğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...")
        conn = get_db_connection()
        
        print("\nã€ã‚¹ãƒ†ãƒƒãƒ—0ã€‘é–‹å‚¬ç«¶é¦¬å ´ã®ç¢ºèª")
        cur = conn.cursor()
        
        query = """
        SELECT 
            keibajo_code,
            COUNT(DISTINCT race_bango) as race_count,
            COUNT(*) as horse_count
        FROM nvd_se
        WHERE kaisai_nen || kaisai_tsukihi = %s
        GROUP BY keibajo_code
        ORDER BY keibajo_code
        """
        
        cur.execute(query, (target_date,))
        venue_stats = cur.fetchall()
        
        if not venue_stats:
            print(f"âŒ {target_date}ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            cur.close()
            conn.close()
            return
        
        print(f"{'ç«¶é¦¬å ´':<12} {'ãƒ¬ãƒ¼ã‚¹æ•°':>8} {'å‡ºèµ°é ­æ•°':>8}")
        print("-" * 40)
        
        total_races = 0
        total_horses = 0
        
        for row in venue_stats:
            code = row['keibajo_code']
            name = KEIBAJO_NAMES.get(code, f'ä¸æ˜{code}')
            race_count = row['race_count']
            horse_count = row['horse_count']
            
            print(f"{name:<12} {race_count:>8} {horse_count:>8}")
            total_races += race_count
            total_horses += horse_count
        
        print("-" * 40)
        print(f"{'åˆè¨ˆ':<12} {total_races:>8} {total_horses:>8}")
        
        cur.close()
        
        if USE_DISCORD and DISCORD_WEBHOOK_URL:
            venue_list = [
                {
                    'name': KEIBAJO_NAMES.get(row['keibajo_code'], f"ä¸æ˜{row['keibajo_code']}"),
                    'races': row['race_count'],
                    'horses': row['horse_count']
                }
                for row in venue_stats
            ]
            send_summary_to_discord(DISCORD_WEBHOOK_URL, target_date, total_races, total_horses, venue_list)
        
        print("\nã€ã‚¹ãƒ†ãƒƒãƒ—1ã€‘å¯¾è±¡ãƒ¬ãƒ¼ã‚¹ä¸€è¦§å–å¾—")
        races = get_races_by_date(conn, target_date)
        print(f"âœ… å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°: {len(races)}ãƒ¬ãƒ¼ã‚¹")
        
        if not races:
            print(f"âŒ {target_date}ã®ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            conn.close()
            return
        
        print("\nã€ã‚¹ãƒ†ãƒƒãƒ—2ã€‘å‡ºèµ°é¦¬ãƒ‡ãƒ¼ã‚¿å–å¾—")
        horses = get_tomorrow_races(conn, target_date)
        print(f"âœ… å‡ºèµ°é¦¬æ•°: {len(horses)}é ­")
        
        print("\nã€ã‚¹ãƒ†ãƒƒãƒ—3ã€‘å‰èµ°ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»çµ±åˆ")
        # get_tomorrow_races() ãŒæ—¢ã«å‰èµ°ãƒ‡ãƒ¼ã‚¿è¾¼ã¿ã§è¿”ã™ãŸã‚ã€è¿½åŠ å‡¦ç†ã¯ä¸è¦
        with_prev = sum(1 for h in horses if h.get('prev_chakujun'))
        without_prev = len(horses) - with_prev
        print(f"  å‰èµ°ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š: {with_prev}é ­")
        print(f"  å‰èµ°ãƒ‡ãƒ¼ã‚¿ãªã—: {without_prev}é ­")
        print("âœ… ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†")
        
        print("\nã€ã‚¹ãƒ†ãƒƒãƒ—4ã€‘ãƒ¬ãƒ¼ã‚¹æƒ…å ±å–å¾—")
        race_infos = {}
        
        for race in races:
            keibajo_code = race['keibajo_code']
            kaisai_date = race['kaisai_date']
            race_bango = race['race_bango']
            
            race_info = get_race_info(conn, keibajo_code, kaisai_date, race_bango)
            
            if race_info:
                race_key = f"{keibajo_code}_{race_bango}"
                race_info['keibajo_code'] = keibajo_code
                race_infos[race_key] = race_info
        
        print(f"âœ… ãƒ¬ãƒ¼ã‚¹æƒ…å ±å–å¾—å®Œäº†: {len(race_infos)}ãƒ¬ãƒ¼ã‚¹")
        
        print("\nã€ã‚¹ãƒ†ãƒƒãƒ—5ã€‘HQSå¾—ç‚¹è¨ˆç®—")
        
        all_predictions = {}
        
        for race in races:
            keibajo_code = race['keibajo_code']
            race_bango = race['race_bango']
            race_key = f"{keibajo_code}_{race_bango}"
            
            race_horses = [
                h for h in horses
                if h['keibajo_code'] == keibajo_code and h['race_bango'] == race_bango
            ]
            
            if not race_horses:
                continue
            
            race_info = race_infos.get(race_key)
            if not race_info:
                continue
            
            try:
                predictions = calculate_race_aas_scores(conn, race_horses, race_info)
                
                if predictions:
                    all_predictions[race_key] = predictions
                    
                    keibajo_name = KEIBAJO_NAMES.get(keibajo_code, f'ç«¶é¦¬å ´{keibajo_code}')
                    race_bango_int = int(race_bango)
                    
                    print(f"\nã€{keibajo_name} {race_bango_int:02d}Rã€‘")
                    print("-" * 60)
                    print(f"{'é †ä½':>4} {'é¦¬ç•ª':>4} {'é¦¬å':<20} {'HQSå¾—ç‚¹':>8} {'åå·®å€¤':>6}")
                    print("-" * 60)
                    
                    for rank, horse in enumerate(predictions[:11], 1):
                        umaban = int(horse['umaban'])
                        bamei = horse['bamei']
                        hqs = horse['total_aas']
                        hensachi = horse.get('hensachi', 50.0)
                        
                        print(f"{rank:>4} {umaban:>4}ç•ª {bamei:<20} {hqs:>7.1f}ç‚¹ {hensachi:>5.1f}")
                    
                    if USE_DISCORD and DISCORD_WEBHOOK_URL:
                        send_race_to_discord(DISCORD_WEBHOOK_URL, keibajo_name, race_bango_int, predictions)
                
            except Exception as e:
                print(f"âŒ {keibajo_code} {race_bango}R ã®HQSè¨ˆç®—ã‚¨ãƒ©ãƒ¼: {e}")
                import traceback
                traceback.print_exc()
                continue
        
        print(f"\nâœ… HQSå¾—ç‚¹è¨ˆç®—å®Œäº†")
        
        print("\nã€ã‚¹ãƒ†ãƒƒãƒ—6ã€‘äºˆæƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ")
        
        base_output_dir = "E:/UmaData/nar-analytics-python/output"
        
        saved_files = save_all_predictions(all_predictions, race_infos, target_date, base_output_dir)
        
        print(f"\nâœ… äºˆæƒ³ç”Ÿæˆå®Œäº†")
        print(f"  åŸºæœ¬äºˆæƒ³: {len(saved_files['basic'])}ãƒ•ã‚¡ã‚¤ãƒ«")
        print(f"  noteç”¨: {len(saved_files['note'])}ãƒ•ã‚¡ã‚¤ãƒ«")
        print(f"  ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : {len(saved_files['premium'])}ãƒ•ã‚¡ã‚¤ãƒ«")
        print(f"\nğŸ“ å‡ºåŠ›å…ˆ: {base_output_dir}/{target_date}/")
        
        conn.close()
        print("\nâœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’çµ‚äº†ã—ã¾ã—ãŸ")
        
    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback
        traceback.print_exc()


if __name__ == '__main__':
    main()
