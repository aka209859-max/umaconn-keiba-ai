地方競馬データ統合基盤「UmaConn」における競馬場コード体系と実装詳細に関する包括的調査報告書
1. 要旨
本報告書は、日本の地方競馬（NAR: National Association of Racing）におけるデータ流通の基盤となるミドルウェア「UmaConn（地方競馬DATA）」のアーキテクチャ、およびその中でデータの主キーとして機能する「競馬場コード（Jyo-CD）」の体系について、技術的・実務的観点から網羅的に調査・分析したものである。中央競馬（JRA）とは異なり、複数の主催者が独立して開催を行う地方競馬においては、データ構造の標準化が極めて複雑な課題となる。特に、システム内部で使用されるコード体系（30番台～80番台）と、旧来の電話投票等で使用される管理コードとの乖離は、開発者やデータアナリストにとって大きな障壁となってきた。
本調査では、提供された技術資料、API仕様、および実際のデータスニペットに基づき、UmaConnの技術仕様（NVDTLabLibライブラリの挙動を含む）を解明するとともに、全地方競馬場を網羅する確定的なコード対応表を作成した。さらに、各競馬場コードに紐づく騎手データや開催傾向を詳細に分析し、単なる数値の羅列ではない、データが内包する「地域特性（ローカリズム）」を明らかにする。これにより、地方競馬データを活用したソフトウェア開発、予測モデル構築、および学術的研究に資する基礎資料を提供することを目的とする。
2. 序論：地方競馬データのエコシステムと課題
2.1 地方競馬（NAR）の構造的特殊性
日本国内の競馬産業は、日本中央競馬会（JRA）と地方競馬全国協会（NAR）という二つの大きな枠組みによって構成されている。JRAが単一の組織として全国10箇所の競馬場を統括し、均質なデータ管理を行っているのに対し、NARは北海道から九州まで、各自治体（県や市、一部事務組合）が主催者として個別に開催運営を行っている。この「分散型」の構造は、データ統合において極めて高い難易度をもたらしている。
各主催者は歴史的に独自のトータリゼータシステム（富士通フロンテック、日本トーター等）を採用しており、データフォーマットも微細な差異を含んでいた。これらを統一的なインターフェースで外部提供するために構築されたのが「地方競馬DATA（通称：UmaConn）」である。
2.2 UmaConn（地方競馬DATA）の位置付け
UmaConnは、JRA関連のデータサービス「JRA-VAN Data Lab.」のスキームを利用して提供されているが、その実体はJRAのデータストリームとは完全に独立したものである。開発者や利用者は、JRAのデータを利用するための「JV-Link」とは別に、地方競馬専用のモジュールである「UmaConn（NV-Link）」をインストールし、別途契約を行う必要がある。
スニペットにあるように、競馬ソフト「KMY Keiba」などの開発プロジェクトにおいては、JV-LinkとUmaConnの両方のSDK（Software Development Kit）を組み込むことが求められる。これは、同一の「競馬」というドメインを扱いつつも、そのデータアクセスの作法やライブラリが物理的に分かれていることを示唆している。
3. 技術的アーキテクチャ：UmaConnの実装詳細
UmaConnを利用したデータ取得システムの構築には、Windows環境におけるレガシー技術であるCOM（Component Object Model）の深い理解が不可欠である。ここでは、提供されたスニペットに基づき、その実装詳細を解析する。
3.1 COMインターフェースとライブラリ仕様
UmaConnの中核を成すのは、クライアントPCにインストールされるNVDTLab.dllというダイナミックリンクライブラリである。このDLLは、外部アプリケーションに対してCOMインターフェースを公開しており、開発者はこのオブジェクトをインスタンス化することで、NARのサーバー群と通信を行う。
 * ProgID（プログラムID）: NVDTLabLib.NVLink
   * 開発者はこのIDを指定してオブジェクトを呼び出す必要がある。スニペットでは、NVDTLabではなくNVDTLabLibを使用するよう注意喚起がなされている。これは、タイプライブラリの名称空間とクラス名が混同されやすいためで、実装時の一般的な落とし穴である。
 * アーキテクチャ制約: 32-bit (x86)
   * 現代のOSは64-bitが主流であるが、UmaConnのDLLは32-bitアーキテクチャでコンパイルされている。そのため、PythonやC#でクライアントを開発する場合、実行環境（インタプリタやビルドターゲット）を強制的に32-bitに合わせる必要がある。64-bitのPython環境からwin32com.client.Dispatchを呼び出しても、クラス登録が見つからないか、ロードに失敗する。
3.2 Pythonによる実装フローの解析
スニペットには、Pythonを用いた具体的な接続コードが含まれている。このコードは、UmaConnの典型的なライフサイクル（初期化→オープン→取得→終了）を表している。
3.2.1 初期化フェーズ (NVInit)
import win32com.client

# 32-bit Python環境で実行必須
NVLink1 = win32com.client.Dispatch("NVDTLabLib.NVLink")
return_code = NVLink1.NVInit("UNKNOWN")

NVInitメソッドは、ライブラリの内部状態を初期化し、認証サーバーへの接続準備を行う。引数として渡されている"UNKNOWN"は、API仕様上のプレースホルダーである可能性が高い。多くのレガシーAPIでは、将来の拡張のために予約引数を設けるが、UmaConnにおいては固定値として運用されていることが読み取れる。
3.2.2 データストリームのオープン (NVOpen)
dataspec = 'RACE'            # データ種別：レース情報
fromtime = 20240126000000    # 取得開始点：2024年1月26日
option = 3                   # 取得オプション
returnval = NVLink1.NVOpen(dataspec, fromtime, option, 0, 0, '')

NVOpenメソッドは、特定のデータセットに対するカーソルを開く操作に相当する。
 * dataspec: 'RACE'（出馬表、成績）、'ODDS'（オッズ）、'BLOD'（血統）など、取得したいデータの種類を指定する4文字のコード。
 * fromtime: データの取得開始時刻をYYYYMMDDHHMMSS形式で指定する。これは、差分更新を行うシステムにおいて極めて重要なパラメータである。
 * option: 取得モードを指定する。通常、リアルタイム取得、過去データの一括取得、セットアップダイアログの表示有無などを制御するフラグとして機能する。
3.3 データ構造とパース処理の課題
UmaConnから返却されるデータは、JSONやXMLのような自己記述的な形式ではなく、固定長（Fixed Width）またはCSV形式のバイトストリームであることが一般的である（JRA-VANの仕様に準拠するため）。したがって、開発者は「何バイト目から何バイト目までが馬名」「次のコードが性別」といった厳密な仕様書に基づいたパーサーを実装する必要がある。
スニペットで「C#などを用いた方が効率的かもしれない」と述べられているのは、静的型付け言語の方がこうした構造体のマッピング（Marshalling）を安全に行えるためであると推測される。
4. 競馬場コード（Jyo-CD）体系の完全解析
地方競馬データを扱う上で最大の躓きとなるのが、「競馬場コード」の多重性である。歴史的経緯により、**「電話投票用コード（旧コード）」と「システム用コード（UmaConn/IPATコード）」の二種類が並存しており、これらを正しく使い分けることがデータ統合の鍵となる。本報告書では、UmaConnおよび現代のWebサービス（netkeiba等）で標準的に使用されているシステム用コード（30番台～80番台）**を主軸に分析を行う。
4.1 競馬場コード対応表（確定版）
以下の表は、各リサーチスニペットから抽出・検証されたコード対応の完全版である。特に、システムコード（UmaConn）と電話投票コードの差異に留意されたい。
| 地域ブロック | 競馬場名 | システムコード
(UmaConn/IPAT) | 電話投票
コード | 特記事項・データ特性 |
|---|---|---|---|---|
| 北海道 | 門別 (Mombetsu) | 30 | 06 | ナイター開催「グランシャリオ」。2歳戦の供給源。 |
| 北海道 | 帯広 (Obihiro) | 83 | 03 | ばんえい競馬。データ構造が平地と根本的に異なる。 |
| 岩手 | 盛岡 (Morioka) | 35 | 11 | 左回り・ダート＆芝コース併設。愛称「OROパーク」。 |
| 岩手 | 水沢 (Mizusawa) | 36 | 12 | 右回り・小回りコース。冬季開催の主力。 |
| 南関東 | 浦和 (Urawa) | 42 | 31 | 左回り。住宅街の中にあるコンパクトなコース。 |
| 南関東 | 船橋 (Funabashi) | 43 | 32 | 左回り。「スパイラルカーブ」採用。森泰斗騎手の拠点。 |
| 南関東 | 大井 (Oi) | 44 | 33 | 右回り。地方競馬の総本山。G1競走多数開催。 |
| 南関東 | 川崎 (Kawasaki) | 45 | 34 | 左回り。コーナーがきついことで有名。 |
| 北陸 | 金沢 (Kanazawa) | 46 | 22 | 冬季（1-2月）は休催期間あり。 |
| 東海 | 笠松 (Kasamatsu) | 47 | 23 | 右回り。内馬場にパドックが存在。オグリキャップの故郷。 |
| 東海 | 名古屋 (Nagoya) | 48 | 24 | 右回り。2022年に弥富へ移転したがコードは継承。 |
| 兵庫 | 園田 (Sonoda) | 50 | 27 | 右回り。関西圏の主力。ナイター開催あり。 |
| 兵庫 | 姫路 (Himeji) | 51 | 28 | 右回り。開催頻度は不定期（園田の代替開催など）。 |
| 高知 | 高知 (Kochi) | 54 | 31 | 右回り。「一発逆転ファイナルレース」で著名。通年ナイター。 |
| 九州 | 佐賀 (Saga) | 55 | 32 | 右回り。パドックがコース内側にある。九州唯一のNAR。 |
4.2 コード体系の論理構造分析
このコード体系（30～83）は、北から南への地理的配列に基づいているが、いくつかの「欠番」が存在する。
 * 30番台（北海道・東北）: 30（門別）から始まり、35（盛岡）へ飛ぶ。この間の欠番（31-34）は、かつて存在した旭川、岩見沢、北見といった廃止された競馬場、あるいは将来的な拡張のために予約されていたコードの名残であると考えられる。
 * 40番台（関東・中部）: 42～48まで密に詰まっている。これは南関東4場（浦和・船橋・大井・川崎）と東海・北陸ブロックが地理的に近接し、かつ存続しているためである。
 * 83番（帯広ば）: 他の平地競馬（30-55）から大きく離れた83が割り当てられている。これは「ばんえい競馬」という競技自体の特殊性（ソリを曳く、障害がある、タイムスケールが異なる）をシステム上で明確に区別するためのフラグとして機能している。
5. 地域別データプロファイルと詳細分析
UmaConnから取得できるデータは、単なるレース結果の羅列ではない。各競馬場コードの背後には、固有の騎手ヒエラルキー、コース特性、開催スケジュールが存在する。リサーチスニペットから得られた具体的情報を基に、各コードが持つデータの「意味」を解読する。
5.1 コード44/43/45/42：南関東4場のデータ連関
南関東（大井・船橋・川崎・浦和）は、地方競馬の中でも最大規模の売上とレベルを誇る。
 * 大井競馬場（Code 44）:
   スニペットによれば、的場文男騎手が7,424勝、矢野貴之騎手が3,055勝、御神本訓史騎手が3,003勝を挙げている。データ分析の観点からは、「Code 44における的場騎手」の重み付けは極めて重要である。7,000勝を超えるレジェンドの存在は、オッズ（人気指数）に過剰なバイアスを与える可能性があり、予測モデルにおいては「実力」と「人気」の乖離要因として扱う必要がある。
   また、大井はフルゲート16頭という地方競馬では最大の多頭数レースが行われるため、Code 44のデータは「枠順の有利不利」や「展開の紛れ」の分散が他の競馬場（通常12頭以下）よりも大きくなる傾向がある。
 * 船橋競馬場（Code 43）:
   スニペットでは、森泰斗騎手が4,448勝でリーディングを牽引していることが示されている（注：森騎手は引退を表明している場合があるが、過去データ分析においては絶対的な王者である）。船橋所属の騎手が川崎（Code 45）や大井（Code 44）に遠征して勝利することも日常的であり、南関東4場のデータは「相互乗り入れ」を前提としたクロスリファレンスが必要となる。
5.2 コード50/51：兵庫県競馬の二重構造
兵庫県競馬組合は、園田（Code 50）と姫路（Code 51）の二つの競馬場を運営しているが、その実態は「本場（園田）」と「代替地（姫路）」に近い関係にある。
 * 騎手の連続性: スニペットの姫路競馬場のデータを見ると、1位は川原正一（5,912勝）、2位は田中学、3位は下原理、4位は吉村智洋となっている。これらトップ騎手は全員「兵庫所属」であり、園田（Code 50）でも同様に上位を独占している。
 * Code 51の特殊性: 姫路開催は数年に一度の改修工事期間中や、冬季の限定的な期間に行われることが多い。そのため、Code 51のデータは時系列上で断続的に出現する。機械学習モデルを構築する際、Code 51のデータを独立した母集団として扱うとサンプル不足に陥る可能性があるため、Code 50と統合して「兵庫ブロック」として学習させるなどの特徴量エンジニアリングが有効である示唆が得られる。
5.3 コード54：高知競馬の「一発逆転」データ
高知競馬場（Code 54）は、独自の番組編成とナイター開催でV字回復を遂げたことで知られる。
 * 騎手データの特徴: スニペットには赤岡修次、宮川実といった名手の名前が挙がる。高知競馬は通年開催であり、かつ1日のレース数も多いため、これらのトップ騎手は年間を通じて極めて高い騎乗回数と勝利数を記録する。Code 54のデータにおいては、特定の上位騎手への勝率集中度が他場に比べて著しく高い（パレートの法則が強く働く）傾向があることが予想される。
 * 「一発逆転ファイナルレース」: 高知の名物である最終レースは、近走成績の振るわない馬を集めて混戦を演出する番組である。データ上では「前走着順が悪い馬」が突如として勝利するパターンが頻出するため、Code 54の第12レース（あるいは最終競走）に関しては、通常のロジックとは異なる予測アルゴリズム（例：騎手買い、馬場適性重視）を適用する必要がある。
5.4 コード46：金沢競馬の季節性と開催サイクル
スニペットは、金沢競馬（Code 46）の詳細なスケジュールと騎手成績を提供している。
 * スケジュールの空白: （3月日程）や（11月日程）には開催があるが、金沢は降雪地帯であるため、通常1月〜2月は開催が行われない（あるいは変則日程となる）。この「冬季休催」はデータ分析において重要である。休養明けの馬が一斉に出走する3月の開催（Code 46）では、前走からの間隔（Interval）の評価を緩和する必要がある。
 * 騎手リーディング: の2024年リーディング表によれば、中島龍也騎手が勝率23.7%、連対率41.8%という驚異的な数字で1位となっている。次いで栗原大河、吉田晃浩と続く。また、5位にランクインしている吉原寛人騎手（勝率27.9%）は、全国の地方競馬場へスポット参戦（短期免許や重賞騎乗）することで知られる「ミスター地方競馬」的実力者である。Code 46以外の競馬場（例えばCode 54の高知やCode 35の盛岡）の重賞レースデータに「Yoshihara」の名前が出現した場合、その勝率は地元騎手以上に警戒すべきファクターとなる。
5.5 コード83：帯広（ばんえい）の異次元データ
帯広競馬場（Code 83）は、世界唯一の「ばんえい競馬」を行う。
 * データ構造の断絶: スニペットで挙げられている藤本匠、鈴木恵介といった騎手たちは、平地競走の騎手とは求められるスキルセットが全く異なる。
 * 「重量」の意味: 通常の競馬（Code 30-55）において「斤量（Weight）」は50kg〜58kg程度であり、騎手の体重＋装具を意味する。しかし、Code 83のデータにおける「重量」は450kg〜1000kgという値をとり、これは「ソリの重量（Banei Weight）」を指す。同じデータベースカラム（例：RACE_WEIGHT）を使用していても、Code 83の場合だけ単位と物理的な意味が異なるため、システム実装時にはIF Code == 83という分岐処理が不可欠となる。また、スニペットにはないが、ばんえい競馬では「馬場水分（Moisture）」がレース展開（ソリの滑りやすさ）を決定づける最重要ファクターであり、これもCode 83特有の必須データ項目となる。
6. データ構造と外部システム連携（IPAT・API）
UmaConnから取得したデータは、最終的に投票システムや分析ソフトで利用される。ここでは、外部連携におけるコードの取り扱いについて詳述する。
6.1 IPAT連携におけるパラメータ仕様
JRAが提供するインターネット投票システム「IPAT」を通じて地方競馬を購入する場合、特定のAPIリクエストを構築する必要がある。スニペットにあるTeam NaveのAPIドキュメントは、この際のリクエストパラメータを明確に定義している。
 * rcsパラメータ: これが本報告書の主題である「競馬場コード」に対応する。
   * 47=笠松, 48=名古屋, 61=中京（JRAだが地方開催扱いの場合あり）, 50=園田...といったマッピングが必須となる。
 * kind（式別）パラメータ:
   * TAN（単勝）, FUKU（複勝）, WAKU（枠連）, UMAFUKU（馬連）, UMATAN（馬単）, WIDE（ワイド）, SANTAN（3連単）, SANFUKU（3連複）。
   * Win5等の特殊賭式は地方競馬の一部では非対応の場合があり、コードごとに有効なkindをフィルタリングする必要がある。
6.2 netkeiba等のWebサービスにおけるURL構造
国内最大級の競馬サイトnetkeiba.comのURL構造も、このシステムコードに準拠している。
 * URLパターン: https://nar.netkeiba.com/racecourse/data_room.html?jyo_cd=XX
   * ここでjyo_cd=44とすれば大井、jyo_cd=55とすれば佐賀のページが表示される。
   * この事実は、Webスクレイピングや外部データとの突合を行う際、この2桁のコードが「共通言語」として機能することを示している。システム開発者は、独自のIDを採番するのではなく、このNAR標準の2桁コードを内部IDとして採用することで、エコシステム全体との親和性を保つことができる。
7. 結論と提言
本調査により、UmaConnおよび地方競馬データのエコシステムは、一見複雑に見えるものの、**「30番台～80番台のシステムコード」**という強固な背骨によって支えられていることが判明した。
7.1 開発者への提言
 * 32-bit環境の維持: UmaConnのDLL（NVDTLabLib）を利用する限り、Pythonやアプリケーションのランタイムは32-bit版を選択しなければならない。これは技術的負債とも言えるが、現状の仕様である以上、Dockerコンテナ等で専用の32-bit環境を隔離構築することが推奨される。
 * コードマッピングの厳格化: 電話投票コード（01-36）は過去の遺物となりつつある。新規開発においては、本報告書4.1節で提示したシステムコード（30-83）に統一すべきである。
 * 地域特性を考慮した例外処理: 特にCode 83（帯広）のデータハンドリング、Code 46（金沢）の冬季休催、Code 54（高知）の特異なレース編成については、アプリケーションレベルでのロジック分岐（Strategy Patternの適用等）を実装すべきである。
7.2 データサイエンスへの示唆
地方競馬の予測モデルにおいて「全場統一モデル」を作成することは、データの質的相違（ばんえいの重量、高知の逆転ファイナル、南関のレベル差）から推奨されない。むしろ、**「南関東ブロック（42-45）」「兵庫ブロック（50-51）」「高知（54）」「ばんえい（83）」**といったクラスタごとに個別のモデルを構築し、それらをアンサンブルするアプローチが、データの統計的性質から見て最も合理的であると結論付けられる。
本報告書が、日本の地方競馬データの深淵に挑むエンジニアおよび研究者の一助となることを願う。
