地方競馬（NAR）における次世代超高精度スピード指数「NAR-SI」の設計と実装に関する包括的技術報告書1. 序論：地方競馬予測におけるパラダイムシフトと技術的要件1.1 プロジェクトの背景と戦略的意義日本の地方競馬（National Association of Racing, NAR）は、全国15の競馬場によって構成される巨大な公営競技ネットワークである。中央競馬（JRA）が比較的均質な芝・ダートコースと管理体系を持つのに対し、地方競馬は北は北海道の帯広（ばんえい）から南は高知・佐賀に至るまで、極めて多様な環境下で施行されている。この「環境の不均質性」こそが、従来の画一的なスピード指数や予測モデルの精度を阻害する最大の要因であった。現在、貴組織が開発を進める「NAR AI予想」システムにおいて、既存の「基準タイム - 実走破タイム」という単純な線形モデルからの脱却は急務である。特に、2024年から2026年というデータ対象期間には、大井競馬場における砂厚の変更（10cmから9cmへの移行）1や、名古屋競馬場の新コースへの完全移行2といった構造的な変化が含まれており、これらを動的に補正できない静的なモデルは、即座に陳腐化するリスクを孕んでいる。本報告書は、Beyer Speed Figures（米国）やTimeform（欧州）といった世界標準の指数理論を、日本の地方競馬特有の「深い砂」「小回り」「変則開催」といったコンテキストに最適化し、機械学習（Machine Learning）と統計的推論を融合させた次世代型指数「NAR-Speed Index (NAR-SI)」の設計仕様を定義するものである。これは単なる数値計算の羅列ではなく、競馬場という物理空間と、競走馬という生体システムの相互作用を解明する数理モデルの構築提案である。1.2 地方競馬特有の技術的障壁と解決の方向性地方競馬のデータ分析において直面する課題は、JRAや欧米の主要競馬場とは比較にならないほど複雑である。本調査では、以下の主要な障壁に対し、具体的な解決策を提示する。馬場状態の非線形性と砂の物理特性地方競馬のダートコースは、単に「良」「重」といった含水率の区分だけでなく、砂の産地（オーストラリア産白砂、愛知県産砂など）や粒子サイズ、そして路盤のクッション性によってタイムが劇的に変動する1。従来の定数加算方式（重馬場なら-1.0秒など）では、この複雑な物理現象を捉えきれない。解決策として、日次（Daily）およびレース単位での動的バリアント（Dynamic Track Variant）の算出アルゴリズムを導入する。コースジオメトリ（形状）の多様性園田・姫路競馬場のスパイラルカーブ3や、高知競馬場の内ラチ沿いの深い砂5など、コース形状がレース展開（Pace Shape）に与える影響は甚大である。これらを「トラックバイアス」として数値化し、指数計算の補正項として組み込む必要がある。ばんえい競馬の特異性帯広で開催されるばんえい競馬は、ソリを引く重量引き競技であり、タイムの価値観が平地競走とは根本的に異なる。「スピード」ではなく「パワー」と「障害飛越能力」を数値化するための専用ロジック（Ban'ei Power Index）を設計する6。スパースデータ（疎データ）の問題地方競馬では、特定の競馬場・地区内での交流が主であり、他地区の馬との対戦機会が限られる。これにより、異なる競馬場間の指数を統一基準で比較（スケーリング）することが数学的に困難となる（連結成分が分断される問題）。これに対し、機械学習を用いた転移学習や、交流重賞をブリッジとした標準化手法を提案する8。2. 世界標準指数の理論的解剖とNARへの適用可能性世界最高レベルの指数を構築するためには、まず既存の権威ある指数が「なぜ優れているのか」、そして「なぜそのままでは地方競馬に使えないのか」を深く理解する必要がある。2.1 Beyer Speed Figures（米国）：動的補正の金字塔アンドリュー・ベイヤーによって1970年代に体系化されたBeyer Speed Figuresは、北米競馬における事実上の標準通貨である。2.1.1 計算ロジックの核心Beyer指数の本質は、「基準タイム（Par Time）」からの偏差を計算し、それを「トラックバリアント（Track Variant）」で調整する点にある10。$$\text{Beyer Figure} = \text{Projected Figure} + \frac{(\text{Par Time} - \text{Actual Time})}{\text{Scale Factor}} + \text{Daily Track Variant}$$ここで重要なのは、**Track Variant（馬場差）**の算出方法である。ベイヤーの手法では、その日に開催された複数のレースの結果を用い、それぞれの勝ち馬が「本来走るべきタイム（Par Time）」と「実際に走ったタイム」の差を平均化することで、その日の馬場が「基準より何ポイント速かったか/遅かったか」を導き出す11。2.1.2 地方競馬への適用における課題と解決策課題: ベイヤー式は、各クラス（条件戦、未勝利戦など）のPar Timeが正確に設定されていることを前提とする。しかし、地方競馬の下級条件（C3クラスなど）は能力のばらつきが極めて大きく、平均値が安定しないため、Par Timeの設定自体が困難である。解決策: 平均値（Mean）ではなく、**中央値（Median）**または分位点回帰を用いたロバストな基準タイム設定を行う。また、バリアント計算において、極端なスローペースや異常値を除外するフィルタリングアルゴリズムを強化する。2.2 Timeform Ratings（欧州）：斤量と着差の厳密化英国のTimeformは、タイムだけでなく、負担重量（Weight）と着差（Beaten Lengths）を厳密にポイント換算する点で優れている。2.2.1 斤量と距離の相関関係Timeformの理論では、負担重量の影響は距離によって変動する。一般に、距離が長くなるほど1ポンド（約0.45kg）の重量がスタミナに与える影響は大きくなるが、タイムへの換算係数は逆に短距離の方が大きくなる傾向がある（短距離はコンマ数秒の価値が高いため）13。Timeformの換算例:5ハロン（約1000m）: 1馬身 ≒ 3ポンド12ハロン（約2400m）: 1馬身 ≒ 1.5ポンド2.2.2 地方競馬への適用現在の「一律 0.2秒/kg」という補正式は、1200m戦と2000m戦を同列に扱っており、物理学的に不正確である。距離ごとの運動エネルギー減衰モデルに基づき、距離係数（Distance Coefficient）を導入すべきである。2.3 Brisnet Pace Ratings（米国）：レース展開の数値化Brisnetは、E1（Start to 1st Call）、E2（Start to 2nd Call）、LP（Late Pace）という3つの部分指数を提供している15。2.3.1 「流れ」の可視化地方競馬、特に小回りコースでは、最終タイムが速くても「道中のペース」が緩ければ、逃げ馬が残るのは当然である。逆に、ハイペース（High E1/E2）で潰れた先行馬は、着順が悪くても能力を再評価する必要がある。適用策: 地方競馬のデータには詳細なラップタイムがない場合が多いが、prev_soha_time（走破タイム）とprev_kohan_3f（上がり3F）の差分から、「前半タイム」を逆算し、これを擬似的なE2指数として扱う。2.4 Quirin Speed Points：位置取りの傾向分析ウィリアム・クリン博士のSpeed Pointsは、馬の絶対的な速さではなく「レース内での相対的な位置取り」を点数化したものである17。概念: スタート直後やコーナーでの通過順位に基づき、0〜8点のポイントを付与する。NARへの応用: prev_corner_1 〜 prev_corner_4 のデータを活用し、その馬が「逃げ型」「先行型」「差し型」のどのクラスタに属するかを分類。指数計算時の補正（例えば、前残りの馬場で差し馬が好走した場合のボーナス加点）に使用する。3. NAR特有の環境変数を組み込む数理モデル既存の指数理論をベースにしつつ、地方競馬独自の変数を処理するための数理モデルを構築する。3.1 基準タイム（Par Time / Standard Time）のロバスト推定3.1.1 統計的アプローチの選定調査課題にある「基準タイムの算出方法」について、地方競馬のデータ特性（外れ値が多い、クラス編成が頻繁に変わる）を考慮すると、**中央値（Median）**の採用が統計的に最も妥当である。$$T_{std}(Track, Dist, Class) = \text{Median}(\{t_i \mid \text{cond}_i = \text{Good}, |Z_i| < 2.0\})$$ここで、$t_i$ は各レースの走破タイム、$\text{cond}_i$ は馬場状態、$Z_i$ はタイムの標準化スコア（Z-score）である。異常なタイム（大差負けや故障発生時）を $|Z_i| < 2.0$ （標準偏差の2倍以内）のフィルタで除去した上で、中央値を採用することで、極端なデータの影響を排除する12。3.1.2 欠損データの補完（Imputation Strategy）一部の競馬場・距離では開催数が少なく、十分なサンプルが得られない（データ欠損）。この場合、以下の**距離間回帰（Distance Regression）**を用いて基準タイムを推定する。$$\ln(T_{std}) = \alpha + \beta \ln(\text{Distance})$$走破タイムと距離の関係は、対数線形関係に近いことが知られている（Power Law）。近隣の距離データから回帰直線を求め、データ不足距離の基準タイムを補間する。3.2 馬場状態の定量的評価（Dynamic Track Variant）3.2.1 砂厚と産地の影響大井競馬場の事例1に見られるように、砂の深さが1cm変わるだけで、走破タイムには1秒以上の差が生じることがある。これを「良」「重」という離散的なコードだけで処理するのは不可能である。3.2.2 日次バリアント（DTV: Daily Track Variant）の計算式その日の馬場が「標準よりどれだけ速いか/遅いか」を表すDTVを、以下の手順で算出する。レースごとのパフォーマンス偏差 ($P_r$) の計算:レース $r$ の上位 $k$ 頭（例えば3着まで）について、基準タイムとの差を計算する。$$P_r = \frac{1}{k} \sum_{j=1}^{k} (T_{std}(r) - T_{actual}(j))$$日次集計:その日の全レース $R$ について、重み付き平均をとる。スローペースのレースや少頭数のレースは重み $w_r$ を小さくする。$$DTV = \frac{\sum_{r \in R} w_r P_r}{\sum w_r}$$この $DTV$ が正であれば「高速馬場」、負であれば「時計のかかる馬場」と判定され、個々の馬の指数計算時に加算・減算される。3.3 コース形状によるバイアス補正（Geometry Bias）3.3.1 スパイラルカーブ（園田・姫路・船橋）スパイラルカーブは、入口が緩やかで出口がきつい（またはその逆）設計により、遠心力の影響を軽減し、スピードを維持したままコーナーを回れる構造である3。現象: 通常の小回りコースよりも「マクリ（向正面から一気に位置を上げる戦法）」が決まりやすい。補正項: コーナー通過順位の変化率（$\Delta \text{Position}$）を評価関数に加える。$$\text{Spiral Bonus} = \alpha \times (\text{Pos}_{3rd\_corner} - \text{Pos}_{4th\_corner})$$3角から4角で順位を上げた馬に対し、指数を上方修正する。3.3.2 直線距離とコース幅（名古屋・大井）名古屋競馬場の新コース（直線240m）2や大井の外回りコースは、直線が長く差しが決まりやすい。補正項: ゴール前の「上がり3F（prev_kohan_3f）」の寄与率を、直線の長いコースほど高く設定する重み付けを行う。3.3.3 高知競馬場の「内ラチ」問題高知競馬場では、内側の砂が深く、各馬が内ラチを避けて走る傾向がある5。これにより、距離ロスが生じても外を回る方が有利となる。補正項: 枠番（wakuban）によるバイアス補正を導入。1枠〜2枠の馬が、平均的なパフォーマンスよりも著しく低い指数を出した場合、それは能力不足ではなく「トラックバイアスによる減衰」とみなし、次走予測時に減点を緩和する（または参考外とする）ロジックを組む。4. ばんえい競馬専用「Ban'ei Power Index (BPI)」の設計ばんえい競馬（帯広）は、サラブレッドによる平地競走とは物理法則が根本的に異なるため、共通のスピード指数を適用することは無意味である。「速さ」ではなく「仕事率（Power）」を数値化するBPIを設計する。4.1 競技特性の物理学的モデルばんえい競馬は、重量物（ソリ）を曳いて2つの障害（坂）を越える競技である6。第1障害: 小さな丘。ここは勢いで越える。第2障害: 勝負の分かれ目。高さ1.6mの坂。ここで止まらずに越えられるか、あるいは何回「刻む（息を入れる）」かが重要7。馬場水分: 水分量が多い（軽馬場）とソリの摩擦係数が下がりタイムが速くなる。水分が少ない（重馬場）と摩擦が大きく、パワーが必要となる19。4.2 BPI計算アルゴリズム$$\text{BPI} = \left( \frac{\text{Base Power}}{\text{Time}_{actual}} \right) \times \mu(\text{Moisture}) \times \omega(\text{Weight Ratio}) + \text{Obstacle Bonus}$$Base Power / Time: 基本的な仕事率。タイムの逆数に比例するが、ここでは距離が一定（200m）であるため、タイムそのものを評価軸とする。$\mu(\text{Moisture})$ - 摩擦係数補正:馬場水分量（prev_babajotai_code等から推定）との逆相関モデル。水分が低い（乾燥している）時に好タイムを出した馬を高く評価する。平地競走とは逆に、「時計がかかる馬場での好走」こそが高評価となる。$\omega(\text{Weight Ratio})$ - 重量比補正:$$\text{Weight Ratio} = \frac{\text{Sled Weight}}{\text{Horse Weight}}$$自身の体重に対してどれだけの重量を曳いたか。小柄な馬が高重量を曳き切った場合、指数をブーストする。Obstacle Bonus - 障害登坂評価:第2障害を「一腰（ひとこし）」で越えたか、あるいは膝をついたか。レース映像解析ができない場合、後半のタイム（障害後の脚色）から逆推定する。障害通過後の減速が少ない馬にボーナスを与える。5. 機械学習と統計的手法による実装詳細5.1 スパースデータ（疎行列）への対応戦略地方競馬データ分析の最大の敵は「スパース性（Sparsity）」である。金沢競馬の馬と佐賀競馬の馬は直接対戦することが稀であり、指数の相互比較（スケーリング）が困難である。5.1.1 グラフ理論によるコネクティビティ解析全競走馬をノード、対戦経験をエッジとしたグラフを作成し、連結成分（Connected Components）を確認する。交流重賞（ダートグレード競走）: 異なる地区の馬が対戦する貴重な機会。これを「アンカー（錨）」として、各地区の指数レベルを補正する。例：大井のA級馬が金沢の重賞で圧勝した場合、金沢の指数全体を相対的に下方修正する係数を算出する。5.1.2 疎行列処理の実装（Python）Pythonのscipy.sparseライブラリを活用し、メモリ効率の良い計算を行う9。Pythonfrom scipy.sparse import csr_matrix
from sklearn.preprocessing import OneHotEncoder

# 特徴量のスパース行列化（例：騎手、調教師、馬ID）
# 数千〜数万のカテゴリカル変数があるため、密行列（Dense）ではメモリが溢れる
enc = OneHotEncoder(handle_unknown='ignore')
sparse_features = enc.fit_transform(df[['kishu_mei', 'chokyoshi_mei', 'umaban']])
5.2 アルゴリズムの選定：なぜ勾配ブースティングか調査要望にある「ランダムフォレスト、XGBoost、ニューラルネットワーク」の比較において、本プロジェクトにはLightGBMまたはXGBoost（勾配ブースティング決定木）を強く推奨する。アルゴリズム推奨度理由Linear Regression低馬場状態や体重の影響は非線形であり、精度が出ない。Random Forest中安定しているが、スパースデータの学習速度が遅く、外挿（未知の強さの馬）に弱い。XGBoost / LightGBM高欠損値（null）をそのまま扱える。非線形な相互作用（例：重馬場×内枠の時のみ有利）を自動学習する。計算が高速。Neural Network中データ量が膨大な場合は最強だが、チューニングが難しく、過学習のリスクが高い。Phase 3での導入を検討。5.3 特徴量エンジニアリング（Feature Engineering）機械学習モデルに入力する「説明変数」の設計が精度の8割を決める。ラグ特徴量 (Lag Features):過去$N$走のスピード指数、着順、タイム差。単なる平均ではなく、加重平均（直近を重視）を用いる。変化率 (Delta Features):前走からの距離増減（kyori - prev_kyori）、斤量増減、馬体重増減。交互作用特徴量 (Interaction Features):jockey_win_rate × track_id: 「その騎手がその競馬場でどれだけ勝っているか」。sire_mud_performance × track_condition: 「血統的な重馬場適性」と「今日の馬場状態」の掛け合わせ。6. 実装ロードマップと検証プロトコル6.1 Phase 1: コアエンジンの構築（Essential / 1ヶ月目）目標: 運用可能な「ベースライン指数」の算出。タスク:DB（PostgreSQL）からのデータ抽出パイプライン構築。外れ値処理（Z-scoreフィルタ）を実装した「基準タイム（Median）」算出バッチの開発。日次馬場差（DTV）計算ロジックの実装。単純計算式による指数算出とDBへの格納。出力: speed_index_v1（補正なし、純粋なタイム指数）。6.2 Phase 2: 高度補正機能の実装（Recommended / 2ヶ月目）目標: コース特性、ペース、ばんえい対応の実装。タスク:ペース指数（Brisnet E1/E2/LP模倣）の実装。prev_kohan_3fを利用した逆算ロジック。各競馬場の特性（スパイラル、砂厚、直線長）を係数化した「トラック定数テーブル」の作成。ばんえい競馬専用BPIの実装。クラス間補正（Class Par）の導入。昇級戦の馬に対する指数の調整。6.3 Phase 3: AIモデルによる予測最適化（Advanced / 3ヶ月目〜）目標: 指数を入力変数とした機械学習モデルによる勝率予測。タスク:LightGBMを用いた予測モデルの学習。目的変数は「指数」ではなく「着順」または「複勝圏内確率」。ハイパーパラメータチューニング（Optuna等を使用）。日次自動再学習（Online Learning）パイプラインの構築。6.4 検証方法（Validation Strategy）モデルの性能評価には、時系列を考慮したWalk-Forward Validationを採用する。手順:2024年のデータで学習 → 2025年1月を予測・検証。2024年〜2025年1月のデータで学習 → 2025年2月を予測・検証。これを1ヶ月単位でスライドさせながら繰り返す。KPI:RMSE (Root Mean Squared Error): 予測タイムと実タイムの誤差。Rank Correlation (Spearman's $\rho$): 指数順位と実際の着順の相関。目標 $r > 0.4$。ROI (Return on Investment): 指数上位馬をベッティングした場合の回収率シミュレーション。7. 最終提案：推奨計算式とPython実装スニペット7.1 推奨する最終計算式（NAR-SI Ver.2.0）$$\text{NAR-SI} = \text{Base SI} + \text{Correction Factors}$$Base SI（基礎指数）:$$\text{Base SI} = \left( \frac{T_{std} - T_{actual} + \text{DTV} + \text{Wgt\_Adj}}{C_{dist}} \right) \times 100 + 80$$Correction Factors（補正係数）:$$\text{CF} = \alpha(\text{Pace}) + \beta(\text{Position}) + \gamma(\text{TrackBias}) + \delta(\text{Class})$$$T_{std}$: クラス・距離別基準タイム（中央値）$T_{actual}$: 実走破タイム$\text{DTV}$: 日次馬場差$\text{Wgt\_Adj}$: $( \text{斤量} - 55 ) \times C_{weight}$ （距離に応じた斤量係数）$C_{dist}$: 距離係数（距離が伸びるほど1秒の価値を下げる係数）$\alpha, \beta, \gamma, \delta$: 機械学習により最適化された重み係数7.2 実装手順ガイド（Step-by-Step）Step 1: 基準タイムテーブルの作成まず、過去データから基準となるタイムを計算し、静的なマスタデータとして保存する。Pythonimport pandas as pd
import numpy as np

def calculate_par_times(df_history):
    # 1. 外れ値除去 (Z-score > 2.0 除外)
    def filter_outliers(x):
        mean = x.mean()
        std = x.std()
        return x[(x >= mean - 2*std) & (x <= mean + 2*std)]

    # 2. 良馬場データのみ使用
    df_good = df_history[df_history['babajotai_code'] == '1']

    # 3. 競馬場・距離・クラスごとの中央値算出
    par_table = df_good.groupby(['keibajo_code', 'kyori', 'grade_code'])['soha_time'] \
       .apply(lambda x: filter_outliers(x).median()) \
       .reset_index() \
       .rename(columns={'soha_time': 'par_time'})
    
    return par_table
Step 2: 日次バリアント（DTV）の計算開催日当日、レースが終わるたびに（あるいは翌日まとめて）、その日の馬場傾向を計算する。Pythondef calculate_daily_variant(df_today, par_table):
    # 今日の結果と基準タイムをマージ
    merged = pd.merge(df_today, par_table, on=['keibajo_code', 'kyori', 'grade_code'])
    
    # 各馬のタイム差（Diff）を計算
    merged['time_diff'] = merged['par_time'] - merged['soha_time']
    
    # 各レースの上位3頭のみを抽出して平均をとる（下位馬の遅れは無視）
    # レースIDごとに集計
    race_variants = merged[merged['chakujun'] <= 3].groupby('race_id')['time_diff'].mean()
    
    # その日の全レースの平均をDTVとする
    daily_variant = race_variants.mean()
    
    return daily_variant
Step 3: 指数の算出と格納最終的に、各馬のレコードに対して指数を適用する。Pythondef compute_speed_index(row, par_time, dtv, dist_coef=0.1):
    # タイム差（秒）
    # プラスなら基準より速い
    raw_diff = par_time - row['soha_time'] + dtv
    
    # 斤量補正（基準55kg、1kg=0.2秒とする簡易版）
    weight_penalty = (row['futan_juryo'] - 550) / 10 * 0.2  # futan_juryoは0.1kg単位想定なら調整必要
    
    # 総合タイム差
    total_diff = raw_diff + weight_penalty
    
    # 指数化（基準80点、1ポイント=dist_coef秒）
    si = (total_diff / dist_coef) + 80
    
    return si
8. 結論地方競馬における「世界最高レベル」のスピード指数の構築は、単なる既存モデルの模倣では達成し得ない。JRAや欧米とは異なる「不連続な砂の質」「極端なコース形状」「ばんえい競馬」といったローカルな物理特性を、数理モデルの中に明示的に組み込むことが不可欠である。本報告書で提案した NAR-SI は、Beyerの動的バリアント、Timeformの厳密な斤量換算、そして最新の機械学習技術（LightGBM）を融合させたハイブリッドモデルである。特に、大井の砂厚変更への対応や、ばんえい専用BPIの導入は、他社の予測システムに対する圧倒的な優位性（Competitive Edge）を確立するだろう。まずはPhase 1の「堅牢な基準タイムと日次バリアント」の実装から着手し、データの蓄積と共にPhase 3のAIモデルへと進化させるロードマップを推奨する。これにより、目標とする「相関係数 $r > 0.4$」「回収率 85%超」の達成は、十分に現実的な射程圏内にあると結論付ける。表1: 各種スピード指数手法の比較とNARへの適用推奨度手法名概要長所短所（NAR適用時）推奨度Beyer Speed Figures基準タイムからの偏差＋日次バリアント馬場状態の変化に極めて強い。下級条件の基準タイム設定が困難。高Timeform Ratingsタイム＋斤量＋着差＋レースレベル斤量や着差の評価が厳密。計算が複雑で、主観的判断が入る余地がある。中Brisnet Pace (E1/E2)区間タイムによるペース評価展開（前残り/差し）を予測できる。正確なラップタイムデータが不足している。中（工夫必要）Quirin Speed Points位置取り（通過順）の点数化小回りコースでの有利不利判定に有効。単体では能力比較ができない。高（補正用）NAR-SI (提案手法)上記の統合＋機械学習＋ローカル補正地方特有の課題（砂、形状）を解決。実装コストが高い。継続的なチューニングが必要。最高表2: 競馬場別特性と技術的対応策マトリクス競馬場主な特性技術的対応策 (Implementation Strategy)大井 (TCK)砂厚変更 (10cm→9cm)、内外回り砂厚変更日を境に基準タイムを分離。コース区分（内/外）を厳格化。園田・姫路スパイラルカーブ、小回りコーナー通過順位の変化（マクリ）に対するボーナスポイント付与。高知内ラチ沿いの深い砂、ナイター枠番別バイアス補正（内枠減点緩和）。発走時刻による気温補正。名古屋新コース（直線長い）旧コースデータの破棄。LP（後半指数）のウェイト増加。ばんえい障害、重量引き全く別の計算式（BPI）適用。水分量×重量比の非線形モデル。門別広いコース、坂路調教充実JRAに近いロジック適用可能。坂路調教タイムを特徴量に追加（可能なら）。